<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The War Vault ‚Äî Battlemap</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Great+Vibes&display=swap" rel="stylesheet">
  <style>
    :root{
      --gold:#e6c57f;--accent:#b88c5c;--ink:#eee;--bg:#0b0b0f;--panel:#14131a;--mist:rgba(0,0,0,.7)
    }
    *{box-sizing:border-box}
    body{margin:0;height:100vh;display:flex;flex-direction:column;background:#000;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;overflow:hidden}

    /* Header (Codex style) */
    header{display:flex;align-items:center;justify-content:space-between;padding:.6rem 1rem;border-bottom:1px solid var(--accent);background:rgba(10,10,14,.9);backdrop-filter:blur(6px);position:relative;z-index:20}
    .brand{display:flex;flex-direction:column}
    .brand .title{font-family:'Cinzel',serif;font-weight:900;letter-spacing:.06em;color:var(--gold);text-shadow:0 0 12px rgba(230,197,127,.35);font-size:1.4rem}
    .brand .byline{font-family:'Great Vibes',cursive;font-size:1.4rem;line-height:1;color:var(--gold)}

    .bar-actions{display:flex;gap:.5rem;align-items:center}
    .btn{background:rgba(35,35,45,.85);border:1px solid var(--accent);color:var(--ink);padding:.35rem .6rem;border-radius:8px;cursor:pointer}
    .btn:hover{background:var(--accent);color:#000;box-shadow:0 0 14px rgba(230,197,127,.35)}

    /* Main layout */
    #stage{flex:1;display:grid;grid-template-columns:300px 1fr 280px;min-height:0}
    #left-panel{background:var(--panel);border-right:1px solid var(--accent);overflow:auto}
    #right-panel{background:var(--panel);border-left:1px solid var(--accent);overflow:auto}
    #map-container{position:relative;overflow:hidden;background:#111}

    .section{padding:12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .section h3{margin:.1rem 0 .6rem;font-family:'Cinzel',serif;color:var(--gold);font-size:1rem}

    /* Map stack */
    #map{position:absolute;inset:0;object-fit:contain;width:100%;height:100%;transform-origin:top left;cursor:grab;z-index:1}
    canvas{position:absolute;left:0;top:0;pointer-events:none}
    #grid-layer{z-index:2}
    #fog-layer{z-index:4}
    .token{position:absolute;width:42px;height:42px;border-radius:50%;background:#f44;color:#000;font-weight:800;display:flex;align-items:center;justify-content:center;user-select:none;cursor:grab;z-index:5;border:2px solid #fff;transform-origin:center}

    /* Context menu */
    #ctx{position:absolute;z-index:50;background:#1b1a22;border:1px solid var(--accent);border-radius:8px;overflow:hidden;display:none;min-width:160px}
    #ctx button{display:block;width:100%;text-align:left;padding:.5rem .7rem;background:transparent;color:var(--ink);border:none;cursor:pointer}
    #ctx button:hover{background:rgba(255,255,255,.08)}

    /* Submap overlay (parchment modal) */
    #submap-overlay{position:absolute;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;z-index:30}
    .parchment{position:absolute;inset:5% 8%;background:#f4ecd7 url('https://i.imgur.com/2mJvRjF.png') center/cover no-repeat;box-shadow:0 20px 60px rgba(0,0,0,.6);border:2px solid #c9b27a;border-radius:14px;overflow:hidden}
    .parchment .head{display:flex;justify-content:space-between;align-items:center;padding:.4rem .6rem;background:linear-gradient(#f6eed9,#eadfbf);border-bottom:1px solid #c9b27a}
    .parchment .head .ttl{font-family:'Cinzel',serif;color:#5a4829}
    .parchment .head .x{background:#7a1; color:#fff; border:none; padding:.3rem .55rem;border-radius:999px;cursor:pointer}
    .parchment .body{position:absolute;inset:42px 8px 8px 8px;background:#d7ccb0}
    #submap-canvas{position:absolute;inset:0}

    /* Submap manager */
    .submap-card{padding:.5rem;border:1px solid rgba(255,255,255,.08);border-radius:8px;margin:.4rem 0}
    .thumb{width:100%;height:110px;background:#222;border:1px solid rgba(255,255,255,.12);background-size:cover;background-position:center;border-radius:6px}
    .row{display:flex;gap:.4rem;align-items:center;margin:.35rem 0}
    input,select{background:#1c1b24;border:1px solid var(--accent);color:var(--ink);padding:.35rem;border-radius:6px;width:100%}
    label{font-size:.8rem;color:#cbb27d}

    @media (max-width:1100px){#stage{grid-template-columns:0 1fr 280px}#left-panel{display:none}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="title">The War Vault</div>
      <div class="byline">Chris Marshall</div>
    </div>
    <div class="bar-actions">
      <button id="btn-zoom-in" class="btn">Ôºã</button>
      <button id="btn-zoom-out" class="btn">Ôºç</button>
      <input id="map-upload" type="file" accept="image/*" class="btn" title="Upload map" />
    </div>
  </header>

  <div id="stage">
    <!-- Left: Character Sheet -->
    <aside id="left-panel">
      <div class="section">
        <h3>Character Sheet</h3>
        <div id="char-sheet">Click a token to view.</div>
        <div class="row"><button id="btn-load-characters" class="btn" style="width:100%">üì• Load from Echo Vault</button></div>
      </div>
    </aside>

    <!-- Center: Map -->
    <main id="map-container">
      <img id="map" src="https://i.imgur.com/8V7V3sP.jpg" alt="Map" />
      <canvas id="grid-layer"></canvas>
      <canvas id="fog-layer"></canvas>

      <!-- Token context menu -->
      <div id="ctx">
        <button data-act="sheet">View Character Sheet</button>
        <button data-act="assign-submap">Assign Submap‚Ä¶</button>
        <button data-act="open-submap">Open Submap</button>
        <button data-act="delete">Delete Token</button>
      </div>

      <!-- Submap Overlay (parchment) -->
      <div id="submap-overlay">
        <div class="parchment">
          <div class="head"><div class="ttl" id="submap-title">Submap</div><button class="x" id="close-submap">‚úï</button></div>
          <div class="body">
            <canvas id="submap-canvas"></canvas>
          </div>
        </div>
      </div>
    </main>

    <!-- Right: Tools / Submap Manager / Initiative -->
    <aside id="right-panel">
      <div class="section">
        <h3>Tools</h3>
        <div class="row"><button id="btn-toggle-fog" class="btn" style="width:100%">üå´Ô∏è Toggle Fog</button></div>
      </div>

      <div class="section" id="submap-manager">
        <h3>Submap Manager</h3>
        <div class="row"><input type="file" id="submap-file" accept="image/*"></div>
        <div class="row"><input type="text" id="submap-name" placeholder="Name (e.g., Kael's House)"></div>
        <div class="row"><button id="btn-add-submap" class="btn" style="width:100%">‚ûï Add Submap</button></div>
        <div id="submap-list"></div>
      </div>

      <div class="section">
        <h3>Initiative</h3>
        <div class="row">
          <input id="init-name" placeholder="Name">
          <input id="init-roll" type="number" placeholder="Roll" style="max-width:90px">
        </div>
        <div class="row"><button id="btn-init-add" class="btn" style="width:100%">Add</button></div>
        <div class="row" style="gap:.5rem"><button id="btn-init-next" class="btn" style="flex:1">Next</button><button id="btn-init-reset" class="btn" style="flex:1">Reset</button></div>
        <div id="init-list" style="margin-top:.5rem"></div>
      </div>
    </aside>
  </div>

  <script>
  // ===== Elements
  const mapEl = document.getElementById('map');
  const wrap = document.getElementById('map-container');
  const grid = document.getElementById('grid-layer');
  const fog = document.getElementById('fog-layer');
  const gctx = grid.getContext('2d');
  const fctx = fog.getContext('2d');
  const charSheet = document.getElementById('char-sheet');
  const ctxMenu = document.getElementById('ctx');

  const zoomInBtn = document.getElementById('btn-zoom-in');
  const zoomOutBtn = document.getElementById('btn-zoom-out');
  const toggleFogBtn = document.getElementById('btn-toggle-fog');
  const mapUpload = document.getElementById('map-upload');

  // Submap overlay
  const subOverlay = document.getElementById('submap-overlay');
  const subTitle = document.getElementById('submap-title');
  const subCanvas = document.getElementById('submap-canvas');
  const sctx = subCanvas.getContext('2d');
  document.getElementById('close-submap').addEventListener('click', ()=> subOverlay.style.display='none');

  // Submap manager
  const subFile = document.getElementById('submap-file');
  const subName = document.getElementById('submap-name');
  const subAddBtn = document.getElementById('btn-add-submap');
  const subList = document.getElementById('submap-list');

  // Initiative
  const initName = document.getElementById('init-name');
  const initRoll = document.getElementById('init-roll');
  const initAdd = document.getElementById('btn-init-add');
  const initNext = document.getElementById('btn-init-next');
  const initReset = document.getElementById('btn-init-reset');
  const initList = document.getElementById('init-list');

  // Load characters from Echo Vault
  document.getElementById('btn-load-characters').addEventListener('click', ()=>{
    const vault = JSON.parse(localStorage.getItem('echo-vault')||'[]');
    if(!vault.length){ alert('No characters in Echo Vault'); return; }
    const pick = vault[vault.length-1]; // latest
    spawnToken(pick);
  });

  // ===== State
  let scale = 1; // zoom
  let tokens = []; // {el,x,y,scale,name,submapId?,char?}
  let isPanning=false, panStart={x:0,y:0}, offset={x:0,y:0};
  let selectedToken=null;
  let submaps = JSON.parse(localStorage.getItem('warvault-submaps')||'[]'); // {id,name,dataURL}

  // Initiative
  let initiative=[]; let initIdx=-1;

  function fitCanvases(){
    const r = wrap.getBoundingClientRect();
    [grid,fog].forEach(cv=>{cv.width=r.width; cv.height=r.height});
    drawGrid(); drawFog();
  }
  window.addEventListener('resize', fitCanvases);
  window.addEventListener('load', fitCanvases);

  function drawGrid(){
    const cell = 50*scale; // 5ft
    gctx.clearRect(0,0,grid.width,grid.height);
    gctx.strokeStyle='rgba(230,197,127,.28)';
    gctx.lineWidth=1;
    for(let x=(offset.x%cell+cell)%cell; x<grid.width; x+=cell){ gctx.beginPath(); gctx.moveTo(x,0); gctx.lineTo(x,grid.height); gctx.stroke(); }
    for(let y=(offset.y%cell+cell)%cell; y<grid.height; y+=cell){ gctx.beginPath(); gctx.moveTo(0,y); gctx.lineTo(grid.width,y); gctx.stroke(); }
  }
  function drawFog(){ fctx.clearRect(0,0,fog.width,fog.height); fctx.fillStyle='rgba(0,0,0,.55)'; fctx.fillRect(0,0,fog.width,fog.height); }

  // Map upload
  mapUpload.addEventListener('change', e=>{
    const file=e.target.files[0]; if(!file) return; const r=new FileReader();
    r.onload=ev=>{ mapEl.src=ev.target.result; }; r.readAsDataURL(file);
  });

  // Zoom & Pan
  function setScale(newScale, anchorX, anchorY){
    const old = scale; scale = Math.max(.2, Math.min(6, newScale));
    // keep anchor under cursor by adjusting offset
    const ax = anchorX??(grid.width/2), ay = anchorY??(grid.height/2);
    const dx = (ax - offset.x)/old; const dy = (ay - offset.y)/old;
    offset.x = ax - dx*scale; offset.y = ay - dy*scale;
    mapEl.style.transform = `translate(${offset.x}px, ${offset.y}px) scale(${scale})`;
    tokens.forEach(t=>{ t.el.style.transform=`translate(${offset.x + t.x*scale}px, ${offset.y + t.y*scale}px) scale(${scale})`; });
    drawGrid();
  }
  zoomInBtn.addEventListener('click',()=> setScale(scale*1.2));
  zoomOutBtn.addEventListener('click',()=> setScale(scale/1.2));
  wrap.addEventListener('wheel', e=>{ e.preventDefault(); setScale(scale*(e.deltaY<0?1.15:.87), e.offsetX, e.offsetY); }, {passive:false});

  wrap.addEventListener('mousedown', e=>{ if(e.target!==mapEl) return; isPanning=true; panStart={x:e.clientX-offset.x,y:e.clientY-offset.y}; });
  window.addEventListener('mousemove', e=>{ if(!isPanning) return; offset.x=e.clientX-panStart.x; offset.y=e.clientY-panStart.y; mapEl.style.transform=`translate(${offset.x}px, ${offset.y}px) scale(${scale})`; tokens.forEach(t=>{ t.el.style.transform=`translate(${offset.x + t.x*scale}px, ${offset.y + t.y*scale}px) scale(${scale})`; }); drawGrid(); });
  window.addEventListener('mouseup', ()=>{ isPanning=false; });

  // ===== Tokens
  function spawnToken(character){
    const el=document.createElement('div'); el.className='token'; el.textContent=(character.name||'?').slice(0,1);
    wrap.appendChild(el);
    const t={el, x:120, y:120, name:character.name||'Token', char:character, submapId:null};
    tokens.push(t);
    positionToken(t);

    // click -> sheet or open submap if ctrl/cmd-click
    el.addEventListener('click', (e)=>{ if(t.submapId && (e.metaKey||e.ctrlKey)) { openSubmapById(t.submapId); } else { openSheet(t); } });

    // right-click context
    el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); selectedToken=t; openCtx(e.clientX, e.clientY); });

    // drag
    let dragging=false, dOff={x:0,y:0};
    el.addEventListener('mousedown', e=>{ if(e.button!==0) return; dragging=true; dOff.x = (offset.x + t.x*scale) - e.clientX; dOff.y = (offset.y + t.y*scale) - e.clientY; document.body.style.userSelect='none'; });
    window.addEventListener('mousemove', e=>{ if(!dragging) return; const sx=e.clientX + dOff.x; const sy=e.clientY + dOff.y; t.x = (sx - offset.x)/scale; t.y = (sy - offset.y)/scale; positionToken(t); });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
  }
  function positionToken(t){ t.el.style.transform = `translate(${offset.x + t.x*scale}px, ${offset.y + t.y*scale}px) scale(${scale})`; }

  function openSheet(t){
    const c = t.char || {};
    charSheet.innerHTML = `
      <div><strong>${c.name||t.name}</strong></div>
      <div style="opacity:.8">${(c.class||'') + ' ' + (c.race||'')}</div>
      <div class="row"><label>Initiative</label><input id="init-input" type="number" value="${c.initiative||0}"></div>
      <div class="row"><button class="btn" id="init-add-btn">Add to Initiative</button></div>
    `;
    document.getElementById('init-add-btn').onclick = ()=>{
      const val=parseInt(document.getElementById('init-input').value||'0',10);
      addInitiative((c.name||t.name), val);
    };
  }

  // Context menu actions
  function openCtx(x,y){ ctxMenu.style.display='block'; ctxMenu.style.left=x+'px'; ctxMenu.style.top=y+'px'; }
  window.addEventListener('click', (e)=>{ if(e.target.closest('#ctx')==null) ctxMenu.style.display='none'; });
  ctxMenu.addEventListener('click', (e)=>{
    const act = e.target.dataset.act; if(!act||!selectedToken) return;
    if(act==='sheet') openSheet(selectedToken);
    if(act==='assign-submap') assignSubmapToToken(selectedToken);
    if(act==='open-submap'){ if(selectedToken.submapId) openSubmapById(selectedToken.submapId); else alert('No submap assigned.'); }
    if(act==='delete'){ selectedToken.el.remove(); tokens = tokens.filter(t=>t!==selectedToken); }
    ctxMenu.style.display='none';
  });

  // ===== Submaps
  function renderSubmapList(){
    subList.innerHTML = '';
    submaps.forEach(sm=>{
      const card=document.createElement('div'); card.className='submap-card';
      const th=document.createElement('div'); th.className='thumb'; th.style.backgroundImage=`url(${sm.dataURL})`;
      const row=document.createElement('div'); row.className='row';
      const selBtn=document.createElement('button'); selBtn.className='btn'; selBtn.textContent='Open'; selBtn.onclick=()=>openSubmapById(sm.id);
      card.append(th, document.createElement('div'));
      card.appendChild(Object.assign(document.createElement('div'),{textContent:sm.name, style:'margin:6px 0;color:#d8c797'}));
      card.appendChild(selBtn);
      subList.appendChild(card);
    });
  }
  renderSubmapList();

  subAddBtn.addEventListener('click', ()=>{
    const file=subFile.files?.[0]; const name=subName.value.trim()||'Submap';
    if(!file){ alert('Choose an image'); return; }
    const r=new FileReader(); r.onload=e=>{
      const item={id:Date.now().toString(36), name, dataURL:e.target.result};
      submaps.push(item); localStorage.setItem('warvault-submaps', JSON.stringify(submaps));
      subFile.value=''; subName.value=''; renderSubmapList();
    }; r.readAsDataURL(file);
  });

  function assignSubmapToToken(t){
    if(!submaps.length){ alert('No submaps. Add one in Submap Manager.'); return; }
    const choice = prompt('Type submap name to assign:\n' + submaps.map(s=>'- '+s.name).join('\n'));
    if(!choice) return; const found=submaps.find(s=>s.name.toLowerCase()===choice.toLowerCase());
    if(found){ t.submapId=found.id; alert('Assigned "'+found.name+'"'); } else { alert('Not found.'); }
  }

  function openSubmapById(id){
    const sm=submaps.find(s=>s.id===id); if(!sm) return alert('Submap missing');
    subTitle.textContent = sm.name;
    // draw into canvas to fit
    const img=new Image();
    img.onload=()=>{
      const box=subCanvas.getBoundingClientRect();
      subCanvas.width = box.width; subCanvas.height = box.height;
      // fit contain
      const sw=img.width, sh=img.height; const ar=Math.min(box.width/sw, box.height/sh);
      const dw=sw*ar, dh=sh*ar; const dx=(box.width-dw)/2, dy=(box.height-dh)/2;
      sctx.clearRect(0,0,subCanvas.width,subCanvas.height); sctx.fillStyle='#d7ccb0'; sctx.fillRect(0,0,subCanvas.width,subCanvas.height);
      sctx.drawImage(img, dx, dy, dw, dh);
      subOverlay.style.display='block';
    };
    img.src=sm.dataURL;
  }

  // ===== Initiative helpers
  function addInitiative(name, roll){ initiative.push({name, roll}); initiative.sort((a,b)=>b.roll-a.roll); if(initIdx<0 && initiative.length) initIdx=0; renderInitiative(); }
  function renderInitiative(){ initList.innerHTML=''; initiative.forEach((it,i)=>{ const d=document.createElement('div'); d.textContent=`${i===initIdx?'‚ñ∂ ':''}${it.name} ‚Äî ${it.roll}`; initList.appendChild(d); }); }
  initAdd.addEventListener('click', ()=>{ const n=initName.value.trim(); const r=parseInt(initRoll.value||''); if(!n||isNaN(r)) return; addInitiative(n,r); initName.value=''; initRoll.value=''; });
  initNext.addEventListener('click', ()=>{ if(!initiative.length) return; initIdx=(initIdx+1)%initiative.length; renderInitiative(); });
  initReset.addEventListener('click', ()=>{ initiative=[]; initIdx=-1; renderInitiative(); });

  // ===== Initial grid/fog and one demo token
  drawGrid(); drawFog();

  // Demo spawn button via header double-click (hidden shortcut)
  document.querySelector('header .title').addEventListener('dblclick', ()=> spawnToken({name:'Hero'}));

  </script>
</body>
</html>
