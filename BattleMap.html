<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The War Vault ‚Äî Battlemap</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Great+Vibes&display=swap" rel="stylesheet">
  <style>
    :root{
      --gold:#e6c57f;--accent:#b88c5c;--ink:#eee;--panel:#14131a;--mist:rgba(0,0,0,.55);--rune:rgba(230,197,127,.28);
    }
    *{box-sizing:border-box}
    body{margin:0;height:100vh;display:flex;flex-direction:column;background:#000;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;overflow:hidden}

    /* Header */
    header{display:flex;align-items:center;justify-content:space-between;padding:.6rem 1rem;border-bottom:1px solid var(--accent);background:rgba(10,10,14,.9);backdrop-filter:blur(6px);position:relative;z-index:20}
    .brand{display:flex;flex-direction:column}
    .brand .title{font-family:'Cinzel',serif;font-weight:900;letter-spacing:.06em;color:var(--gold);text-shadow:0 0 12px rgba(230,197,127,.35);font-size:1.4rem}
    .brand .byline{font-family:'Great Vibes',cursive;font-size:1.5rem;line-height:1;color:var(--gold)}
    .actions{display:flex;gap:.5rem;align-items:center}
    .btn{background:rgba(35,35,45,.85);border:1px solid var(--accent);color:var(--ink);padding:.35rem .6rem;border-radius:8px;cursor:pointer}
    .btn:hover{background:var(--accent);color:#000;box-shadow:0 0 14px rgba(230,197,127,.35)}
    .btn.toggled{background:var(--accent);color:#000}
    input,select{background:#1c1b24;border:1px solid var(--accent);color:var(--ink);padding:.35rem;border-radius:6px}

    /* Layout */
    #stage{flex:1;display:grid;grid-template-columns:320px 1fr 360px;min-height:0}
    #left-panel{background:var(--panel);border-right:1px solid var(--accent);overflow:auto}
    #right-panel{background:var(--panel);border-left:1px solid var(--accent);overflow:auto}
    #map-container{position:relative;overflow:hidden;background:#111}

    .section{padding:12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .section h3{margin:.1rem 0 .6rem;font-family:'Cinzel',serif;color:var(--gold);font-size:1rem}
    .row{display:flex;gap:.5rem;align-items:center;margin:.4rem 0}

    /* Map stack */
    #map{position:absolute;inset:0;object-fit:contain;width:100%;height:100%;transform-origin:top left;cursor:grab;z-index:1}
    canvas{position:absolute;left:0;top:0;pointer-events:none}
    #grid-layer{z-index:2}
    #template-layer{z-index:3}
    #fog-layer{z-index:5}

    .token{position:absolute;border-radius:50%;background:#f44;color:#000;font-weight:800;display:flex;align-items:center;justify-content:center;user-select:none;cursor:grab;z-index:6;border:2px solid #fff;transform-origin:center;overflow:hidden}
    .token span{pointer-events:none}
    .token.has-img{background-size:cover;background-position:center;color:#fff;text-shadow:0 1px 2px #000}

    .portal{position:absolute;width:26px;height:26px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #8df,#15a);border:2px solid #fff;box-shadow:0 0 10px #8df;z-index:7;cursor:pointer;transform-origin:center}

    /* Context menu */
    #ctx{position:absolute;z-index:50;background:#1b1a22;border:1px solid var(--accent);border-radius:8px;overflow:hidden;display:none;min-width:180px}
    #ctx button{display:block;width:100%;text-align:left;padding:.5rem .7rem;background:transparent;color:var(--ink);border:none;cursor:pointer}
    #ctx button:hover{background:rgba(255,255,255,.08)}

    /* Submap overlay */
    #submap-overlay{position:absolute;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;z-index:30}
    .parchment{position:absolute;inset:6% 10%;background:#f4ecd7 url('https://i.imgur.com/2mJvRjF.png') center/cover no-repeat;box-shadow:0 20px 60px rgba(0,0,0,.6);border:2px solid #c9b27a;border-radius:14px;overflow:hidden}
    .parchment .head{display:flex;justify-content:space-between;align-items:center;padding:.4rem .6rem;background:linear-gradient(#f6eed9,#eadfbf);border-bottom:1px solid #c9b27a}
    .parchment .head .ttl{font-family:'Cinzel',serif;color:#5a4829}
    .parchment .head .x{background:#7a1; color:#fff; border:none; padding:.3rem .55rem;border-radius:999px;cursor:pointer}
    .parchment .body{position:absolute;inset:42px 8px 8px 8px;background:#d7ccb0}
    #submap-canvas{position:absolute;inset:0}

    /* Token Forge (mid-screen in right panel) */
    #token-forge .desc{font-size:.9rem;opacity:.85;line-height:1.35;margin:.4rem 0 .6rem}
    #forge-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
    #saved-maps{max-height:160px;overflow:auto;border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:.35rem}
    .map-item{display:flex;align-items:center;gap:.5rem;margin:.3rem 0}
    .thumb{width:42px;height:42px;background:#222;border:1px solid rgba(255,255,255,.12);background-size:cover;background-position:center;border-radius:6px}

    @media (max-width:1180px){#stage{grid-template-columns:0 1fr 360px}#left-panel{display:none}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="title">The War Vault</div>
      <div class="byline">Chris Marshall</div>
    </div>
    <div class="actions">
      <button id="btn-zoom-in" class="btn" title="Zoom in">Ôºã</button>
      <button id="btn-zoom-out" class="btn" title="Zoom out">Ôºç</button>
      <input id="map-upload" type="file" accept="image/*" class="btn" title="Upload map" />
      <button id="btn-save-map" class="btn" title="Save map">üíæ Save Map</button>
    </div>
  </header>

  <div id="stage">
    <!-- Left: Character Sheet -->
    <aside id="left-panel">
      <div class="section">
        <h3>Character Sheet</h3>
        <div id="char-sheet">Click a token to view.</div>
        <div class="row"><button id="btn-load-characters" class="btn" style="width:100%">üì• Load from Echo Vault</button></div>
      </div>
    </aside>

    <!-- Center: Map -->
    <main id="map-container">
      <img id="map" src="https://i.imgur.com/8V7V3sP.jpg" alt="Map" />
      <canvas id="grid-layer"></canvas>
      <canvas id="template-layer"></canvas>
      <canvas id="fog-layer"></canvas>

      <!-- Token context menu -->
      <div id="ctx">
        <button data-act="sheet">View Character Sheet</button>
        <button data-act="assign-submap">Assign Submap‚Ä¶</button>
        <button data-act="open-submap">Open Submap</button>
        <button data-act="delete">Delete Token</button>
      </div>

      <!-- Submap Overlay (parchment) -->
      <div id="submap-overlay">
        <div class="parchment">
          <div class="head"><div class="ttl" id="submap-title">Submap</div><button class="x" id="close-submap">‚úï</button></div>
          <div class="body">
            <canvas id="submap-canvas"></canvas>
          </div>
        </div>
      </div>
    </main>

    <!-- Right: Tools / Token Forge / Submap Manager / Initiative -->
    <aside id="right-panel">
      <div class="section">
        <h3>Tools</h3>
        <div class="row" style="flex-wrap:wrap">
          <button class="btn tool" data-tool="pan">üñêÔ∏è Pan</button>
          <button class="btn tool" data-tool="ruler">üìè Ruler</button>
          <button class="btn tool" data-tool="los">üéØ LOS</button>
          <button class="btn tool" data-tool="circle">‚≠ï Circle</button>
          <button class="btn tool" data-tool="rect">‚ñ≠ Rect</button>
          <button class="btn tool" data-tool="cone">üî∫ Cone</button>
          <button class="btn tool" data-tool="portal">üåÄ Portal</button>
        </div>
        <div class="row">
          <button id="btn-clear-templates" class="btn" style="flex:1">Clear Templates</button>
          <label style="display:flex;align-items:center;gap:.35rem"><input type="checkbox" id="snap" /> Snap-to-grid</label>
        </div>
        <div class="row">
          <select id="fog-mode">
            <option value="none">Fog: off</option>
            <option value="reveal">Fog: reveal</option>
            <option value="hide">Fog: hide</option>
          </select>
          <select id="brush">
            <option value="20">Brush 20</option>
            <option value="40" selected>Brush 40</option>
            <option value="80">Brush 80</option>
          </select>
        </div>
      </div>

      <div class="section" id="token-forge">
        <h3>Token Forge</h3>
        <div class="desc">Create customizable tokens: set <em>Name</em>, <em>Color</em>, <em>Size</em>, and an optional <em>Photo</em>. Click ‚ÄúCreate Token‚Äù to place it at the center of the map. Drag to move; right‚Äëclick for options. Tokens scale with zoom.</div>
        <div id="forge-grid">
          <div>
            <div class="row"><input id="tf-name" placeholder="Name (e.g., Kael)" /></div>
            <div class="row"><label>Color</label><input id="tf-color" type="color" value="#ff4444" /></div>
            <div class="row"><label>Size (px)</label><input id="tf-size" type="number" min="24" max="120" value="42" /></div>
            <div class="row"><input id="tf-photo" type="file" accept="image/*" /></div>
            <div class="row"><button id="btn-create-token" class="btn" style="width:100%">‚ûï Create Token</button></div>
          </div>
          <div>
            <div style="margin-bottom:.3rem;color:#cbb27d">Saved Maps</div>
            <div id="saved-maps"></div>
          </div>
        </div>
      </div>

      <div class="section" id="submap-manager">
        <h3>Submap Manager</h3>
        <div class="row"><input type="file" id="submap-file" accept="image/*"></div>
        <div class="row"><input type="text" id="submap-name" placeholder="Name (e.g., Kael's House)"></div>
        <div class="row"><button id="btn-add-submap" class="btn" style="width:100%">‚ûï Add Submap</button></div>
        <div id="submap-list"></div>
      </div>

      <div class="section">
        <h3>Initiative</h3>
        <div class="row">
          <input id="init-name" placeholder="Name">
          <input id="init-roll" type="number" placeholder="Roll" style="max-width:90px">
        </div>
        <div class="row"><button id="btn-init-add" class="btn" style="width:100%">Add</button></div>
        <div class="row" style="gap:.5rem"><button id="btn-init-next" class="btn" style="flex:1">Next</button><button id="btn-init-reset" class="btn" style="flex:1">Reset</button></div>
        <div id="init-list" style="margin-top:.5rem"></div>
      </div>
    </aside>
  </div>

  <script>
  // ===== Elements & Contexts
  const wrap = document.getElementById('map-container');
  const mapEl = document.getElementById('map');
  const grid = document.getElementById('grid-layer');
  const tpl = document.getElementById('template-layer');
  const fog = document.getElementById('fog-layer');
  const gctx = grid.getContext('2d');
  const tctx = tpl.getContext('2d');
  const fctx = fog.getContext('2d');

  const ctxMenu = document.getElementById('ctx');
  const charSheet = document.getElementById('char-sheet');

  // Header controls
  const zoomInBtn = document.getElementById('btn-zoom-in');
  const zoomOutBtn = document.getElementById('btn-zoom-out');
  const mapUpload = document.getElementById('map-upload');
  const saveMapBtn = document.getElementById('btn-save-map');

  // Tools
  const toolButtons = Array.from(document.querySelectorAll('.tool'));
  const snapChk = document.getElementById('snap');
  const fogModeSel = document.getElementById('fog-mode');
  const brushSel = document.getElementById('brush');
  const clearTplBtn = document.getElementById('btn-clear-templates');

  // Token forge
  const tfName = document.getElementById('tf-name');
  const tfColor = document.getElementById('tf-color');
  const tfSize = document.getElementById('tf-size');
  const tfPhoto = document.getElementById('tf-photo');
  const createTokenBtn = document.getElementById('btn-create-token');
  const savedMapsDiv = document.getElementById('saved-maps');

  // Submap overlay & manager
  const subOverlay = document.getElementById('submap-overlay');
  const subTitle = document.getElementById('submap-title');
  const subCanvas = document.getElementById('submap-canvas');
  const sctx = subCanvas.getContext('2d');
  document.getElementById('close-submap').addEventListener('click', ()=> subOverlay.style.display='none');
  const subFile = document.getElementById('submap-file');
  const subName = document.getElementById('submap-name');
  const subAddBtn = document.getElementById('btn-add-submap');
  const subList = document.getElementById('submap-list');

  // Initiative
  const initName = document.getElementById('init-name');
  const initRoll = document.getElementById('init-roll');
  const initAdd = document.getElementById('btn-init-add');
  const initNext = document.getElementById('btn-init-next');
  const initReset = document.getElementById('btn-init-reset');
  const initList = document.getElementById('init-list');

  // Characters
  document.getElementById('btn-load-characters').addEventListener('click', ()=>{
    const vault = JSON.parse(localStorage.getItem('echo-vault')||'[]');
    if(!vault.length){ alert('No characters in Echo Vault'); return; }
    const pick = vault[vault.length-1];
    spawnToken({ name: pick.name, char: pick, color: '#ff4444', size: 48 });
  });

  // ===== Map/World state
  let scale = 1;            // zoom
  let offset = {x:0,y:0};   // pan (screen px)
  const cell = 50;          // 5ft == 50px at scale 1

  let tokens = [];          // {el,x,y,size,color,img?,name,char?,submapId?}
  let portals = [];         // {el,x,y,submapId}
  let submaps = JSON.parse(localStorage.getItem('warvault-submaps')||'[]');
  let savedMaps = JSON.parse(localStorage.getItem('warvault-maps')||'[]');

  let currentTool = 'pan';
  let drawing = null;       // {type,start:{x,y},cur:{x,y}}
  let isPanning = false; let panStart={x:0,y:0};
  let selectedToken = null;
  let activeFog = false;

  // Initiative
  let initiative=[]; let initIdx=-1;

  function fitCanvases(){
    const r = wrap.getBoundingClientRect();
    [grid,tpl,fog].forEach(cv=>{cv.width=r.width; cv.height=r.height});
    drawGrid(); clearTemplates(); drawFogFull();
    repositionAll();
  }
  window.addEventListener('resize', fitCanvases);
  window.addEventListener('load', fitCanvases);

  // ===== Coordinate helpers
  function screenToWorld(sx,sy){ return { x:(sx - offset.x)/scale, y:(sy - offset.y)/scale }; }
  function worldToScreen(wx,wy){ return { x:offset.x + wx*scale, y:offset.y + wy*scale }; }
  function snap(v){ return snapChk.checked ? Math.round(v/cell)*cell : v; }

  // ===== Grid/Fog/Template rendering
  function drawGrid(){
    const step = cell*scale;
    gctx.clearRect(0,0,grid.width,grid.height);
    gctx.strokeStyle= getComputedStyle(document.documentElement).getPropertyValue('--rune');
    gctx.lineWidth=1;
    for(let x=(offset.x%step+step)%step; x<grid.width; x+=step){ gctx.beginPath(); gctx.moveTo(x,0); gctx.lineTo(x,grid.height); gctx.stroke(); }
    for(let y=(offset.y%step+step)%step; y<grid.height; y+=step){ gctx.beginPath(); gctx.moveTo(0,y); gctx.lineTo(grid.width,y); gctx.stroke(); }
  }
  function clearTemplates(){ tctx.clearRect(0,0,tpl.width,tpl.height); }
  function drawFogFull(){ fctx.clearRect(0,0,fog.width,fog.height); fctx.fillStyle= getComputedStyle(document.documentElement).getPropertyValue('--mist'); fctx.fillRect(0,0,fog.width,fog.height); }

  function drawTemplate(){
    clearTemplates(); if(!drawing) return;
    const s = worldToScreen(drawing.start.x, drawing.start.y);
    const c = worldToScreen(drawing.cur.x, drawing.cur.y);
    tctx.lineWidth = 2; tctx.strokeStyle = 'rgba(0,200,255,0.9)'; tctx.fillStyle='rgba(0,200,255,0.25)';
    if(drawing.type==='ruler' || drawing.type==='los'){
      tctx.beginPath(); tctx.moveTo(s.x,s.y); tctx.lineTo(c.x,c.y); tctx.stroke();
      // distance label (feet)
      const dx=drawing.cur.x - drawing.start.x, dy=drawing.cur.y - drawing.start.y;
      const feet = Math.round(Math.hypot(dx,dy)/cell*5);
      tctx.fillStyle='rgba(0,0,0,.7)'; tctx.fillRect((s.x+c.x)/2-18,(s.y+c.y)/2-10,36,18);
      tctx.fillStyle='#fff'; tctx.font='12px system-ui'; tctx.textAlign='center'; tctx.fillText(feet+ ' ft', (s.x+c.x)/2, (s.y+c.y)/2+4);
    }
    if(drawing.type==='circle'){
      const r = Math.hypot(c.x-s.x, c.y-s.y);
      tctx.beginPath(); tctx.arc(s.x,s.y,r,0,Math.PI*2); tctx.fill(); tctx.stroke();
    }
    if(drawing.type==='rect'){
      tctx.beginPath(); tctx.rect(s.x,s.y,c.x-s.x,c.y-s.y); tctx.fill(); tctx.stroke();
    }
    if(drawing.type==='cone'){
      const ang = Math.atan2(c.y-s.y, c.x-s.x); const len = Math.hypot(c.x-s.x, c.y-s.y); const spread=Math.PI/3;
      tctx.beginPath(); tctx.moveTo(s.x,s.y);
      tctx.lineTo(s.x + Math.cos(ang-spread/2)*len, s.y + Math.sin(ang-spread/2)*len);
      tctx.arc(s.x,s.y,len, ang-spread/2, ang+spread/2);
      tctx.closePath(); tctx.fill(); tctx.stroke();
    }
  }

  // ===== Map upload
  mapUpload.addEventListener('change', e=>{
    const file=e.target.files[0]; if(!file) return; const r=new FileReader();
    r.onload=ev=>{ mapEl.src=ev.target.result; }; r.readAsDataURL(file);
  });

  // ===== Zoom/Pan
  function repositionAll(){
    mapEl.style.transform = `translate(${offset.x}px, ${offset.y}px) scale(${scale})`;
    tokens.forEach(t=>{ t.el.style.width=t.size+'px'; t.el.style.height=t.size+'px'; const p=worldToScreen(t.x,t.y); t.el.style.transform=`translate(${p.x}px, ${p.y}px) scale(${scale})`; });
    portals.forEach(p=>{ const s=worldToScreen(p.x,p.y); p.el.style.transform=`translate(${s.x-13}px, ${s.y-13}px) scale(${scale})`; });
    drawGrid();
  }
  function setScale(newScale, anchorX, anchorY){
    const old = scale; scale = Math.max(.2, Math.min(6, newScale));
    const ax = anchorX??(grid.width/2), ay = anchorY??(grid.height/2);
    const wx = (ax - offset.x)/old, wy=(ay - offset.y)/old;
    offset.x = ax - wx*scale; offset.y = ay - wy*scale;
    repositionAll();
  }
  document.getElementById('btn-zoom-in').addEventListener('click',()=> setScale(scale*1.2));
  document.getElementById('btn-zoom-out').addEventListener('click',()=> setScale(scale/1.2));
  wrap.addEventListener('wheel', e=>{ e.preventDefault(); setScale(scale*(e.deltaY<0?1.15:.87), e.offsetX, e.offsetY); }, {passive:false});

  wrap.addEventListener('mousedown', e=>{
    const fogMode=fogModeSel.value; const tool=currentTool;
    const onMap = e.target===wrap || e.target===mapEl || e.target===grid || e.target===tpl || e.target===fog;
    if(!onMap) return;
    const w = screenToWorld(e.offsetX, e.offsetY);

    if(fogMode!=='none'){
      activeFog=true; paintFog(e.offsetX, e.offsetY, fogMode==='reveal'); return;
    }

    if(tool==='pan'){ isPanning=true; panStart={x:e.clientX-offset.x, y:e.clientY-offset.y}; return; }

    if(['ruler','los','circle','rect','cone'].includes(tool)){
      drawing = { type: tool==='ruler'?'ruler':tool, start:{x:snap(w.x), y:snap(w.y)}, cur:{x:snap(w.x), y:snap(w.y)} };
      drawTemplate(); return;
    }

    if(tool==='portal'){
      const portal = document.createElement('div'); portal.className='portal'; wrap.appendChild(portal);
      const p = { el: portal, x: snap(w.x), y: snap(w.y), submapId: null };
      portals.push(p); const s=worldToScreen(p.x,p.y); portal.style.transform=`translate(${s.x-13}px, ${s.y-13}px) scale(${scale})`;
      portal.addEventListener('click', ()=>{ if(p.submapId) openSubmapById(p.submapId); else assignSubmapToPortal(p); });
      portal.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); assignSubmapToPortal(p); });
      return;
    }
  });
  window.addEventListener('mousemove', e=>{
    if(isPanning){ offset.x=e.clientX-panStart.x; offset.y=e.clientY-panStart.y; repositionAll(); return; }
    if(activeFog){ paintFog(e.offsetX, e.offsetY, fogModeSel.value==='reveal'); return; }
    if(drawing){ const w=screenToWorld(e.offsetX,e.offsetY); drawing.cur={x:snap(w.x), y:snap(w.y)}; drawTemplate(); }
  });
  window.addEventListener('mouseup', ()=>{ isPanning=false; activeFog=false; });

  function paintFog(sx,sy,reveal){
    fog.style.pointerEvents='auto';
    fctx.globalCompositeOperation = reveal ? 'destination-out':'source-over';
    if(!reveal){ fctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--mist'); }
    const r = parseInt(brushSel.value,10);
    fctx.beginPath(); fctx.arc(sx,sy,r,0,Math.PI*2); fctx.fill();
    fctx.globalCompositeOperation = 'source-over';
  }
  clearTplBtn.addEventListener('click', clearTemplates);

  // ===== Tools toggle
  function setTool(t){ currentTool=t; toolButtons.forEach(b=> b.classList.toggle('toggled', b.dataset.tool===t)); fog.style.pointerEvents = (fogModeSel.value!=='none')?'auto':'none'; }
  toolButtons.forEach(b=> b.addEventListener('click', ()=> setTool(b.dataset.tool)));
  setTool('pan');

  // ===== Tokens
  function spawnToken({name='Token', color='#ff4444', size=42, img=null, char=null}){
    const el=document.createElement('div'); el.className='token';
    el.style.width=size+'px'; el.style.height=size+'px'; el.style.backgroundColor=color;
    const label=document.createElement('span'); label.textContent=name.slice(0,3).toUpperCase(); el.appendChild(label);
    if(img){ el.classList.add('has-img'); el.style.backgroundImage=`url(${img})`; }
    wrap.appendChild(el);

    const centerW = screenToWorld(grid.width/2, grid.height/2);
    const t={el, x:snap(centerW.x), y:snap(centerW.y), size, color, img, name, char, submapId:null};
    tokens.push(t); positionToken(t);

    // click & context
    el.addEventListener('click', (e)=>{ if(t.submapId && (e.metaKey||e.ctrlKey)) openSubmapById(t.submapId); else openSheet(t); });
    el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); selectedToken=t; openCtx(e.clientX,e.clientY); });

    // drag
    let dragging=false, dOff={x:0,y:0};
    el.addEventListener('mousedown', e=>{ if(e.button!==0) return; dragging=true; const s=worldToScreen(t.x,t.y); dOff.x = s.x - e.clientX; dOff.y = s.y - e.clientY; document.body.style.userSelect='none'; });
    window.addEventListener('mousemove', e=>{ if(!dragging) return; const wx = (e.clientX + dOff.x - offset.x)/scale; const wy=(e.clientY + dOff.y - offset.y)/scale; t.x=snap(wx); t.y=snap(wy); positionToken(t); });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
  }
  function positionToken(t){ const s=worldToScreen(t.x,t.y); t.el.style.transform=`translate(${s.x}px, ${s.y}px) scale(${scale})`; }

  function openSheet(t){
    const c = t.char||{};
    charSheet.innerHTML = `
      <div style="font-weight:700">${c.name||t.name}</div>
      <div style="opacity:.8">${(c.class||'') + ' ' + (c.race||'')}</div>
      <div class="row"><label>Initiative</label><input id="init-input" type="number" value="${c.initiative||0}"></div>
      <div class="row"><button class="btn" id="init-add-btn">Add to Initiative</button></div>
    `;
    document.getElementById('init-add-btn').onclick = ()=>{ const val=parseInt(document.getElementById('init-input').value||'0',10); addInitiative((c.name||t.name), val); };
  }

  // Context menu for tokens
  function openCtx(x,y){ ctxMenu.style.display='block'; ctxMenu.style.left=x+'px'; ctxMenu.style.top=y+'px'; }
  window.addEventListener('click', (e)=>{ if(e.target.closest('#ctx')==null) ctxMenu.style.display='none'; });
  ctxMenu.addEventListener('click', (e)=>{
    const act=e.target.dataset.act; if(!act||!selectedToken) return;
    if(act==='sheet') openSheet(selectedToken);
    if(act==='assign-submap') assignSubmapToToken(selectedToken);
    if(act==='open-submap'){ if(selectedToken.submapId) openSubmapById(selectedToken.submapId); else alert('No submap assigned'); }
    if(act==='delete'){ selectedToken.el.remove(); tokens = tokens.filter(t=>t!==selectedToken); }
    ctxMenu.style.display='none';
  });

  // ===== Submaps
  function renderSubmapList(){
    subList.innerHTML='';
    submaps.forEach(sm=>{
      const card=document.createElement('div'); card.className='map-item';
      const th=document.createElement('div'); th.className='thumb'; th.style.backgroundImage=`url(${sm.image||sm.dataURL})`;
      const name=document.createElement('div'); name.textContent=sm.name; name.style.flex='1'; name.style.color='#d8c797';
      const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Open'; btn.onclick=()=>openSubmapById(sm.id);
      card.append(th,name,btn); subList.appendChild(card);
    });
  }
  renderSubmapList();

  function assignSubmapToToken(t){ if(!submaps.length) return alert('Add submaps in Submap Manager.'); const name=prompt('Type submap name to assign:\n'+submaps.map(s=>'- '+s.name).join('\n')); const f=submaps.find(s=>s.name.toLowerCase()===String(name||'').toLowerCase()); if(f){ t.submapId=f.id; alert('Assigned '+f.name); } }
  function assignSubmapToPortal(p){ if(!submaps.length) return alert('Add submaps in Submap Manager.'); const name=prompt('Type submap name to assign:\n'+submaps.map(s=>'- '+s.name).join('\n')); const f=submaps.find(s=>s.name.toLowerCase()===String(name||'').toLowerCase()); if(f){ p.submapId=f.id; alert('Assigned '+f.name); } }

  function openSubmapById(id){ const sm=submaps.find(s=>s.id===id); if(!sm) return alert('Submap missing'); subTitle.textContent=sm.name; const img=new Image(); img.onload=()=>{ const box=subCanvas.getBoundingClientRect(); subCanvas.width=box.width; subCanvas.height=box.height; const ar=Math.min(box.width/img.width, box.height/img.height); const dw=img.width*ar, dh=img.height*ar; const dx=(box.width-dw)/2, dy=(box.height-dh)/2; sctx.clearRect(0,0,subCanvas.width,subCanvas.height); sctx.fillStyle='#d7ccb0'; sctx.fillRect(0,0,subCanvas.width,subCanvas.height); sctx.drawImage(img,dx,dy,dw,dh); subOverlay.style.display='block'; }; img.src=sm.dataURL||sm.image; }

  subAddBtn.addEventListener('click', ()=>{
    const file=subFile.files?.[0]; const name=subName.value.trim()||'Submap'; if(!file){ alert('Choose an image'); return; }
    const r=new FileReader(); r.onload=e=>{ const item={id:Date.now().toString(36), name, dataURL:e.target.result}; submaps.push(item); localStorage.setItem('warvault-submaps', JSON.stringify(submaps)); subFile.value=''; subName.value=''; renderSubmapList(); }; r.readAsDataURL(file);
  });

  // ===== Token Forge
  createTokenBtn.addEventListener('click', ()=>{
    const name=tfName.value.trim()||'Token'; const color=tfColor.value; const size=Math.max(24,Math.min(120, parseInt(tfSize.value||'42',10)));
    const file=tfPhoto.files?.[0]; if(file){ const r=new FileReader(); r.onload=e=> spawnToken({name,color,size,img:e.target.result}); r.readAsDataURL(file); } else { spawnToken({name,color,size}); }
  });

  // ===== Save/Load Maps (list shown next to photo)
  function renderSavedMaps(){
    savedMapsDiv.innerHTML='';
    savedMaps.forEach((m,idx)=>{
      const row=document.createElement('div'); row.className='map-item';
      const th=document.createElement('div'); th.className='thumb'; th.style.backgroundImage=`url(${m.thumbnail||m.image})`;
      const nm=document.createElement('div'); nm.textContent=m.name; nm.style.flex='1';
      const load=document.createElement('button'); load.className='btn'; load.textContent='Load'; load.onclick=()=>loadMap(idx);
      const del=document.createElement('button'); del.className='btn'; del.textContent='‚úï'; del.onclick=()=>{ savedMaps.splice(idx,1); localStorage.setItem('warvault-maps', JSON.stringify(savedMaps)); renderSavedMaps(); };
      row.append(th,nm,load,del); savedMapsDiv.appendChild(row);
    });
  }
  renderSavedMaps();

  function saveCurrentMap(){
    // Build thumbnail from map element (best-effort, not including fog/templates)
    const cv=document.createElement('canvas'); const r=wrap.getBoundingClientRect(); cv.width=220; cv.height=140; const cx=cv.getContext('2d');
    // Try draw: just the base map image scaled to thumbnail
    try{ const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ const ar=Math.min(cv.width/img.width, cv.height/img.height); const dw=img.width*ar, dh=img.height*ar; const dx=(cv.width-dw)/2, dy=(cv.height-dh)/2; cx.fillStyle='#111'; cx.fillRect(0,0,cv.width,cv.height); cx.drawImage(img,dx,dy,dw,dh); finalize(); }; img.src=mapEl.src; } catch{ finalize(); }
    function finalize(){
      const name = prompt('Name this map:', 'My Battle') || 'Untitled';
      const data = {
        name,
        image: mapEl.src,
        tokens: tokens.map(t=>({x:t.x,y:t.y,size:t.size,color:t.color,img:t.img,name:t.name,submapId:t.submapId,char:t.char})),
        portals: portals.map(p=>({x:p.x,y:p.y,submapId:p.submapId})),
        submaps,
        offset, scale
      };
      const thumbnail = cv.toDataURL('image/png');
      savedMaps.unshift({...data, thumbnail}); if(savedMaps.length>20) savedMaps.pop();
      localStorage.setItem('warvault-maps', JSON.stringify(savedMaps)); renderSavedMaps();
      alert('Map saved.');
    }
  }
  saveMapBtn.addEventListener('click', saveCurrentMap);

  function loadMap(idx){
    const m=savedMaps[idx]; if(!m) return;
    mapEl.src=m.image; offset=m.offset||{x:0,y:0}; scale=m.scale||1;
    // clear tokens & portals
    tokens.forEach(t=>t.el.remove()); tokens=[]; portals.forEach(p=>p.el.remove()); portals=[];
    (m.tokens||[]).forEach(tt=> spawnToken(tt));
    (m.portals||[]).forEach(pp=>{ const portal=document.createElement('div'); portal.className='portal'; wrap.appendChild(portal); const p={el:portal,x:pp.x,y:pp.y,submapId:pp.submapId}; portals.push(p); const s=worldToScreen(p.x,p.y); portal.style.transform=`translate(${s.x-13}px, ${s.y-13}px) scale(${scale})`; portal.addEventListener('click', ()=>{ if(p.submapId) openSubmapById(p.submapId); else assignSubmapToPortal(p); }); portal.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); assignSubmapToPortal(p); }); });
    submaps = m.submaps || submaps; localStorage.setItem('warvault-submaps', JSON.stringify(submaps)); renderSubmapList();
    repositionAll();
  }

  // ===== Initiative
  function addInitiative(name, roll){ initiative.push({name, roll}); initiative.sort((a,b)=>b.roll-a.roll); if(initIdx<0 && initiative.length) initIdx=0; renderInitiative(); }
  function renderInitiative(){ initList.innerHTML=''; initiative.forEach((it,i)=>{ const d=document.createElement('div'); d.textContent=`${i===initIdx?'‚ñ∂ ':''}${it.name} ‚Äî ${it.roll}`; initList.appendChild(d); }); }
  initAdd.addEventListener('click', ()=>{ const n=initName.value.trim(); const r=parseInt(initRoll.value||''); if(!n||isNaN(r)) return; addInitiative(n,r); initName.value=''; initRoll.value=''; });
  initNext.addEventListener('click', ()=>{ if(!initiative.length) return; initIdx=(initIdx+1)%initiative.length; renderInitiative(); });
  initReset.addEventListener('click', ()=>{ initiative=[]; initIdx=-1; renderInitiative(); });

  // Start
  setTool('pan');

  </script>
</body>
</html>
