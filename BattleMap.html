<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The War Vault ‚Äî Omniverse Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Great+Vibes&display=swap" rel="stylesheet">
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root{
      --gold:#e6c57f;--accent:#b88c5c;--ink:#eee;--panel:#14131a;--mist:rgba(0,0,0,.55);--rune:rgba(230,197,127,.28);
      --paper:#f4ecd7;--paperEdge:#c9b27a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;height:100vh;display:flex;flex-direction:column;background:#000;color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;overflow:hidden
    }
    /* avoid image drag/select glitches */             /* FIX */
    img{-webkit-user-drag:none;user-select:none}

    /* Atmospheric "reaccl" background */
    body::before{
      content:"";
      position:fixed; inset:-10%;
      background:
        radial-gradient(60% 60% at 20% 10%, rgba(230,197,127,.12), transparent 60%),
        radial-gradient(50% 50% at 80% 0%, rgba(142,114,79,.10), transparent 55%),
        radial-gradient(45% 45% at 50% 100%, rgba(184,140,92,.10), transparent 55%),
        linear-gradient(180deg, #0b0a10, #0b0a10 40%, #0a0a12 100%);
      filter: saturate(110%) blur(0.3px);
      z-index:-1;
    }

    header{
      display:flex;align-items:center;justify-content:space-between;padding:.6rem 1rem;
      border-bottom:1px solid var(--accent);background:rgba(10,10,14,.9);backdrop-filter:blur(6px);
      position:relative;z-index:20;
      box-shadow: 0 2px 20px rgba(230,197,127,.06);
    }
    .brand{display:flex;flex-direction:column}
    .brand .title{
      font-family:'Cinzel',serif;font-weight:900;letter-spacing:.06em;color:var(--gold);
      text-shadow:0 0 12px rgba(230,197,127,.35);font-size:1.4rem
    }
    .brand .byline{font-family:'Great Vibes',cursive;font-size:1.5rem;line-height:1;color:var(--gold)}
    .actions{display:flex;gap:.5rem;align-items:center}
    .btn{
      background:rgba(35,35,45,.85);border:1px solid var(--accent);color:var(--ink);
      padding:.35rem .6rem;border-radius:8px;cursor:pointer
    }
    .btn:hover{background:var(--accent);color:#000;box-shadow:0 0 14px rgba(230,197,127,.35)}
    .btn.toggled{background:var(--accent);color:#000}
    input,select{
      background:#1c1b24;border:1px solid var(--accent);color:var(--ink);
      padding:.35rem;border-radius:6px;width:100%
    }

    #stage{flex:1;display:grid;grid-template-columns:320px 1fr 360px;min-height:0}
    #left-panel{
      background:var(--panel);border-right:1px solid var(--accent);overflow:auto;display:flex;flex-direction:column;
      box-shadow: inset 0 0 0 1px rgba(184,140,92,.22), inset 0 0 24px rgba(230,197,127,.06);
    }
    #right-panel{
      background:var(--panel);border-left:1px solid var(--accent);overflow:auto;
      box-shadow: inset 0 0 0 1px rgba(184,140,92,.22), inset 0 0 24px rgba(230,197,127,.06);
    }
    #map-container{position:relative;overflow:hidden;background:#111}

    .section{padding:12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .section h3{
      margin:.1rem 0 .6rem;font-family:'Cinzel',serif;color:var(--gold);font-size:1rem
    }
    .row{display:flex;gap:.5rem;align-items:center;margin:.4rem 0}
    .row.stacked{flex-direction:column;align-items:stretch}

    #map{
      position:absolute;inset:0;object-fit:contain;width:100%;height:100%;
      transform-origin:top left;cursor:grab;z-index:1
    }
    canvas{position:absolute;left:0;top:0;pointer-events:none}
    #grid-layer{z-index:2}
    #template-layer{z-index:3}
    #fog-layer{z-index:5}

    .token{
      position:absolute;border-radius:50%;background:#f44;color:#000;font-weight:800;
      display:flex;align-items:center;justify-content:center;user-select:none;cursor:grab;
      z-index:6;border:2px solid #fff;transform-origin:center;overflow:hidden
    }
    .token span{pointer-events:none}
    .token.has-img{background-size:cover;background-position:center;color:#fff;text-shadow:0 1px 2px #000}
    .portal{
      position:absolute;width:26px;height:26px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #8df,#15a);
      border:2px solid #fff;box-shadow:0 0 10px #8df;z-index:7;cursor:pointer;transform-origin:center
    }

    #ctx{
      position:absolute;z-index:50;background:#1b1a22;border:1px solid var(--accent);
      border-radius:8px;overflow:hidden;display:none;min-width:180px
    }
    #ctx button{display:block;width:100%;text-align:left;padding:.5rem .7rem;background:transparent;color:var(--ink);border:none;cursor:pointer}
    #ctx button:hover{background:rgba(255,255,255,.08)}

    #submap-overlay{
      position:absolute;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;z-index:30
    }
    .parchment{
      position:absolute;inset:6% 10%;background:var(--paper) url('https://i.imgur.com/2mJvRjF.png') center/cover no-repeat;
      box-shadow:0 20px 60px rgba(0,0,0,.6);border:2px solid var(--paperEdge);border-radius:14px;overflow:hidden
    }
    .parchment .head{
      display:flex;justify-content:space-between;align-items:center;padding:.4rem .6rem;
      background:linear-gradient(#f6eed9,#eadfbf);border-bottom:1px solid var(--paperEdge)
    }
    .parchment .head .ttl{font-family:'Cinzel',serif;color:#5a4829}
    .parchment .head .x{background:#7a1;color:#fff;border:none;padding:.3rem .55rem;border-radius:999px;cursor:pointer}
    .parchment .body{position:absolute;inset:42px 8px 8px 8px;background:#d7ccb0}

    #submap-canvas{position:absolute;inset:0}

    #token-forge{flex:1;overflow:auto}
    #forge-grid{display:grid;grid-template-columns:1fr;gap:.6rem}
    #saved-maps{
      max-height:160px;overflow:auto;border:1px solid rgba(255,255,255,.12);
      border-radius:8px;padding:.35rem
    }
    .map-item{display:flex;align-items:center;gap:.5rem;margin:.3rem 0}
    .thumb{width:42px;height:42px;background:#222;border:1px solid rgba(255,255,255,.12);background-size:cover;background-position:center;border-radius:6px}
    #initiative{margin-top:auto}

    .handle{position:absolute;width:10px;height:10px;border:2px solid #00c8ff;background:#00131a;border-radius:2px;z-index:9;pointer-events:auto}

    .ov-box{border:1px solid var(--paperEdge);border-radius:10px;background:rgba(235,220,185,.07);padding:.6rem}
    .ov-row{display:grid;grid-template-columns:100px 1fr;gap:.5rem;align-items:center;margin:.35rem 0}
    #ov-console{
      min-height:70px;max-height:160px;overflow:auto;background:#0e0d12;border:1px dashed var(--accent);
      padding:.5rem;border-radius:8px;font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace;font-size:.85rem
    }

    /* 3D Preview */
    #three-preview{
      position:absolute;inset:10px 20px 20px;max-width:400px;max-height:300px;
      background:#000;box-shadow:0 0 30px rgba(0,0,0,.6);border:2px solid var(--accent);border-radius:12px;
      z-index:40;pointer-events:none;display:none;
    }
    #three-preview[active]{pointer-events:auto;display:block}

    /* Omniverse Help Popover */
    #ov-help{
      position:absolute;top:100%;left:50%;transform:translateX(-50%);
      width:420px;background:#14131a;border:1px solid var(--accent);border-radius:12px;
      color:var(--ink);font-size:.9rem;line-height:1.4;box-shadow:0 20px 50px rgba(0,0,0,.6);
      z-index:50;padding:1rem;display:none;
    }
    #ov-help::before{
      content:"";position:absolute;top:-10px;left:50%;transform:translateX(-50%);
      border:5px solid transparent;border-bottom:5px solid var(--accent);
    }
    #ov-help h4{color:var(--gold);margin:.2rem 0; font-size:1rem}
    #ov-help ul{margin:.5rem 0; padding-left:1.2rem }

    @media (max-width:1180px){
      #stage{grid-template-columns:0 1fr 360px}
      #left-panel{display:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="title">The War Vault</div>
      <div class="byline">Chris Marshall</div>
    </div>
    <div class="actions">
      <button id="btn-zoom-in" class="btn" type="button" title="Zoom in">Ôºã</button>
      <button id="btn-zoom-out" class="btn" type="button" title="Zoom out">Ôºç</button>
      <input id="map-upload" type="file" accept="image/*" class="btn" title="Upload map" />
      <button id="btn-save-map" class="btn" type="button" title="Save map">üíæ Save Map</button>
    </div>
  </header>

  <div id="stage">
    <aside id="left-panel">
      <div class="section" id="token-forge">
        <h3>Token Forge</h3>
        <div id="forge-grid">
          <div>
            <div class="row"><input id="tf-name" placeholder="Name" /></div>
            <div class="row"><label>Color</label><input id="tf-color" type="color" value="#ff4444" /></div>
            <div class="row"><label>Size (px)</label><input id="tf-size" type="number" min="24" max="120" value="42" /></div>
            <div class="row"><input id="tf-photo" type="file" accept="image/*" /></div>
            <div class="row"><button id="btn-create-token" class="btn" type="button" style="width:100%">‚ûï Create Token</button></div>
          </div>
          <div>
            <div style="margin-bottom:.3rem;color:#cbb27d">Saved Maps</div>
            <div id="saved-maps"></div>
          </div>
        </div>
      </div>

      <div class="section" id="initiative">
        <h3>Initiative</h3>
        <div class="row">
          <input id="init-name" placeholder="Name">
          <input id="init-roll" type="number" placeholder="Roll" style="max-width:90px">
        </div>
        <div class="row">
          <button id="btn-init-add" class="btn" type="button" style="width:100%">Add</button>
        </div>
        <div class="row" style="gap:.5rem">
          <button id="btn-init-next" class="btn" type="button" style="flex:1">Next</button>
          <button id="btn-init-reset" class="btn" type="button" style="flex:1">Reset</button>
        </div>
        <div id="init-list" style="margin-top:.5rem"></div>
      </div>
    </aside>

    <main id="map-container">
      <!-- crossorigin allows future canvas use if needed (thumbnails, etc.) -->  <!-- FIX -->
      <img id="map" crossorigin="anonymous" src="https://i.imgur.com/8V7V3sP.jpg" alt="Map" />
      <canvas id="grid-layer"></canvas>
      <canvas id="template-layer"></canvas>
      <canvas id="fog-layer"></canvas>

      <div id="ctx">
        <button data-act="sheet" type="button">View Character Sheet</button>
        <button data-act="assign-submap" type="button">Assign Submap‚Ä¶</button>
        <button data-act="open-submap" type="button">Open Submap</button>
        <button data-act="delete" type="button">Delete Token</button>
      </div>

      <div id="submap-overlay">
        <div class="parchment">
          <div class="head">
            <div class="ttl" id="submap-title">Submap</div>
            <button class="x" id="close-submap" type="button">‚úï</button>
          </div>
          <div class="body">
            <canvas id="submap-canvas"></canvas>
          </div>
        </div>
      </div>

      <!-- 3D Preview -->
      <div id="three-preview" active>
        <model-viewer
          id="3d-model"
          src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
          alt="3D Preview"
          camera-controls
          auto-rotate
          shadow-intensity="1"
          style="width:100%;height:100%"
        ></model-viewer>
      </div>
    </main>

    <aside id="right-panel">
      <div class="section">
        <h3>Tools</h3>
        <div class="row" style="flex-wrap:wrap">
          <button class="btn tool" type="button" data-tool="pan">üñêÔ∏è Pan</button>
          <button class="btn tool" type="button" data-tool="select">üñ±Ô∏è Select</button>
          <button class="btn tool" type="button" data-tool="ruler">üìè Ruler</button>
          <button class="btn tool" type="button" data-tool="los">üéØ LOS</button>
          <button class="btn tool" type="button" data-tool="circle">‚≠ï Circle</button>
          <button class="btn tool" type="button" data-tool="rect">‚ñ≠ Rect</button>
          <button class="btn tool" type="button" data-tool="cone">üî∫ Cone</button>
          <button class="btn tool" type="button" data-tool="portal">üåÄ Portal</button>
        </div>
        <div class="row">
          <button id="btn-clear-templates" class="btn" type="button" style="flex:1">Clear Templates</button>
          <label style="display:flex;align-items:center;gap:.35rem"><input type="checkbox" id="snap" /> Snap-to-grid</label>
        </div>
        <div class="row">
          <select id="fog-mode">
            <option value="none">Fog: off</option>
            <option value="reveal">Fog: reveal</option>
            <option value="hide">Fog: hide</option>
          </select>
          <select id="brush">
            <option value="20">Brush 20</option>
            <option value="40" selected>Brush 40</option>
            <option value="80">Brush 80</option>
          </select>
        </div>
        <div class="row" style="gap:.5rem">
          <button id="btn-fog-undo" class="btn" type="button" style="flex:1">‚ü≤ Fog Undo</button>
          <button id="btn-fog-redo" class="btn" type="button" style="flex:1">‚ü≥ Fog Redo</button>
        </div>
      </div>

      <div class="section" id="submap-manager">
        <h3>Submap Manager</h3>
        <div class="row"><input type="file" id="submap-file" accept="image/*"></div>
        <div class="row"><input type="text" id="submap-name" placeholder="Name"></div>
        <div class="row"><button id="btn-add-submap" class="btn" type="button" style="width:100%">‚ûï Add Submap</button></div>
        <div id="submap-list"></div>
      </div>

      <div class="section" id="omniverse-lab">
        <h3>Omniverse Lab (beta)</h3>
        <div class="ov-box">
          <div class="ov-row">
            <label for="ov-url">Nucleus URL</label>
            <input id="ov-url" placeholder="omniverse://server/Projects/WarVault" />
          </div>
          <div class="ov-row">
            <label for="ov-usd">USD Path</label>
            <input id="ov-usd" placeholder="/Scenes/Dungeon.usd" />
          </div>
          <div class="ov-row">
            <label for="ov-res">Resolution</label>
            <input id="ov-res" placeholder="4096x3072" />
          </div>
          <div class="ov-row">
            <label for="ov-format">Format</label>
            <select id="ov-format">
              <option value="webp" selected>WebP</option>
              <option value="png">PNG</option>
            </select>
          </div>
          <div class="row" style="gap:.5rem;flex-wrap:wrap">
            <button id="ov-connect" class="btn" type="button">üîó Connect</button>
            <button id="ov-generate" class="btn" type="button">‚ú® Generate Map</button>
            <button id="ov-refresh" class="btn" type="button">‚Üª Refresh</button>
            <button id="ov-open-library" class="btn" type="button">üìÇ Open Library</button>
            <button id="ov-help-btn" class="btn" type="button" style="padding:0.35rem 0.5rem; font-size:0.8rem">?</button>
          </div>
          <div id="ov-console" aria-live="polite">Omniverse console ready.</div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Omniverse Help Popover -->
  <div id="ov-help">
    <h4>How to Use Omniverse</h4>
    <p>To connect your battlemap to NVIDIA Omniverse:</p>
    <ul>
      <li>Enter your <strong>Nucleus URL</strong> (e.g. <code>omniverse://your-server</code>)</li>
      <li>Set the <strong>USD Path</strong> to your scene</li>
      <li>Click <strong>Connect</strong> to sync</li>
      <li>Use <strong>Generate Map</strong> to pull terrain, lighting, and props</li>
    </ul>
    <p>Ensure Omniverse is running and accessible.</p>
  </div>

  <script>
    window.onload = function () {
      /* Element refs */
      const wrap = document.getElementById('map-container');
      const mapEl = document.getElementById('map');
      const grid = document.getElementById('grid-layer');
      const tpl = document.getElementById('template-layer');
      const fog = document.getElementById('fog-layer');
      const gctx = grid.getContext('2d');
      const tctx = tpl.getContext('2d');
      const fctx = fog.getContext('2d');

      const zoomInBtn = document.getElementById('btn-zoom-in');
      const zoomOutBtn = document.getElementById('btn-zoom-out');
      const mapUpload = document.getElementById('map-upload');
      const saveMapBtn = document.getElementById('btn-save-map');

      const toolButtons = Array.from(document.querySelectorAll('.tool'));
      const snapChk = document.getElementById('snap');
      const fogModeSel = document.getElementById('fog-mode');
      const brushSel = document.getElementById('brush');
      const clearTplBtn = document.getElementById('btn-clear-templates');
      const fogUndoBtn = document.getElementById('btn-fog-undo');
      const fogRedoBtn = document.getElementById('btn-fog-redo');

      const ctxMenu = document.getElementById('ctx');

      const tfName = document.getElementById('tf-name');
      const tfColor = document.getElementById('tf-color');
      const tfSize = document.getElementById('tf-size');
      const tfPhoto = document.getElementById('tf-photo');
      const createTokenBtn = document.getElementById('btn-create-token');
      const savedMapsDiv = document.getElementById('saved-maps');

      const subFile = document.getElementById('submap-file');
      const subName = document.getElementById('submap-name');
      const subAddBtn = document.getElementById('btn-add-submap');
      const subList = document.getElementById('submap-list');

      const initName = document.getElementById('init-name');
      const initRoll = document.getElementById('init-roll');
      const initAdd = document.getElementById('btn-init-add');
      const initNext = document.getElementById('btn-init-next');
      const initReset = document.getElementById('btn-init-reset');
      const initList = document.getElementById('init-list');

      const ovUrl = document.getElementById('ov-url');
      const ovUsd = document.getElementById('ov-usd');
      const ovRes = document.getElementById('ov-res');
      const ovFormat = document.getElementById('ov-format');
      const ovConnect = document.getElementById('ov-connect');
      const ovGenerate = document.getElementById('ov-generate');
      const ovRefresh = document.getElementById('ov-refresh');
      const ovOpenLibrary = document.getElementById('ov-open-library');
      const ovConsole = document.getElementById('ov-console');
      const ovHelpBtn = document.getElementById('ov-help-btn');
      const ovHelp = document.getElementById('ov-help');

      const threePreview = document.getElementById('three-preview');
      const model3D = document.getElementById('3d-model');

      /* Global state */
      let scale = 1;
      let offset = { x: 0, y: 0 };
      const cell = 50;

      let tokens = [];
      let portals = [];
      let templates = [];
      let selectedTemplate = null;

      let submaps = JSON.parse(localStorage.getItem('warvault-submaps') || '[]');
      let savedMaps = JSON.parse(localStorage.getItem('warvault-maps') || '[]');

      let currentTool = 'pan';
      let isPanning = false;                      /* FIX */
      let panStart = { x: 0, y: 0 };
      let startOffset = { x: 0, y: 0 };           /* FIX */
      let selectedToken = null;

      const FOG_LIMIT = 15;
      let fogUndoStack = [];
      let fogRedoStack = [];
      let paintingFog = false;
      let beganStroke = false;

      let draggingTemplate = null;
      let dragTemplateOffset = { x: 0, y: 0 };

      /* Initiative */
      let initiative = [];
      let initIdx = -1;

      /* WebRTC & WebSocket */
      let ws = null;
      let pc = null;

      /* Canvas sizing & initial draw */
      function fitCanvases() {
        const r = wrap.getBoundingClientRect();
        [grid, tpl, fog].forEach(cv => {
          cv.width = r.width;
          cv.height = r.height;
        });
        drawGrid();
        redrawTemplates();
        if (!fogUndoStack.length) {
          fctx.clearRect(0, 0, fog.width, fog.height);
          pushFogState(); // initial baseline
        }
        repositionAll();
      }
      let resizeRAF = 0;
      window.addEventListener('resize', () => {
        cancelAnimationFrame(resizeRAF);
        resizeRAF = requestAnimationFrame(fitCanvases);
      });
      fitCanvases();

      /* Coordinates & helpers */
      function screenToWorld(sx, sy) {
        return { x: (sx - offset.x) / scale, y: (sy - offset.y) / scale };
      }
      function worldToScreen(wx, wy) {
        return { x: offset.x + wx * scale, y: offset.y + wy * scale };
      }
      function snap(v) { return snapChk.checked ? Math.round(v / cell) * cell : v; }

      /* Grid */
      function drawGrid() {
        const step = cell * scale;
        gctx.clearRect(0, 0, grid.width, grid.height);
        gctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--rune');
        gctx.lineWidth = 1;

        for (let x = (offset.x % step + step) % step; x < grid.width; x += step) {
          gctx.beginPath(); gctx.moveTo(x, 0); gctx.lineTo(x, grid.height); gctx.stroke();
        }
        for (let y = (offset.y % step + step) % step; y < grid.height; y += step) {
          gctx.beginPath(); gctx.moveTo(0, y); gctx.lineTo(grid.width, y); gctx.stroke();
        }
      }

      /* Reposition map & overlays */
      function repositionAll() {
        mapEl.style.transform = `translate(${offset.x}px, ${offset.y}px) scale(${scale})`;
        drawGrid();
        tokens.forEach(t => {
          const s = worldToScreen(t.x, t.y);
          t.el.style.transform = `translate(${s.x}px, ${s.y}px) scale(${scale})`;
        });
        portals.forEach(p => {
          const s = worldToScreen(p.x, p.y);
          p.el.style.transform = `translate(${s.x - 13}px, ${s.y - 13}px) scale(${scale})`;
        });
        redrawTemplates();
      }

      /* Zoom / Pan */
      function setScale(newScale, anchorX, anchorY) {
        const old = scale;
        scale = Math.max(0.2, Math.min(6, newScale));
        const ax = anchorX ?? grid.width / 2;
        const ay = anchorY ?? grid.height / 2;
        const wx = (ax - offset.x) / old;
        const wy = (ay - offset.y) / old;
        offset.x = ax - wx * scale;
        offset.y = ay - wy * scale;
        repositionAll();
      }
      zoomInBtn.addEventListener('click', () => setScale(scale * 1.2));
      zoomOutBtn.addEventListener('click', () => setScale(scale / 1.2));
      wrap.addEventListener('wheel', e => {
        e.preventDefault();
        setScale(scale * (e.deltaY < 0 ? 1.15 : 0.87), e.offsetX, e.offsetY);
      }, { passive: false });

      // Pan drag on the map surface                                      // FIX
      wrap.addEventListener('mousedown', (e) => {
        if (currentTool !== 'pan') return;
        isPanning = true;
        panStart = { x: e.clientX, y: e.clientY };
        startOffset = { ...offset };
        mapEl.style.cursor = 'grabbing';
      });
      window.addEventListener('mousemove', (e) => {
        if (!isPanning) return;
        offset.x = startOffset.x + (e.clientX - panStart.x);
        offset.y = startOffset.y + (e.clientY - panStart.y);
        repositionAll();
      });
      window.addEventListener('mouseup', () => {
        if (isPanning) {
          isPanning = false;
          mapEl.style.cursor = 'grab';
        }
      });

      /* Map upload */
      mapUpload.addEventListener('change', e => {
        const file = e.target.files?.[0];
        if (!file) return;
        const r = new FileReader();
        r.onload = ev => {
          mapEl.onload = () => {
            fitCanvases();
            update3DPreview(mapEl.src);
          };
          mapEl.src = ev.target.result;
        };
        r.onerror = () => alert("Failed to load image");
        r.readAsDataURL(file);
      });

      function update3DPreview(src) {
        const base = src.replace('https://', '').split('/')[0] || '';
        let glb = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
        if (base.includes('dungeon')) glb = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
        if (base.includes('forest')) glb = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
        model3D.src = glb;
        threePreview.setAttribute('active', '');
      }

      /* Tools */
      function setTool(t) {
        currentTool = t;
        toolButtons.forEach(b => b.classList.toggle('toggled', b.dataset.tool === t));
        updateFogInteractivity();
      }
      toolButtons.forEach(b => b.addEventListener('click', () => setTool(b.dataset.tool)));
      setTool('pan');

      function updateFogInteractivity() {
        fog.style.pointerEvents = fogModeSel.value !== 'none' ? 'auto' : 'none';
      }
      fogModeSel.addEventListener('change', updateFogInteractivity);
      updateFogInteractivity();

      /* Fog paint + undo/redo */
      function pushFogState() {
        try {
          const img = fctx.getImageData(0, 0, fog.width, fog.height);
          fogUndoStack.push(img);
          if (fogUndoStack.length > FOG_LIMIT) fogUndoStack.shift();
          // clear redo whenever a fresh state is committed
          fogRedoStack = [];
        } catch (e) {
          console.warn("Fog undo failed (tainted canvas)");
        }
      }
      function beginFogStroke() {
        paintingFog = true;
        beganStroke = false;
      }
      function endFogStroke() {
        if (!paintingFog) return;
        paintingFog = false;
        // commit final state for undo
        pushFogState();
      }
      function paintFog(sx, sy, reveal) {
        if (!beganStroke) {
          // store state before first paint of this stroke
          pushFogState();
          beganStroke = true;
        }
        fctx.globalCompositeOperation = reveal ? 'destination-out' : 'source-over';
        if (!reveal) fctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--mist');
        const r = parseInt(brushSel.value, 10);
        fctx.beginPath(); fctx.arc(sx, sy, r, 0, Math.PI * 2); fctx.fill();
        fctx.globalCompositeOperation = 'source-over';
      }

      // Wire fog interactions (was missing)                                // FIX
      fog.addEventListener('mousedown', (e) => {
        if (fogModeSel.value === 'none') return;
        beginFogStroke();
        const rect = fog.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        paintFog(x, y, fogModeSel.value === 'reveal');
      });
      fog.addEventListener('mousemove', (e) => {
        if (!paintingFog) return;
        const rect = fog.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        paintFog(x, y, fogModeSel.value === 'reveal');
      });
      window.addEventListener('mouseup', endFogStroke);
      fog.addEventListener('mouseleave', endFogStroke);

      // Corrected undo/redo stacks                                         // FIX
      fogUndoBtn.addEventListener('click', () => {
        if (fogUndoStack.length < 2) return;
        const current = fogUndoStack.pop();           // drop current
        fogRedoStack.push(current);                   // move to redo
        const previous = fogUndoStack[fogUndoStack.length - 1];
        try { fctx.putImageData(previous, 0, 0); } catch {}
      });
      fogRedoBtn.addEventListener('click', () => {
        if (!fogRedoStack.length) return;
        const nextImg = fogRedoStack.pop();
        try {
          fctx.putImageData(nextImg, 0, 0);
          fogUndoStack.push(nextImg);                 // new current on undo stack
        } catch {}
      });

      /* AI Dungeon Master Assistant */
      async function askAI(prompt) {
        try {
          const res = await fetch('http://localhost:11434/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model: 'llama3', prompt, stream: false })
          });
          const data = await res.json();
          return data.response || "No response from AI";
        } catch (e) {
          return "AI not available (run Ollama)";
        }
      }

      /* Omniverse Connect */
      ovConnect.onclick = () => {
        if (!ovUrl.value || !ovUsd.value) return alert("Fill URL and USD path");
        ws = new WebSocket('ws://localhost:8080/omniverse');
        ws.onopen = () => {
          ws.send(JSON.stringify({ action: 'connect', url: ovUrl.value, usd: ovUsd.value }));
          logOv("Connected to Omniverse");
        };
        ws.onmessage = (e) => {
          const msg = JSON.parse(e.data);
          if (msg.type === 'map') {
            mapEl.src = msg.image;
            fitCanvases();
            logOv("Map received from Omniverse");
          }
        };
        ws.onerror = () => logOv("Failed to connect to Omniverse");
      };

      ovGenerate.onclick = () => {
        if (ws?.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ action: 'generate', res: ovRes.value, format: ovFormat.value }));
          logOv("Generating map in Omniverse...");
        } else {
          logOv("Not connected to Omniverse");
        }
      };

      function logOv(msg) {
        ovConsole.innerHTML += `<div>${new Date().toLocaleTimeString()} ‚Äî ${msg}</div>`;
        ovConsole.scrollTop = ovConsole.scrollHeight;
      }

      /* Omniverse Help Toggle */
      ovHelpBtn.onclick = () => {
        ovHelp.style.display = ovHelp.style.display === 'block' ? 'none' : 'block';
      };
      document.addEventListener('click', (e) => {
        if (!ovHelp.contains(e.target) && e.target !== ovHelpBtn) {
          ovHelp.style.display = 'none';
        }
      });

      /* Minimal Save Maps (stores config; thumbnail uses map src) */       // FIX
      function renderSavedMaps(){
        savedMapsDiv.innerHTML = '';
        if(!savedMaps.length){ savedMapsDiv.innerHTML = '<div class="sub">No saved maps yet.</div>'; return; }
        savedMaps.slice().reverse().forEach((m,i)=>{
          const row = document.createElement('div');
          row.className = 'map-item';
          row.innerHTML = `<div class="thumb" style="background-image:url('${m.data.src||''}')"></div><div>${m.name||('Map '+(i+1))}</div>`;
          row.title = 'Click to load';
          row.addEventListener('click', ()=>{
            const d=m.data;
            mapEl.src = d.src||mapEl.src;
            scale = d.scale??1; offset = d.offset??{x:0,y:0};
            repositionAll();
          });
          savedMapsDiv.appendChild(row);
        });
      }
      function stripToken(t){ const {el, ...rest}=t; return rest; }
      saveMapBtn.addEventListener('click', ()=>{
        const name = prompt('Save map as:', 'Map ' + new Date().toLocaleString());
        const data = {
          src: mapEl.src,
          scale, offset, cell,
          tokens: tokens.map(stripToken),
          portals, templates
        };
        savedMaps.push({ name, data, ts: Date.now() });
        localStorage.setItem('warvault-maps', JSON.stringify(savedMaps));
        renderSavedMaps();
      });
      renderSavedMaps();

      // ... you can continue wiring the rest of your token/portal/template logic here ...
    };
  </script>
</body>
</html>
