<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The War Vault ‚Äî Omniverse Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Great+Vibes&display=swap" rel="stylesheet">
  <style>
    :root{
      --gold:#e6c57f;--accent:#b88c5c;--ink:#eee;--panel:#14131a;--mist:rgba(0,0,0,.55);--rune:rgba(230,197,127,.28);
      --paper:#f4ecd7;--paperEdge:#c9b27a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;height:100vh;display:flex;flex-direction:column;background:#000;color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;overflow:hidden
    }

    /* Atmospheric background */
    body::before{
      content:"";
      position:fixed; inset:-10%;
      background:
        radial-gradient(60% 60% at 20% 10%, rgba(230,197,127,.12), transparent 60%),
        radial-gradient(50% 50% at 80% 0%, rgba(142,114,79,.10), transparent 55%),
        radial-gradient(45% 45% at 50% 100%, rgba(184,140,92,.10), transparent 55%),
        linear-gradient(180deg, #0b0a10, #0b0a10 40%, #0a0a12 100%);
      filter: saturate(110%) blur(0.3px);
      z-index:-1;
    }

    header{
      display:flex;align-items:center;justify-content:space-between;padding:.6rem 1rem;
      border-bottom:1px solid var(--accent);background:rgba(10,10,14,.9);backdrop-filter:blur(6px);
      position:relative;z-index:20;
      box-shadow: 0 2px 20px rgba(230,197,127,.06);
    }
    .brand{display:flex;flex-direction:column}
    .brand .title{
      font-family:'Cinzel',serif;font-weight:900;letter-spacing:.06em;color:var(--gold);
      text-shadow:0 0 12px rgba(230,197,127,.35);font-size:1.4rem
    }
    .brand .byline{font-family:'Great Vibes',cursive;font-size:1.5rem;line-height:1;color:var(--gold)}
    .actions{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .btn{
      background:rgba(35,35,45,.85);border:1px solid var(--accent);color:var(--ink);
      padding:.35rem .6rem;border-radius:8px;cursor:pointer
    }
    .btn:hover{background:var(--accent);color:#000;box-shadow:0 0 14px rgba(230,197,127,.35)}
    .btn.toggled{background:var(--accent);color:#000}
    input,select{
      background:#1c1b24;border:1px solid var(--accent);color:var(--ink);
      padding:.35rem;border-radius:6px;width:100%
    }

    #stage{flex:1;display:grid;grid-template-columns:320px 1fr 360px;min-height:0}
    #left-panel{
      background:var(--panel);border-right:1px solid var(--accent);overflow:auto;display:flex;flex-direction:column;
      box-shadow: inset 0 0 0 1px rgba(184,140,92,.22), inset 0 0 24px rgba(230,197,127,.06);
    }
    #right-panel{
      background:var(--panel);border-left:1px solid var(--accent);overflow:auto;
      box-shadow: inset 0 0 0 1px rgba(184,140,92,.22), inset 0 0 24px rgba(230,197,127,.06);
    }
    #map-container{position:relative;overflow:hidden;background:#111}

    .section{padding:12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .section h3{
      margin:.1rem 0 .6rem;font-family:'Cinzel',serif;color:var(--gold);font-size:1rem
    }
    .row{display:flex;gap:.5rem;align-items:center;margin:.4rem 0}
    .row.stacked{flex-direction:column;align-items:stretch}

    #map{
      position:absolute;inset:0;object-fit:contain;width:100%;height:100%;
      transform-origin:top left;cursor:grab;z-index:1
    }
    canvas{position:absolute;left:0;top:0;pointer-events:none}
    #grid-layer{z-index:2}
    #template-layer{z-index:3}
    #fog-layer{z-index:5} /* keep fog below tokens by default */

    .token{
      position:absolute;border-radius:50%;background:#f44;color:#000;font-weight:800;
      display:flex;align-items:center;justify-content:center;user-select:none;cursor:grab;
      z-index:6;border:2px solid #fff;transform-origin:center;overflow:hidden
    }
    .token span{pointer-events:none}
    .token.has-img{background-size:cover;background-position:center;color:#fff;text-shadow:0 1px 2px #000}
    .portal{
      position:absolute;width:26px;height:26px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #8df,#15a);
      border:2px solid #fff;box-shadow:0 0 10px #8df;z-index:7;cursor:pointer;transform-origin:center
    }

    #ctx{
      position:absolute;z-index:50;background:#1b1a22;border:1px solid var(--accent);
      border-radius:8px;overflow:hidden;display:none;min-width:180px
    }
    #ctx button{display:block;width:100%;text-align:left;padding:.5rem .7rem;background:transparent;color:var(--ink);border:none;cursor:pointer}
    #ctx button:hover{background:rgba(255,255,255,.08)}

    #submap-overlay{
      position:absolute;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;z-index:30
    }
    .parchment{
      position:absolute;inset:6% 10%;background:var(--paper) url('https://i.imgur.com/2mJvRjF.png') center/cover no-repeat;
      box-shadow:0 20px 60px rgba(0,0,0,.6);border:2px solid var(--paperEdge);border-radius:14px;overflow:hidden
    }
    .parchment .head{
      display:flex;justify-content:space-between;align-items:center;padding:.4rem .6rem;
      background:linear-gradient(#f6eed9,#eadfbf);border-bottom:1px solid var(--paperEdge)
    }
    .parchment .head .ttl{font-family:'Cinzel',serif;color:#5a4829}
    .parchment .head .x{background:#7a1;color:#fff;border:none;padding:.3rem .55rem;border-radius:999px;cursor:pointer}
    .parchment .body{position:absolute;inset:42px 8px 8px 8px;background:#d7ccb0}

    #submap-canvas{position:absolute;inset:0}

    #token-forge{flex:1;overflow:auto}
    #forge-grid{display:grid;grid-template-columns:1fr;gap:.6rem}
    #saved-maps{
      max-height:160px;overflow:auto;border:1px solid rgba(255,255,255,.12);
      border-radius:8px;padding:.35rem
    }
    .map-item{display:flex;align-items:center;gap:.5rem;margin:.3rem 0}
    .thumb{width:42px;height:42px;background:#222;border:1px solid rgba(255,255,255,.12);background-size:cover;background-position:center;border-radius:6px}
    #initiative{margin-top:auto}

    .handle{position:absolute;width:10px;height:10px;border:2px solid #00c8ff;background:#00131a;border-radius:2px;z-index:9;pointer-events:auto}

    .ov-box{border:1px solid var(--paperEdge);border-radius:10px;background:rgba(235,220,185,.07);padding:.6rem}
    .ov-row{display:grid;grid-template-columns:100px 1fr;gap:.5rem;align-items:center;margin:.35rem 0}
    #ov-console{
      min-height:70px;max-height:160px;overflow:auto;background:#0e0d12;border:1px dashed var(--accent);
      padding:.5rem;border-radius:8px;font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace;font-size:.85rem
    }

    /* Previous Renders modal */
    #renders-modal{
      position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:60
    }
    #renders-dialog{
      width:min(920px,90vw);max-height:80vh;overflow:auto;background:#14131a;border:1px solid var(--accent);border-radius:12px;
      box-shadow:0 30px 80px rgba(0,0,0,.65);padding:12px
    }
    .rl-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    @media (max-width:980px){ .rl-grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:620px){ .rl-grid{grid-template-columns:1fr} }
    .rl-card{border:1px solid rgba(255,255,255,.12);border-radius:10px;overflow:hidden;background:#0f0f14}
    .rl-shot{height:160px;background:#222 center/cover no-repeat}
    .rl-meta{padding:.5rem;border-top:1px solid rgba(255,255,255,.06)}
    .rl-actions{display:flex;gap:.4rem;padding:.5rem;border-top:1px solid rgba(255,255,255,.06)}

    /* Help popover */
    #ov-help{
      position:absolute;top:100%;left:50%;transform:translateX(-50%);
      width:420px;background:#14131a;border:1px solid var(--accent);border-radius:12px;
      color:var(--ink);font-size:.9rem;line-height:1.4;box-shadow:0 20px 50px rgba(0,0,0,.6);
      z-index:50;padding:1rem;display:none;
    }
    #ov-help::before{
      content:"";position:absolute;top:-10px;left:50%;transform:translateX(-50%);
      border:5px solid transparent;border-bottom:5px solid var(--accent);
    }
    #ov-help h4{color:var(--gold);margin:.2rem 0; font-size:1rem}
    #ov-help ul{margin:.5rem 0; padding-left:1.2rem }

    @media (max-width:1180px){
      #stage{grid-template-columns:0 1fr 360px}
      #left-panel{display:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="title">The War Vault</div>
      <div class="byline">Chris Marshall</div>
    </div>
    <div class="actions">
      <button id="btn-zoom-in" class="btn" type="button" title="Zoom in">Ôºã</button>
      <button id="btn-zoom-out" class="btn" type="button" title="Zoom out">Ôºç</button>
      <input id="map-upload" type="file" accept="image/*" class="btn" title="Upload map" />
      <button id="btn-save-map" class="btn" type="button" title="Save map">üíæ Save Map</button>
      <button id="btn-open-renders" class="btn" type="button" title="Previous renders">üñºÔ∏è Previous Renders</button>
    </div>
  </header>

  <div id="stage">
    <aside id="left-panel">
      <div class="section" id="token-forge">
        <h3>Token Forge</h3>
        <div id="forge-grid">
          <div>
            <div class="row"><input id="tf-name" placeholder="Name" /></div>
            <div class="row">
              <label for="tf-color" style="min-width:60px">Color</label>
              <input id="tf-color" type="color" value="#ff4444" />
            </div>
            <div class="row">
              <label for="tf-size" style="min-width:60px">Size (px)</label>
              <input id="tf-size" type="number" min="24" max="120" value="42" />
            </div>
            <div class="row"><input id="tf-photo" type="file" accept="image/*" /></div>
            <div class="row"><button id="btn-create-token" class="btn" type="button" style="width:100%">‚ûï Create Token</button></div>
          </div>
          <div>
            <div style="margin-bottom:.3rem;color:#cbb27d">Saved Maps</div>
            <div id="saved-maps"></div>
          </div>
        </div>
      </div>

      <div class="section" id="initiative">
        <h3>Initiative</h3>
        <div class="row">
          <input id="init-name" placeholder="Name" aria-label="Initiative name">
          <input id="init-roll" type="number" placeholder="Roll" style="max-width:90px" aria-label="Initiative roll">
        </div>
        <div class="row">
          <button id="btn-init-add" class="btn" type="button" style="width:100%">Add</button>
        </div>
        <div class="row" style="gap:.5rem">
          <button id="btn-init-next" class="btn" type="button" style="flex:1">Next</button>
          <button id="btn-init-reset" class="btn" type="button" style="flex:1">Reset</button>
        </div>
        <div id="init-list" style="margin-top:.5rem"></div>
      </div>
    </aside>

    <main id="map-container">
      <img id="map" src="https://i.imgur.com/8V7V3sP.jpg" alt="Map" draggable="false" />
      <canvas id="grid-layer"></canvas>
      <canvas id="template-layer"></canvas>
      <canvas id="fog-layer"></canvas>

      <div id="ctx" role="menu">
        <button data-act="sheet" type="button">View Character Sheet</button>
        <button data-act="assign-submap" type="button">Assign Submap‚Ä¶</button>
        <button data-act="open-submap" type="button">Open Submap</button>
        <button data-act="delete" type="button">Delete Token</button>
      </div>

      <div id="submap-overlay" aria-hidden="true">
        <div class="parchment" role="dialog" aria-modal="true" aria-labelledby="submap-title">
          <div class="head">
            <div class="ttl" id="submap-title">Submap</div>
            <button class="x" id="close-submap" type="button" aria-label="Close">‚úï</button>
          </div>
          <div class="body">
            <canvas id="submap-canvas"></canvas>
          </div>
        </div>
      </div>
    </main>

    <aside id="right-panel">
      <div class="section">
        <h3>Tools</h3>
        <div class="row" style="flex-wrap:wrap">
          <button class="btn tool" type="button" data-tool="pan">üñêÔ∏è Pan</button>
          <button class="btn tool" type="button" data-tool="select">üñ±Ô∏è Select</button>
          <button class="btn tool" type="button" data-tool="ruler">üìè Ruler</button>
          <button class="btn tool" type="button" data-tool="los">üéØ LOS</button>
          <button class="btn tool" type="button" data-tool="circle">‚≠ï Circle</button>
          <button class="btn tool" type="button" data-tool="rect">‚ñ≠ Rect</button>
          <button class="btn tool" type="button" data-tool="cone">üî∫ Cone</button>
          <button class="btn tool" type="button" data-tool="portal">üåÄ Portal</button>
        </div>
        <div class="row">
          <button id="btn-clear-templates" class="btn" type="button" style="flex:1">Clear Templates</button>
          <label style="display:flex;align-items:center;gap:.35rem"><input type="checkbox" id="snap" /> Snap-to-grid</label>
        </div>
        <div class="row">
          <select id="fog-mode" aria-label="Fog mode">
            <option value="none">Fog: off</option>
            <option value="reveal">Fog: reveal</option>
            <option value="hide">Fog: hide</option>
          </select>
          <select id="brush" aria-label="Brush size">
            <option value="20">Brush 20</option>
            <option value="40" selected>Brush 40</option>
            <option value="80">Brush 80</option>
          </select>
        </div>
        <div class="row" style="gap:.5rem">
          <button id="btn-fog-undo" class="btn" type="button" style="flex:1">‚ü≤ Fog Undo</button>
          <button id="btn-fog-redo" class="btn" type="button" style="flex:1">‚ü≥ Fog Redo</button>
        </div>
      </div>

      <div class="section" id="submap-manager">
        <h3>Submap Manager</h3>
        <div class="row"><input type="file" id="submap-file" accept="image/*" aria-label="Submap image"></div>
        <div class="row"><input type="text" id="submap-name" placeholder="Name" aria-label="Submap name"></div>
        <div class="row"><button id="btn-add-submap" class="btn" type="button" style="width:100%">‚ûï Add Submap</button></div>
        <div id="submap-list"></div>
      </div>

      <div class="section" id="omniverse-lab">
        <h3>Omniverse Lab (beta)</h3>
        <div class="ov-box">
          <div class="ov-row">
            <label for="ov-url">Nucleus URL</label>
            <input id="ov-url" placeholder="omniverse://server/Projects/WarVault" />
          </div>
          <div class="ov-row">
            <label for="ov-usd">USD Path</label>
            <input id="ov-usd" placeholder="/Scenes/Dungeon.usd" />
          </div>
          <div class="ov-row">
            <label for="ov-res">Resolution</label>
            <input id="ov-res" placeholder="4096x3072" />
          </div>
          <div class="ov-row">
            <label for="ov-format">Format</label>
            <select id="ov-format">
              <option value="webp" selected>WebP</option>
              <option value="png">PNG</option>
            </select>
          </div>
          <div class="row" style="gap:.5rem;flex-wrap:wrap">
            <button id="ov-connect" class="btn" type="button">üîó Connect</button>
            <button id="ov-generate" class="btn" type="button">‚ú® Generate Map</button>
            <button id="ov-refresh" class="btn" type="button">‚Üª Refresh</button>
            <button id="ov-open-library" class="btn" type="button">üìÇ Open Library</button>
            <button id="ov-help-btn" class="btn" type="button" style="padding:0.35rem 0.5rem; font-size:0.8rem">?</button>
          </div>
          <div id="ov-console" aria-live="polite">Omniverse console ready.</div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Previous Renders Modal -->
  <div id="renders-modal" role="dialog" aria-modal="true" aria-labelledby="renders-title">
    <div id="renders-dialog">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <h3 id="renders-title" style="margin:.2rem 0;font-family:'Cinzel',serif;color:var(--gold)">Previous Renders</h3>
        <button id="renders-close" class="btn" type="button">‚úï Close</button>
      </div>
      <div id="renders-grid" class="rl-grid"></div>
    </div>
  </div>

  <!-- Omniverse Help Popover -->
  <div id="ov-help">
    <h4>How to Use Omniverse</h4>
    <p>To connect your battlemap to NVIDIA Omniverse:</p>
    <ul>
      <li>Enter your <strong>Nucleus URL</strong> (e.g. <code>omniverse://your-server</code>)</li>
      <li>Set the <strong>USD Path</strong> to your scene</li>
      <li>Click <strong>Connect</strong> to sync</li>
      <li>Use <strong>Generate Map</strong> to pull terrain, lighting, and props</li>
    </ul>
    <p>Ensure Omniverse is running and accessible.</p>
  </div>

  <script>
    window.onload = function () {
      /* Element refs */
      const wrap = document.getElementById('map-container');
      const mapEl = document.getElementById('map');
      const grid = document.getElementById('grid-layer');
      const tpl = document.getElementById('template-layer');
      const fog = document.getElementById('fog-layer');
      const gctx = grid.getContext('2d');
      const tctx = tpl.getContext('2d');
      const fctx = fog.getContext('2d');

      const zoomInBtn = document.getElementById('btn-zoom-in');
      const zoomOutBtn = document.getElementById('btn-zoom-out');
      const mapUpload = document.getElementById('map-upload');
      const saveMapBtn = document.getElementById('btn-save-map');

      const toolButtons = Array.from(document.querySelectorAll('.tool'));
      const snapChk = document.getElementById('snap');
      const fogModeSel = document.getElementById('fog-mode');
      const brushSel = document.getElementById('brush');
      const clearTplBtn = document.getElementById('btn-clear-templates');
      const fogUndoBtn = document.getElementById('btn-fog-undo');
      const fogRedoBtn = document.getElementById('btn-fog-redo');

      const ctxMenu = document.getElementById('ctx');

      const tfName = document.getElementById('tf-name');
      const tfColor = document.getElementById('tf-color');
      const tfSize = document.getElementById('tf-size');
      const tfPhoto = document.getElementById('tf-photo');
      const createTokenBtn = document.getElementById('btn-create-token');
      const savedMapsDiv = document.getElementById('saved-maps');

      const subFile = document.getElementById('submap-file');
      const subName = document.getElementById('submap-name');
      const subAddBtn = document.getElementById('btn-add-submap');
      const subList = document.getElementById('submap-list');

      const initName = document.getElementById('init-name');
      const initRoll = document.getElementById('init-roll');
      const initAdd = document.getElementById('btn-init-add');
      const initNext = document.getElementById('btn-init-next');
      const initReset = document.getElementById('btn-init-reset');
      const initList = document.getElementById('init-list');

      /* Omniverse lab */
      const ovUrl = document.getElementById('ov-url');
      const ovUsd = document.getElementById('ov-usd');
      const ovRes = document.getElementById('ov-res');
      const ovFormat = document.getElementById('ov-format');
      const ovConnect = document.getElementById('ov-connect');
      const ovGenerate = document.getElementById('ov-generate');
      const ovRefresh = document.getElementById('ov-refresh');
      const ovOpenLibrary = document.getElementById('ov-open-library');
      const ovConsole = document.getElementById('ov-console');
      const ovHelpBtn = document.getElementById('ov-help-btn');
      const ovHelp = document.getElementById('ov-help');

      /* Previous Renders modal */
      const openRendersBtn = document.getElementById('btn-open-renders');
      const rendersModal = document.getElementById('renders-modal');
      const rendersClose = document.getElementById('renders-close');
      const rlGrid = document.getElementById('renders-grid');

      /* Global state */
      let scale = 1;
      let offset = { x: 0, y: 0 };
      const cell = 50;

      let tokens = [];
      let portals = [];
      let templates = [];

      let submaps = JSON.parse(localStorage.getItem('warvault-submaps') || '[]');
      let savedMaps = JSON.parse(localStorage.getItem('warvault-maps') || '[]');

      let currentTool = 'pan';
      let isPanning = false;
      let panMouse = { x: 0, y: 0 };
      let selectedToken = null;

      const FOG_LIMIT = 15;
      let fogUndoStack = [];
      let fogRedoStack = [];
      let paintingFog = false;
      let beganStroke = false;

      /* Initiative */
      let initiative = [];
      let initIdx = -1;

      /* WebSocket (stub bridge hooks preserved) */
      let ws = null;
      function ensureWS(){
        if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) return;
        ws = new WebSocket('ws://localhost:8080/omniverse');
        ws.onopen = ()=> logOv("Bridge connected");
        ws.onclose = ()=> logOv("Bridge disconnected");
        ws.onerror = ()=> logOv("Bridge error");
        ws.onmessage = (e)=>{
          try {
            const msg = JSON.parse(e.data);
            if (msg.type === 'map') {
              mapEl.onload = ()=> fitCanvases();
              mapEl.src = msg.image;                // data URL from bridge
              logOv("Map loaded.");
            } else if (msg.type === 'list') {
              buildLibrary(msg.items||[]);
            } else if (msg.type === 'error') {
              logOv("Error: " + msg.message);
              alert(msg.message);
            } else if (msg.type === 'info') {
              logOv(msg.message||'Info');
            }
          } catch { /* ignore */ }
        };
      }

      /* Canvas sizing & initial draw (HiDPI aware) */
      function fitCanvases() {
        const r = wrap.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;

        [grid, tpl, fog].forEach(cv => {
          cv.width  = Math.max(1, Math.floor(r.width  * dpr));
          cv.height = Math.max(1, Math.floor(r.height * dpr));
          cv.style.width  = r.width + 'px';
          cv.style.height = r.height + 'px';
        });

        gctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        tctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        fctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        drawGrid();
        redrawTemplates();

        if (!fogUndoStack.length) {
          fctx.clearRect(0, 0, grid.width / dpr, grid.height / dpr);
          pushFogState();
        }
        repositionAll();
      }
      let resizeRAF = 0;
      window.addEventListener('resize', () => {
        cancelAnimationFrame(resizeRAF);
        resizeRAF = requestAnimationFrame(fitCanvases);
      });
      fitCanvases();

      /* Coordinates & helpers */
      function screenToWorld(sx, sy) {
        return { x: (sx - offset.x) / scale, y: (sy - offset.y) / scale };
      }
      function worldToScreen(wx, wy) {
        return { x: offset.x + wx * scale, y: offset.y + wy * scale };
      }
      function snap(v) {
        return snapChk.checked ? Math.round(v / cell) * cell : v;
      }

      /* Grid (CSS px after transform) */
      function drawGrid() {
        const dpr = window.devicePixelRatio || 1;
        const w = grid.width / dpr;
        const h = grid.height / dpr;

        gctx.clearRect(0, 0, w, h);
        gctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--rune');
        gctx.lineWidth = 1;

        const step = cell * scale;
        for (let x = (offset.x % step + step) % step; x < w; x += step) {
          gctx.beginPath(); gctx.moveTo(x, 0); gctx.lineTo(x, h); gctx.stroke();
        }
        for (let y = (offset.y % step + step) % step; y < h; y += step) {
          gctx.beginPath(); gctx.moveTo(0, y); gctx.lineTo(w, y); gctx.stroke();
        }
      }

      /* Reposition map & overlays (also move Fog!) */
      function repositionAll() {
        const transform = `translate(${offset.x}px, ${offset.y}px) scale(${scale})`;
        mapEl.style.transform = transform;
        fog.style.transform = transform;            // <‚Äî fog follows map
        tpl.style.transform = transform;            // templates follow map
        drawGrid();
        tokens.forEach(t => {
          const s = worldToScreen(t.x, t.y);
          t.el.style.transform = `translate(${s.x}px, ${s.y}px) scale(${scale})`;
        });
        portals.forEach(p => {
          const s = worldToScreen(p.x, p.y);
          p.el.style.transform = `translate(${s.x - 13}px, ${s.y - 13}px) scale(${scale})`;
        });
        redrawTemplates();
      }

      /* Zoom / Pan */
      function setScale(newScale, anchorX, anchorY) {
        const old = scale;
        scale = Math.max(0.2, Math.min(6, newScale));
        const ax = anchorX ?? grid.width / (window.devicePixelRatio||1) / 2;
        const ay = anchorY ?? grid.height / (window.devicePixelRatio||1) / 2;
        const wx = (ax - offset.x) / old;
        const wy = (ay - offset.y) / old;
        offset.x = ax - wx * scale;
        offset.y = ay - wy * scale;
        repositionAll();
      }
      zoomInBtn.addEventListener('click', () => setScale(scale * 1.2));
      zoomOutBtn.addEventListener('click', () => setScale(scale / 1.2));
      wrap.addEventListener('wheel', e => {
        e.preventDefault();
        setScale(scale * (e.deltaY < 0 ? 1.15 : 0.87), e.offsetX, e.offsetY);
      }, { passive: false });

      wrap.addEventListener('mousedown', (e)=>{
        if (currentTool !== 'pan') return;
        isPanning = true;
        panMouse = {x:e.clientX, y:e.clientY};
        wrap.style.cursor = 'grabbing';
      });
      window.addEventListener('mousemove', (e)=>{
        if (!isPanning) return;
        const dx = e.clientX - panMouse.x;
        const dy = e.clientY - panMouse.y;
        panMouse = {x:e.clientX, y:e.clientY};
        offset.x += dx;
        offset.y += dy;
        repositionAll();
      });
      window.addEventListener('mouseup', ()=>{
        isPanning = false;
        wrap.style.cursor = 'grab';
      });

      /* Map upload */
      mapUpload.addEventListener('change', e => {
        const file = e.target.files?.[0];
        if (!file) return;
        const r = new FileReader();
        r.onload = ev => {
          mapEl.onload = () => {
            fitCanvases();
          };
          mapEl.src = ev.target.result;
        };
        r.onerror = () => alert("Failed to load image");
        r.readAsDataURL(file);
      });

      /* Tool interactivity toggles */
      function updateTemplateInteractivity() {
        const drawTools = ['ruler','circle','rect','cone'];
        tpl.style.pointerEvents = drawTools.includes(currentTool) ? 'auto' : 'none';
      }
      function updateFogInteractivity() {
        fog.style.pointerEvents = fogModeSel.value !== 'none' ? 'auto' : 'none';
      }
      function setTool(t) {
        currentTool = t;
        toolButtons.forEach(b => b.classList.toggle('toggled', b.dataset.tool === t));
        updateFogInteractivity();
        updateTemplateInteractivity();
      }
      toolButtons.forEach(b => b.addEventListener('click', () => setTool(b.dataset.tool)));
      setTool('pan');
      fogModeSel.addEventListener('change', updateFogInteractivity);
      updateFogInteractivity();

      /* Fog paint + undo/redo (paint in screen coords; canvas is transformed with map) */
      function pushFogState() {
        try {
          const img = fctx.getImageData(0, 0, fog.width, fog.height);
          fogUndoStack.push(img);
          if (fogUndoStack.length > FOG_LIMIT) fogUndoStack.shift();
          fogRedoStack = [];
        } catch (e) {
          console.warn("Fog undo failed (tainted canvas)");
        }
      }
      function beginFogStroke() {
        paintingFog = true;
        beganStroke = false;
      }
      function endFogStroke() {
        paintingFog = false;
        pushFogState();
      }
      function paintFog(sx, sy, reveal) {
        if (!beganStroke) {
          pushFogState();
          beganStroke = true;
        }
        fctx.globalCompositeOperation = reveal ? 'destination-out' : 'source-over';
        if (!reveal) fctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--mist');
        const r = parseInt(brushSel.value, 10);
        fctx.beginPath(); fctx.arc(sx, sy, r, 0, Math.PI * 2); fctx.fill();
        fctx.globalCompositeOperation = 'source-over';
      }
      fog.addEventListener('mousedown', (e)=>{
        if (fogModeSel.value === 'none') return;
        beginFogStroke();
        paintFog(e.offsetX, e.offsetY, fogModeSel.value==='reveal');
      });
      fog.addEventListener('mousemove', (e)=>{
        if (!paintingFog) return;
        paintFog(e.offsetX, e.offsetY, fogModeSel.value==='reveal');
      });
      window.addEventListener('mouseup', ()=> paintingFog && endFogStroke());
      fogUndoBtn.addEventListener('click', () => {
        if (fogUndoStack.length < 2) return;
        const prev = fogUndoStack.pop();
        fogRedoStack.push(fctx.getImageData(0, 0, fog.width, fog.height));
        try {
          fctx.putImageData(prev, 0, 0);
        } catch (e) {
          console.warn("Fog undo failed");
        }
      });
      fogRedoBtn.addEventListener('click', () => {
        if (!fogRedoStack.length) return;
        const img = fogRedoStack.pop();
        fogUndoStack.push(fctx.getImageData(0, 0, fog.width, fog.height));
        try {
          fctx.putImageData(img, 0, 0);
        } catch (e) {
          console.warn("Fog redo failed");
        }
      });

      /* Templates (ruler/aoe) */
      let drawing = null;
      tpl.addEventListener('mousedown', (e) => {
        if (!['ruler','circle','rect','cone'].includes(currentTool)) return;
        const rect = wrap.getBoundingClientRect();
        const start = screenToWorld(e.clientX - rect.left, e.clientY - rect.top);
        drawing = { tool: currentTool, start, end: {...start} };
      });
      window.addEventListener('mousemove', (e) => {
        if (!drawing) return;
        const rect = wrap.getBoundingClientRect();
        drawing.end = screenToWorld(e.clientX - rect.left, e.clientY - rect.top);
        redrawTemplates(drawing);
      });
      window.addEventListener('mouseup', () => {
        if (!drawing) return;
        templates.push(drawing);
        drawing = null;
        redrawTemplates();
      });

      function redrawTemplates(ghost){
        const dpr = window.devicePixelRatio || 1;
        tctx.clearRect(0,0,tpl.width / dpr, tpl.height / dpr);
        const all = ghost ? [...templates, ghost] : templates;
        all.forEach(drawShape);
      }

      function drawShape(s) {
        const a = worldToScreen(s.start.x, s.start.y);
        const b = worldToScreen(s.end.x, s.end.y);
        tctx.save();
        tctx.strokeStyle = '#9ad';
        tctx.fillStyle = 'rgba(150,200,255,0.18)';
        tctx.lineWidth = 2;

        if (s.tool === 'ruler') {
          tctx.beginPath(); tctx.moveTo(a.x, a.y); tctx.lineTo(b.x, b.y); tctx.stroke();
          const dist = Math.hypot(s.end.x - s.start.x, s.end.y - s.start.y) / cell;
          tctx.fillStyle = '#fff';
          tctx.font = '12px ui-monospace';
          tctx.fillText(dist.toFixed(1) + ' squares', (a.x + b.x)/2 + 6, (a.y + b.y)/2 - 6);
        } else if (s.tool === 'circle') {
          const r = Math.hypot(b.x - a.x, b.y - a.y);
          tctx.beginPath(); tctx.arc(a.x, a.y, r, 0, Math.PI * 2); tctx.stroke(); tctx.fill();
        } else if (s.tool === 'rect') {
          tctx.beginPath();
          tctx.rect(Math.min(a.x,b.x), Math.min(a.y,b.y), Math.abs(b.x-a.x), Math.abs(b.y-a.y));
          tctx.stroke(); tctx.fill();
        } else if (s.tool === 'cone') {
          const angle = Math.atan2(b.y - a.y, b.x - a.x);
          const len = Math.hypot(b.x - a.x, b.y - a.y);
          const spread = Math.PI / 3; // 60¬∞
          tctx.beginPath();
          tctx.moveTo(a.x, a.y);
          tctx.lineTo(a.x + Math.cos(angle - spread/2) * len, a.y + Math.sin(angle - spread/2) * len);
          tctx.arc(a.x, a.y, len, angle - spread/2, angle + spread/2);
          tctx.closePath(); tctx.stroke(); tctx.fill();
        }
        tctx.restore();
      }

      clearTplBtn.addEventListener('click', ()=>{
        templates = [];
        redrawTemplates();
      });

      /* Portals */
      function addPortal(x, y) {
        const el = document.createElement('div');
        el.className = 'portal';
        wrap.appendChild(el);
        const p = { el, x, y };
        portals.push(p);
        const s = worldToScreen(x, y);
        el.style.transform = `translate(${s.x - 13}px, ${s.y - 13}px) scale(${scale})`;
        el.addEventListener('click', (ev) => {
          ev.stopPropagation();
          if (!selectedToken) return;
          selectedToken.x = x; selectedToken.y = y;
          const scr = worldToScreen(x, y);
          selectedToken.el.style.transform = `translate(${scr.x}px, ${scr.y}px) scale(${scale})`;
        });
      }
      wrap.addEventListener('click', (e) => {
        if (currentTool !== 'portal') return;
        const rect = wrap.getBoundingClientRect();
        const w = screenToWorld(e.clientX - rect.left, e.clientY - rect.top);
        addPortal(w.x, w.y);
      });

      /* Tokens */
      function addToken({name,color,size,img,x,y}){
        const el = document.createElement('div');
        el.className = 'token';
        el.style.width = el.style.height = (size||42)+'px';
        el.style.background = color || '#f44';
        el.innerHTML = '<span>'+ (name||'T') +'</span>';
        if (img){
          el.classList.add('has-img');
          el.style.backgroundImage = `url(${img})`;
        }
        wrap.appendChild(el);
        const t = {el, name, color, size: size||42, x: x||100, y: y||100, submap: null, sheetUrl: null};
        tokens.push(t);
        const s = worldToScreen(t.x,t.y);
        el.style.transform = `translate(${s.x}px, ${s.y}px) scale(${scale})`;
        draggableToken(t);

        // Right-click to select + open context menu
        el.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          selectedToken = t;
          const rect = wrap.getBoundingClientRect();
          ctxMenu.style.display = 'block';
          ctxMenu.style.left = (e.clientX - rect.left) + 'px';
          ctxMenu.style.top  = (e.clientY - rect.top)  + 'px';
        });
      }
      function draggableToken(t){
        let dragging=false, start={x:0,y:0}, tokStart={x:0,y:0};
        t.el.addEventListener('mousedown', (e)=>{
          if (currentTool!=='select') return;
          dragging=true; selectedToken=t;
          start={x:e.clientX,y:e.clientY};
          tokStart={x:t.x,y:t.y};
          e.preventDefault();
        });
        window.addEventListener('mousemove', (e)=>{
          if (!dragging) return;
          const dx = (e.clientX-start.x)/scale;
          const dy = (e.clientY-start.y)/scale;
          t.x = snap(tokStart.x+dx);
          t.y = snap(tokStart.y+dy);
          const s = worldToScreen(t.x,t.y);
          t.el.style.transform = `translate(${s.x}px, ${s.y}px) scale(${scale})`;
        });
        window.addEventListener('mouseup', ()=> dragging=false);
      }

      createTokenBtn.addEventListener('click', ()=>{
        const name = tfName.value.trim()||'T';
        const color = tfColor.value;
        const size = Math.max(24, Math.min(120, parseInt(tfSize.value||42,10)));
        if (tfPhoto.files?.[0]){
          const r = new FileReader();
          r.onload = ev => addToken({name,color,size,img:ev.target.result});
          r.readAsDataURL(tfPhoto.files[0]);
        } else {
          addToken({name,color,size});
        }
      });

      /* Context menu behavior */
      wrap.addEventListener('contextmenu', (e)=>{
        // Right-click empty space: show menu but without a token selected
        if (!e.target.closest('.token')) {
          e.preventDefault();
          selectedToken = null;
          const rect = wrap.getBoundingClientRect();
          ctxMenu.style.display='block';
          ctxMenu.style.left = (e.clientX - rect.left) + 'px';
          ctxMenu.style.top  = (e.clientY - rect.top)  + 'px';
        }
      });
      window.addEventListener('click', (e)=>{
        if (!ctxMenu.contains(e.target)) ctxMenu.style.display='none';
      });
      window.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape') ctxMenu.style.display='none';
        if (e.key === 'Delete' && selectedToken) {
          selectedToken.el.remove();
          tokens = tokens.filter(t => t !== selectedToken);
          selectedToken = null;
        }
      });
      ctxMenu.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        const act = e.target.dataset.act;
        ctxMenu.style.display = 'none';
        if (!selectedToken && act !== 'assign-submap') {
          if (act==='sheet' || act==='open-submap' || act==='delete') {
            alert('Right-click a token first.'); 
          }
          return;
        }
        if (act === 'delete') {
          selectedToken.el.remove();
          tokens = tokens.filter(t => t !== selectedToken);
          selectedToken = null;
        } else if (act === 'assign-submap') {
          if (!submaps.length) return alert('No submaps yet.');
          if (!selectedToken) return alert('Right-click a token first.');
          const choice = prompt(
            'Assign submap index:\n' +
            submaps.map((s,i)=>`${i}: ${s.name}`).join('\n')
          );
          const idx = Number(choice);
          if (Number.isInteger(idx) && submaps[idx]) {
            selectedToken.submap = idx;
            alert('Assigned: ' + submaps[idx].name);
          }
        } else if (act === 'open-submap') {
          const idx = selectedToken.submap;
          if (idx == null || !submaps[idx]) return alert('No submap assigned.');
          openSubmap(submaps[idx].img, submaps[idx].name);
        } else if (act === 'sheet') {
          if (selectedToken.sheetUrl) {
            window.open(selectedToken.sheetUrl, '_blank');
          } else {
            const url = prompt('Paste character sheet URL:');
            if (url) { selectedToken.sheetUrl = url; window.open(url, '_blank'); }
          }
        }
      });

      /* Submaps (HiDPI sizing) */
      const subOverlay = document.getElementById('submap-overlay');
      const subCanvas = document.getElementById('submap-canvas');
      const subCtx = subCanvas.getContext('2d');
      function openSubmap(imgSrc, title='Submap'){
        document.getElementById('submap-title').textContent = title;
        subOverlay.style.display = 'block';
        subOverlay.setAttribute('aria-hidden','false');

        const img = new Image();
        img.onload = ()=>{
          requestAnimationFrame(()=>{
            const dpr = window.devicePixelRatio || 1;
            const w = subCanvas.clientWidth || 1;
            const h = subCanvas.clientHeight || 1;

            subCanvas.width = Math.floor(w * dpr);
            subCanvas.height = Math.floor(h * dpr);
            subCtx.setTransform(dpr, 0, 0, dpr, 0, 0);

            const ratio = Math.max(w / img.width, h / img.height);
            const dw = img.width * ratio, dh = img.height * ratio;
            const dx = (w - dw) / 2, dy = (h - dh) / 2;
            subCtx.clearRect(0,0,w,h);
            subCtx.drawImage(img, dx, dy, dw, dh);
          });
        };
        img.src = imgSrc;
      }
      document.getElementById('close-submap').addEventListener('click', ()=>{
        subOverlay.style.display='none';
        subOverlay.setAttribute('aria-hidden','true');
      });
      subAddBtn.addEventListener('click', ()=>{
        const file = subFile.files?.[0];
        const name = subName.value.trim()||'Submap';
        if (!file) return alert('Choose an image');
        const r = new FileReader();
        r.onload = ev=>{
          submaps.push({name, img: ev.target.result});
          localStorage.setItem('warvault-submaps', JSON.stringify(submaps));
          renderSubmaps();
        };
        r.readAsDataURL(file);
      });
      function renderSubmaps(){
        subList.innerHTML='';
        submaps.forEach((s,i)=>{
          const row = document.createElement('div');
          row.className='map-item';
          row.innerHTML = `
            <div class="thumb" style="background-image:url('${s.img}')"></div>
            <div style="flex:1">
              <div>${s.name}</div>
            </div>
            <button class="btn" data-i="${i}" data-act="open">Open</button>
            <button class="btn" data-i="${i}" data-act="del">Delete</button>
          `;
          row.querySelector('[data-act="open"]').onclick = ()=> openSubmap(s.img, s.name);
          row.querySelector('[data-act="del"]').onclick = ()=>{
            submaps.splice(i,1);
            localStorage.setItem('warvault-submaps', JSON.stringify(submaps));
            renderSubmaps();
          };
          subList.appendChild(row);
        });
      }
      renderSubmaps();

      /* Saved maps (local) */
      function renderSavedMaps(){
        savedMapsDiv.innerHTML='';
        if (!savedMaps.length){
          savedMapsDiv.innerHTML='<div class="sub">No local saves yet.</div>';
          return;
        }
        savedMaps.slice().reverse().forEach(m=>{
          const row = document.createElement('div');
          row.className='map-item';
          row.innerHTML = `
            <div class="thumb" style="background-image:url('${m.thumb||m.data}')"></div>
            <div style="flex:1">
              <div>${new Date(m.when).toLocaleString()}</div>
            </div>
            <button class="btn" data-act="load">Load</button>
          `;
          row.querySelector('[data-act="load"]').onclick = ()=>{
            // Force onload even if src is same by resetting first
            const src = m.data;
            mapEl.onload = ()=> fitCanvases();
            if (mapEl.src === src) {
              mapEl.src = '';
              setTimeout(()=> mapEl.src = src, 0);
            } else {
              mapEl.src = src;
            }
          };
          savedMapsDiv.appendChild(row);
        });
      }
      renderSavedMaps();

      saveMapBtn.addEventListener('click', ()=>{
        try{
          const w = mapEl.naturalWidth||mapEl.width;
          const h = mapEl.naturalHeight||mapEl.height;
          if (!w || !h) return alert('No map to save');
          const entry = {when: Date.now(), data: mapEl.src, thumb: mapEl.src};
          savedMaps.push(entry);
          localStorage.setItem('warvault-maps', JSON.stringify(savedMaps));
          renderSavedMaps();
          alert('Saved locally.');
        }catch{ /* ignore */ }
      });

      /* Initiative */
      function renderInit(){
        initList.innerHTML='';
        initiative.forEach((it,idx)=>{
          const row = document.createElement('div');
          row.style.display='flex';
          row.style.gap='.5rem';
          row.style.alignItems='center';
          row.innerHTML = `
            <div style="width:28px;text-align:right;color:${idx===initIdx?'#0f0':'#aaa'}">${idx===initIdx?'‚ñ∂':''}</div>
            <div style="flex:1">${it.name}</div>
            <div style="width:40px;text-align:right">${it.roll}</div>
            <button class="btn" data-i="${idx}">‚úï</button>
          `;
          row.querySelector('button').onclick = ()=>{
            initiative.splice(idx,1);
            if (initIdx >= initiative.length) initIdx = initiative.length-1;
            renderInit();
          };
          initList.appendChild(row);
        });
      }
      initAdd.onclick = ()=>{
        const name = initName.value.trim();
        const roll = parseInt(initRoll.value,10);
        if (!name || !Number.isFinite(roll)) return;
        initiative.push({name, roll});
        initiative.sort((a,b)=>b.roll-a.roll);
        initName.value=''; initRoll.value='';
        if (initIdx===-1) initIdx=0;
        renderInit();
      };
      initNext.onclick = ()=>{
        if (!initiative.length) return;
        initIdx = (initIdx+1)%initiative.length;
        renderInit();
      };
      initReset.onclick = ()=>{
        initiative=[]; initIdx=-1; renderInit();
      };

      /* Omniverse Connect / Generate / Library */
      function logOv(msg) {
        ovConsole.innerHTML += `<div>${new Date().toLocaleTimeString()} ‚Äî ${msg}</div>`;
        ovConsole.scrollTop = ovConsole.scrollHeight;
      }
      ovHelpBtn.onclick = () => {
        ovHelp.style.display = ovHelp.style.display === 'block' ? 'none' : 'block';
      };
      document.addEventListener('click', (e) => {
        if (!ovHelp.contains(e.target) && e.target !== ovHelpBtn) {
          ovHelp.style.display = 'none';
        }
      });

      ovConnect.onclick = ()=>{
        if (!ovUrl.value || !ovUsd.value) return alert("Fill URL and USD path");
        ensureWS();
        if (ws?.readyState === WebSocket.OPEN){
          ws.send(JSON.stringify({ action: 'connect', url: ovUrl.value, usd: ovUsd.value }));
          logOv("Requested connection");
        } else {
          logOv("Connecting‚Ä¶");
        }
      };
      ovGenerate.onclick = ()=>{
        ensureWS();
        if (ws?.readyState === WebSocket.OPEN){
          ws.send(JSON.stringify({ action:'generate', res: ovRes.value, format: ovFormat.value }));
          logOv("Generating map in Omniverse...");
        } else {
          logOv("Bridge not connected");
        }
      };
      ovRefresh.onclick = ()=>{
        ensureWS();
        if (ws?.readyState === WebSocket.OPEN){
          ws.send(JSON.stringify({ action:'last' }));
          logOv("Fetching last render‚Ä¶");
        }
      };
      ovOpenLibrary.onclick = ()=>{
        openRenders();
        ensureWS();
        if (ws?.readyState === WebSocket.OPEN){
          ws.send(JSON.stringify({ action:'list' }));
          logOv("Listing renders‚Ä¶");
        }
      };

      /* Previous Renders modal */
      function openRenders(){ rendersModal.style.display='flex'; }
      function closeRenders(){ rendersModal.style.display='none'; }
      openRendersBtn.onclick = ()=>{
        openRenders();
        ensureWS();
        if (ws?.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ action:'list' }));
      };
      rendersClose.onclick = closeRenders;
      rendersModal.addEventListener('click', (e)=>{ if (e.target===rendersModal) closeRenders(); });

      function buildLibrary(items){
        rlGrid.innerHTML = '';
        if (!items.length){
          rlGrid.innerHTML = '<div class="sub">No renders found. Click ‚ÄúGenerate Map‚Äù first.</div>';
          return;
        }
        items.sort((a,b)=>(b.mtime||'').localeCompare(a.mtime||''));
        items.forEach(it=>{
          const card = document.createElement('div');
          card.className = 'rl-card';
          const thumb = it.thumb || '';
          const when = it.mtime ? new Date(it.mtime).toLocaleString() : '';
          card.innerHTML = `
            <div class="rl-shot" style="background-image:url('${thumb}')"></div>
            <div class="rl-meta">
              <div style="color:#fff">${it.name || 'Render'}</div>
              <div style="color:#c9b27a">${when}</div>
            </div>
            <div class="rl-actions">
              <button class="btn" data-act="load">Load</button>
              <button class="btn" data-act="copy">Copy Name</button>
            </div>`;
          card.querySelector('[data-act="load"]').onclick = ()=>{
            ensureWS();
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ action:'get', name: it.name }));
            logOv('Loading ' + it.name);
            closeRenders();
          };
          card.querySelector('[data-act="copy"]').onclick = ()=>{
            navigator.clipboard.writeText(it.name).then(()=>logOv('Name copied.'));
          };
          rlGrid.appendChild(card);
        });
      }

      /* Init */
      setTool('pan');
    };
  </script>
</body>
</html>
