<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Echo Vault | Character Walkthrough & Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet" />
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root { --primary:#e6c57f; --accent:#b88c5c; --light:#eee; --panel:#14131a; --ink:#ddd; --mist:rgba(0,0,0,.55); }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Rajdhani',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',sans-serif;background:#000 url('https://i.imgur.com/8V7V3sP.jpg') no-repeat center/cover;color:var(--ink);}
    .vault-header{padding:1.2rem 1.6rem;border-bottom:1px solid var(--accent);background:rgba(10,10,14,.8);backdrop-filter:blur(8px);}
    .vault-title{font-family:'Cinzel',serif;color:var(--primary);margin:0;font-size:2.1rem;text-shadow:0 0 10px rgba(230,197,127,.4)}
    .subtitle{margin:.2rem 0 0;color:var(--light);opacity:.9}

    /* Wizard */
    .wizard{max-width:1100px;margin:0 auto;padding:1rem}
    .steps{display:flex;gap:.4rem;flex-wrap:wrap;margin:1rem 0}
    .step{flex:1 1 120px;text-align:center;padding:.4rem .6rem;border:1px solid rgba(184,140,92,.35);border-radius:999px;color:var(--light);opacity:.7}
    .step.active{background:rgba(184,140,92,.2);opacity:1;color:var(--primary)}
    .card{background:rgba(20,20,30,.6);border:1px solid rgba(184,140,92,.35);border-radius:14px;padding:1rem}

    .grid{display:grid;gap:1rem}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-3,.grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid.cols-2,.grid.cols-3,.grid.cols-4{grid-template-columns:1fr}}

    .choice{position:relative;border:1px solid rgba(184,140,92,.35);border-radius:12px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(0,0,0,.3));cursor:pointer;transition:transform .15s ease, box-shadow .15s ease}
    .choice:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(0,0,0,.35)}
    .choice.selected{outline:2px solid var(--primary);}
    .choice-img{height:120px;display:grid;place-items:center;font-size:56px}
    .choice-body{padding:.6rem}
    .choice-title{color:var(--primary);font-weight:700;font-size:1.1rem}
    .choice-sub{color:var(--light);opacity:.85;font-size:.95rem}

    label{color:var(--primary)}
    input,select,textarea{background:#1c1b24;border:1px solid var(--accent);color:var(--light);padding:.55rem;border-radius:8px;font-family:inherit}
    input:focus-visible,select:focus-visible,textarea:focus-visible,button:focus-visible{outline:2px solid var(--primary);outline-offset:2px}

    .actions{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:flex-end;margin-top:1rem}
    .btn{border:1px solid var(--accent);background:rgba(184,140,92,.12);color:var(--primary);padding:.7rem 1.1rem;border-radius:10px;cursor:pointer}
    .btn:hover{background:rgba(184,140,92,.2)}
    .btn-primary{background:var(--accent);color:#000;border-color:var(--accent)}

    /* Tooltips */
    .tooltip{position:fixed;max-width:320px;background:#111a;border:1px solid var(--accent);color:var(--light);padding:.6rem .7rem;border-radius:8px;backdrop-filter:blur(6px);box-shadow:0 6px 18px rgba(0,0,0,.4);z-index:9999;opacity:0;transform:translateY(4px);transition:opacity .12s ease, transform .12s ease;pointer-events:none}
    .tooltip.show{opacity:1;transform:translateY(0)}

    /* Model */
    .model-vault{margin:1rem auto;width:100%;max-width:520px;aspect-ratio:1/1;position:relative}
    #echo-model{width:100%;height:100%;border-radius:16px;box-shadow:0 0 30px rgba(230,197,127,.3);background:rgba(0,0,0,.3)}
    .model-status{position:absolute;inset:auto 0 8px 0;color:var(--light);font-size:.9rem;text-shadow:0 1px 2px #000}

    /* Character sheet */
    .sheet{display:none;margin:1rem 0}
    .sheet.show{display:block}
    .sheet-wrap{display:grid;grid-template-columns:280px 1fr;gap:1rem}
    @media (max-width:900px){.sheet-wrap{grid-template-columns:1fr}}
    .sheet-card{background:rgba(15,15,20,.7);border:1px solid rgba(184,140,92,.35);border-radius:12px;padding:1rem}
    .sheet-header{display:flex;gap:1rem;align-items:center}
    .avatar{width:72px;height:72px;border-radius:12px;background:linear-gradient(135deg, rgba(230,197,127,.35), rgba(0,0,0,.6));display:grid;place-items:center;font-size:42px}
    .h-big{font-size:1.4rem;color:var(--primary);margin:0}
    .muted{opacity:.9}

    .ability{display:grid;grid-template-columns:1fr auto;gap:.2rem;padding:.4rem .6rem;margin:.25rem 0;border:1px solid rgba(184,140,92,.2);border-radius:10px}
    .ability .score{font-size:1.2rem;color:var(--primary)}
    .ability .mod{opacity:.95}

    .skills-table{width:100%;border-collapse:collapse}
    .skills-table th,.skills-table td{border-bottom:1px solid rgba(184,140,92,.2);padding:.35rem .4rem;text-align:left}

    .sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>
  <header class="vault-header">
    <h1 class="vault-title">Echo Vault</h1>
    <p class="subtitle">"Speak the name. Recall the soul."</p>
  </header>

  <main class="wizard">
    <!-- Step indicator -->
    <div class="steps" id="steps"></div>

    <!-- STEP 1: Identity -->
    <section class="card" data-step="1" data-title="Identity">
      <div class="grid cols-2">
        <div>
          <label for="char-name" data-help="Your character's given name or chosen alias.">Name</label>
          <input id="char-name" placeholder="e.g. Kael" autocomplete="off" />
        </div>
        <div>
          <label for="char-title" data-help="A sobriquet or honorific. Purely narrative.">Title</label>
          <input id="char-title" placeholder="e.g. Oathbreaker" autocomplete="off" />
        </div>
      </div>
    </section>

    <!-- STEP 2: Choose Race (with pictures & hover help) -->
    <section class="card" data-step="2" data-title="Race">
      <div class="grid cols-4" id="race-grid"></div>
    </section>

    <!-- STEP 3: Choose Class (with pictures & hover help) -->
    <section class="card" data-step="3" data-title="Class">
      <div class="grid cols-4" id="class-grid"></div>
    </section>

    <!-- STEP 4: Level & Abilities -->
    <section class="card" data-step="4" data-title="Abilities">
      <div class="grid cols-3">
        <div>
          <label for="level" data-help="Character level (1–20). Affects proficiency bonus.">Level</label>
          <input id="level" type="number" min="1" max="20" value="1" />
        </div>
        <div>
          <label data-help="Your proficiency bonus—added to trained skills & saves.">Proficiency Bonus</label>
          <input id="prof-bonus" value="+2" disabled />
        </div>
        <div>
          <label data-help="Quick assign the standard array: 15, 14, 13, 12, 10, 8">Standard Array</label>
          <button class="btn" id="btn-std-array" type="button">Apply</button>
        </div>
      </div>
      <div class="grid cols-3" style="margin-top:.8rem">
        <div><label data-help="Raw physical power.">STR</label><input id="str" type="number" min="1" max="30" value="10" /></div>
        <div><label data-help="Agility and reflexes.">DEX</label><input id="dex" type="number" min="1" max="30" value="10" /></div>
        <div><label data-help="Vitality and toughness.">CON</label><input id="con" type="number" min="1" max="30" value="10" /></div>
        <div><label data-help="Reason and memory.">INT</label><input id="int" type="number" min="1" max="30" value="10" /></div>
        <div><label data-help="Perception & willpower.">WIS</label><input id="wis" type="number" min="1" max="30" value="10" /></div>
        <div><label data-help="Presence & charm.">CHA</label><input id="cha" type="number" min="1" max="30" value="10" /></div>
      </div>
    </section>

    <!-- STEP 5: Skills & Saves -->
    <section class="card" data-step="5" data-title="Skills & Saves">
      <div class="grid cols-2">
        <div>
          <h3 class="h-big" style="margin:.2rem 0">Saving Throws</h3>
          <div id="saves"></div>
        </div>
        <div>
          <h3 class="h-big" style="margin:.2rem 0">Skills</h3>
          <table class="skills-table" id="skills-table"></table>
        </div>
      </div>
    </section>

    <!-- STEP 6: Backstory & Voice -->
    <section class="card" data-step="6" data-title="Backstory & Voice">
      <div class="grid cols-2">
        <div>
          <label for="backstory" data-help="A paragraph about their past and motivations.">Backstory</label>
          <textarea id="backstory" rows="6" placeholder="They swore to protect the city... then burned it."></textarea>
        </div>
        <div>
          <div class="model-vault">
            <model-viewer id="echo-model" alt="Echo of the Hero" auto-rotate camera-controls shadow-intensity="1" exposure="1.2" autoplay></model-viewer>
            <div class="model-status" id="model-status" aria-live="polite"></div>
          </div>
          <div class="actions">
            <button id="mic-btn" class="btn btn-primary" type="button" aria-pressed="false" data-help="Record a line in your character's voice (browser support required).">🎤 Record Voice</button>
            <button id="save-echo" class="btn" type="button">💾 Etch to Vault</button>
          </div>
          <div id="speech-output" class="card" style="margin-top:.6rem;display:none" role="status" aria-live="polite"></div>
        </div>
      </div>
    </section>

    <!-- STEP 7: Review & Generate Sheet -->
    <section class="card" data-step="7" data-title="Review">
      <p class="muted">Review choices, then generate a full character sheet.</p>
      <div class="actions">
        <button id="btn-generate" class="btn btn-primary" type="button">📜 Generate Sheet</button>
        <button id="export-last" class="btn" type="button">⬇️ Export Character JSON</button>
        <label class="btn" for="import-file">📤 Import JSON</label>
        <input id="import-file" type="file" accept="application/json" style="display:none" />
      </div>
    </section>

    <!-- Sheet output -->
    <section class="sheet" id="sheet">
      <div class="sheet-wrap">
        <aside class="sheet-card">
          <div class="sheet-header">
            <div class="avatar" id="avatar">👤</div>
            <div>
              <h2 class="h-big" id="sheet-name">Character</h2>
              <div class="muted" id="sheet-sub">Class • Race • Level</div>
            </div>
          </div>
          <h3 class="h-big" style="margin:.8rem 0 .4rem">Abilities</h3>
          <div id="sheet-abilities"></div>
          <h3 class="h-big" style="margin:.8rem 0 .4rem">Saving Throws</h3>
          <div id="sheet-saves"></div>
        </aside>
        <section class="sheet-card">
          <div class="grid cols-3">
            <div>
              <label>Armor Class</label>
              <div class="ability"><span>AC</span><span class="score" id="sheet-ac">10</span></div>
            </div>
            <div>
              <label>Hit Points</label>
              <div class="ability"><span>HP</span><span class="score" id="sheet-hp">8</span></div>
            </div>
            <div>
              <label>Initiative</label>
              <div class="ability"><span>INIT</span><span class="score" id="sheet-init">+0</span></div>
            </div>
          </div>

          <h3 class="h-big" style="margin:.8rem 0 .4rem">Skills</h3>
          <table class="skills-table" id="sheet-skills"></table>

          <h3 class="h-big" style="margin:.8rem 0 .4rem">Features</h3>
          <ul id="sheet-features"></ul>

          <h3 class="h-big" style="margin:.8rem 0 .4rem">Backstory</h3>
          <div id="sheet-backstory" class="muted"></div>
        </section>
      </div>
    </section>

    <div class="actions">
      <button class="btn" id="prev">← Back</button>
      <button class="btn btn-primary" id="next">Next →</button>
    </div>
  </main>

  <div id="tooltip" class="tooltip" role="tooltip" aria-hidden="true"></div>

  <script>
    // ===== Data =====
    const RACES = [
      { id:'human',   name:'Human',   icon:'👤', help:'Adaptable and ambitious; no ability penalties.' },
      { id:'elf',     name:'Elf',     icon:'🧝', help:'Graceful and keen-sighted; often favor DEX/INT builds.' },
      { id:'dwarf',   name:'Dwarf',   icon:'🧔', help:'Stout and hardy; excellent CON and resilience.' },
      { id:'tiefling',name:'Tiefling',icon:'😈', help:'Fiend-touched; often clever or charismatic.' }
    ];
    const CLASSES = [
      { id:'fighter', name:'Fighter', icon:'⚔️', help:'Martial expert; strong AC/HP; straightforward frontline.' },
      { id:'wizard',  name:'Wizard',  icon:'🧙', help:'Arcane scholar; fragile but versatile spellcaster.' },
      { id:'cleric',  name:'Cleric',  icon:'⛪', help:'Divine magic and armor; great support and durability.' },
      { id:'rogue',   name:'Rogue',   icon:'🗡️', help:'Skilled and sneaky; excels at precision and skills.' }
    ];
    const CLASS_FEATURES = {
      fighter:['Second Wind','Action Surge (later levels)'],
      wizard:['Spellcasting','Arcane Recovery'],
      cleric:['Spellcasting','Channel Divinity (later levels)'],
      rogue:['Sneak Attack','Cunning Action (later levels)']
    };
    const SKILLS = [
      ['Acrobatics','dex'],['Animal Handling','wis'],['Arcana','int'],['Athletics','str'],
      ['Deception','cha'],['History','int'],['Insight','wis'],['Intimidation','cha'],
      ['Investigation','int'],['Medicine','wis'],['Nature','int'],['Perception','wis'],
      ['Performance','cha'],['Persuasion','cha'],['Religion','int'],['Sleight of Hand','dex'],
      ['Stealth','dex'],['Survival','wis']
    ];

    // ===== Helpers =====
    const $ = (id)=>document.getElementById(id);
    const qs = (s,root=document)=>root.querySelector(s);
    const qsa = (s,root=document)=>[...root.querySelectorAll(s)];
    function mod(score){ return Math.floor((score-10)/2); }
    function profBonus(level){ if(level>=17) return 6; if(level>=13) return 5; if(level>=9) return 4; if(level>=5) return 3; return 2; }
    function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }

    // ===== Tooltip (shows after 1s hover) =====
    const tip = $('tooltip');
    let tipTimer=null, tipTarget=null;
    function showTip(target){ const text = target.getAttribute('data-help'); if(!text) return; tip.textContent = text; tip.classList.add('show'); tip.setAttribute('aria-hidden','false'); const r = target.getBoundingClientRect(); const y = Math.max(8, r.bottom + 8); const x = clamp(r.left, 8, window.innerWidth-328); tip.style.top = y+'px'; tip.style.left = x+'px'; }
    function hideTip(){ tip.classList.remove('show'); tip.setAttribute('aria-hidden','true'); }
    document.addEventListener('mouseover', (e)=>{
      const t = e.target.closest('[data-help]');
      if(!t) { clearTimeout(tipTimer); hideTip(); return; }
      clearTimeout(tipTimer); tipTimer = setTimeout(()=>{ tipTarget=t; showTip(t); }, 1000);
    });
    document.addEventListener('mouseout', (e)=>{ if(e.relatedTarget && (e.relatedTarget.closest && e.relatedTarget.closest('[data-help]')===tipTarget)) return; clearTimeout(tipTimer); hideTip(); tipTarget=null; });
    document.addEventListener('focusin', (e)=>{ const t=e.target.closest('[data-help]'); if(t) { clearTimeout(tipTimer); tipTimer=setTimeout(()=>showTip(t), 1000);} });
    document.addEventListener('focusout', ()=>{ clearTimeout(tipTimer); hideTip(); });

    // ===== Build Race/Class galleries =====
    function makeChoiceCard(item, group){
      const el = document.createElement('div'); el.className='choice'; el.setAttribute('role','radio'); el.setAttribute('aria-checked','false'); el.dataset.value=item.id; el.dataset.group=group; el.setAttribute('data-help', item.help);
      el.innerHTML = `<div class="choice-img">${item.icon}</div><div class="choice-body"><div class="choice-title">${item.name}</div><div class="choice-sub">${item.help}</div></div>`;
      el.addEventListener('click', ()=> selectChoice(group, item.id, el));
      return el;
    }
    function selectChoice(group, id, el){
      qsa(`.choice[data-group="${group}"]`).forEach(c=>{ c.classList.toggle('selected', c.dataset.value===id); c.setAttribute('aria-checked', c.dataset.value===id ? 'true':'false'); });
      state[group] = id; if(group==='race' || group==='class') updateModel(); updateDerived();
    }

    // ===== State =====
    const state = { name:'', title:'', race:'human', class:'fighter', level:1, scores:{str:10,dex:10,con:10,int:10,wis:10,cha:10}, profs:{}, saves:{}, backstory:'', voice:'', modelSrc:'' };

    // ===== Steps / Wizard =====
    let step=1; const maxStep=7;
    function renderSteps(){ const wrap=$('steps'); wrap.innerHTML=''; for(let i=1;i<=maxStep;i++){ const d=document.createElement('div'); d.className='step'+(i===step?' active':''); d.textContent = `${i}. ${qs(`[data-step="${i}"]`).dataset.title}`; wrap.appendChild(d);} }
    function showStep(){ qsa('[data-step]').forEach(s=>{ s.style.display = (Number(s.dataset.step)===step?'block':'none'); }); renderSteps(); $('prev').disabled = step===1; $('next').disabled = step===maxStep; }

    // ===== Abilities / Saves / Skills =====
    function readScores(){ const ids=['str','dex','con','int','wis','cha']; ids.forEach(id=>{ const v = parseInt($(id).value,10); state.scores[id]= Number.isFinite(v)? v:10; }); }
    function updateProf(){ const lvl = clamp(parseInt($('level').value,10)||1,1,20); state.level=lvl; $('level').value = lvl; $('prof-bonus').value = `+${profBonus(lvl)}`; }
    function updateDerived(){ readScores(); updateProf(); const dexMod = mod(state.scores.dex); const conMod = mod(state.scores.con);
      // Simple base values
      const baseHP = {fighter:10, cleric:8, rogue:8, wizard:6}[state.class] || 8;
      state.ac = 10 + dexMod; state.hp = baseHP + conMod; state.init = (dexMod>=0?`+${dexMod}`:`${dexMod}`);
    }

    function buildSaves(){ const wrap=$('saves'); wrap.innerHTML=''; const list=['str','dex','con','int','wis','cha'];
      const classSaveProfs = { fighter:['str','con'], wizard:['int','wis'], cleric:['wis','cha'], rogue:['dex','int'] }[state.class] || [];
      list.forEach(ab=>{
        const row=document.createElement('div'); row.className='ability'; row.setAttribute('data-help',`Saving throw using ${ab.toUpperCase()}. Check the box if proficient.`);
        const left=document.createElement('div'); left.innerHTML = `${ab.toUpperCase()} Save`;
        const right=document.createElement('div');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.checked = !!state.saves[ab] || classSaveProfs.includes(ab);
        cb.addEventListener('change',()=>{ state.saves[ab]=cb.checked; renderSaves(); }); right.appendChild(cb);
        row.appendChild(left); row.appendChild(right); wrap.appendChild(row);
      });
      renderSaves();
    }
    function renderSaves(){ const rows = qsa('#saves .ability'); rows.forEach(row=>{
      const ab = row.textContent.trim().slice(0,3).toLowerCase(); // 'STR Save' -> 'str'
      const isProf = row.querySelector('input').checked; const bonus = mod(state.scores[ab]) + (isProf? profBonus(state.level):0);
      let badge = row.querySelector('.mod'); if(!badge){ badge=document.createElement('div'); badge.className='mod'; row.appendChild(badge); }
      badge.textContent = (bonus>=0?`+${bonus}`:`${bonus}`);
    }); }

    function buildSkills(){ const t=$('skills-table'); t.innerHTML = '<tr><th>Skill</th><th>Ability</th><th>Prof</th><th>Bonus</th></tr>';
      SKILLS.forEach(([name,ab])=>{
        const tr=document.createElement('tr'); tr.setAttribute('data-help',`${name}: ${ab.toUpperCase()}-based. Check Prof if trained.`);
        const td1=document.createElement('td'); td1.textContent=name; const td2=document.createElement('td'); td2.textContent=ab.toUpperCase();
        const td3=document.createElement('td'); const cb=document.createElement('input'); cb.type='checkbox'; cb.checked = !!state.profs[name]; cb.addEventListener('change',()=>{ state.profs[name]=cb.checked; renderSkills(); }); td3.appendChild(cb);
        const td4=document.createElement('td'); td4.className='bonus';
        tr.append(td1,td2,td3,td4); t.appendChild(tr);
      });
      renderSkills();
    }
    function renderSkills(){ qsa('#skills-table tr').slice(1).forEach(tr=>{
      const name = tr.children[0].textContent; const ab = tr.children[1].textContent.toLowerCase(); const isProf = tr.querySelector('input').checked;
      const bonus = mod(state.scores[ab]) + (isProf? profBonus(state.level):0);
      tr.querySelector('.bonus').textContent = bonus>=0?`+${bonus}`:`${bonus}`;
    }); }

    // ===== Model selection & UX =====
    function modelSrc(){
      const variants=['','2','3']; const rv=variants[Math.floor(Math.random()*variants.length)];
      const map={
        'tiefling-wizard':'https://opengameart.org/sites/default/files/DemonWizardCharacterGLB.glb',
        'elf-rogue':'https://opengameart.org/sites/default/files/ElvenRogueCharacterGLB.glb',
        'dwarf-fighter':'https://opengameart.org/sites/default/files/DwarfFighterCharacterGLB.glb',
        'tiefling':`https://opengameart.org/sites/default/files/DemonCharacterGLB${rv}.glb`,
        'elf':`https://opengameart.org/sites/default/files/ElvenArcherCharacterGLB${rv}.glb`,
        'dwarf':`https://opengameart.org/sites/default/files/DwarfCharacterGLB${rv}.glb`,
        'wizard':`https://opengameart.org/sites/default/files/WizardCharacterGLB${rv}.glb`,
        'fighter':`https://opengameart.org/sites/default/files/FighterCharacterGLB${rv}.glb`,
        'human':'https://modelviewer.dev/shared-assets/models/Astronaut.glb'
      };
      const key = map[`${state.race}-${state.class}`] ? `${state.race}-${state.class}` : (map[state.class] ? state.class : state.race);
      return map[key] || map['human'];
    }
    function updateModel(){ const mv=$('echo-model'); const st=$('model-status'); st.textContent='Loading model…'; mv.addEventListener('load',()=>{st.textContent='';},{once:true}); mv.addEventListener('error',()=>{st.textContent='Model failed to load.'},{once:true}); mv.src = modelSrc(); state.modelSrc = mv.src; }

    // ===== Voice =====
    function recordVoice(){ const btn=$('mic-btn'); const out=$('speech-output'); const SR = window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){ btn.textContent='❌ Voice not supported'; return; }
      const sr = new SR(); sr.lang='en-US'; btn.textContent='🔊 Listening…'; btn.setAttribute('aria-pressed','true');
      try{ sr.start(); }catch{}
      sr.onresult=(e)=>{ const t=e.results[0][0].transcript; out.style.display='block'; out.textContent='"'+t+'"'; state.voice = out.textContent; btn.textContent='✅ Recorded'; btn.setAttribute('aria-pressed','false'); const u=new SpeechSynthesisUtterance(t); u.rate=.9; u.pitch=.95; speechSynthesis.speak(u); };
      sr.onerror=()=>{ btn.textContent='❌ Error'; btn.setAttribute('aria-pressed','false'); };
      sr.onend=()=>{ if(btn.textContent.includes('Listening')) { btn.textContent='🎤 Record Voice'; btn.setAttribute('aria-pressed','false'); } };
    }

    // ===== Vault & Export =====
    function collect(){ return {
      schemaVersion:1,
      id: crypto.randomUUID(),
      name: $('char-name').value.trim()||'Unknown',
      title: $('char-title').value.trim(),
      race: state.race,
      class: state.class,
      level: state.level,
      backstory: $('backstory').value.trim(),
      voice: state.voice||'',
      abilities: {...state.scores},
      derived: { ac: state.ac, hp: state.hp, init: state.init, profBonus: profBonus(state.level) },
      skills: Object.fromEntries(SKILLS.map(([n,ab])=>[n,{ ability:ab, proficient: !!state.profs[n] }])),
      saves: {...state.saves},
      modelSrc: state.modelSrc,
      updatedAt: new Date().toISOString()
    }; }
    function loadVault(){ try{ return JSON.parse(localStorage.getItem('echo-vault'))||[] }catch{ return [] } }
    function storeVault(v){ try{ localStorage.setItem('echo-vault', JSON.stringify(v.slice(-100))); }catch{}}
    function saveEcho(){ const v=loadVault(); v.push(collect()); storeVault(v); alert('💾 Etched to Vault.'); }
    function exportLast(){ const v=collect(); const blob=new Blob([JSON.stringify(v,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); const safe=(v.name||'character').toLowerCase().replace(/[^a-z0-9]+/g,'-'); a.download=`${safe}.character.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),800); }
    function importJSON(file){ const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); const v=loadVault(); v.push(data); storeVault(v); alert('Imported.'); }catch{ alert('Invalid JSON'); } }; r.readAsText(file); }

    // ===== Sheet =====
    function abilityBlock(ab,label){ const s=state.scores[ab]; const m=mod(s); return `<div class="ability" data-help="${label} (${ab.toUpperCase()}) score and modifier."><span>${label}</span><span class="score">${s} (${m>=0?'+':''}${m})</span></div>`; }
    function renderSheet(data){ $('sheet-name').textContent = data.name + (data.title? ' — '+data.title:''); $('sheet-sub').textContent = `${capitalize(data.class)} • ${capitalize(data.race)} • Level ${data.level}`; $('avatar').textContent = (RACES.find(r=>r.id===data.race)?.icon)||'👤';
      $('sheet-abilities').innerHTML = abilityBlock('str','Strength') + abilityBlock('dex','Dexterity') + abilityBlock('con','Constitution') + abilityBlock('int','Intelligence') + abilityBlock('wis','Wisdom') + abilityBlock('cha','Charisma');
      $('sheet-ac').textContent=data.derived.ac; $('sheet-hp').textContent=data.derived.hp; $('sheet-init').textContent=data.derived.init;
      // Saves
      const savesHTML = ['str','dex','con','int','wis','cha'].map(ab=>{ const isProf = !!data.saves[ab]; const bonus = mod(data.abilities[ab]) + (isProf? data.derived.profBonus:0); return `<div class="ability"><span>${ab.toUpperCase()} Save ${isProf?'⭐':''}</span><span class="mod">${bonus>=0?'+':''}${bonus}</span></div>`; }).join('');
      $('sheet-saves').innerHTML = savesHTML;
      // Skills
      const rows = SKILLS.map(([n,ab])=>{ const isProf = !!data.skills[n]?.proficient; const bonus = mod(data.abilities[ab]) + (isProf? data.derived.profBonus:0); return `<tr><td>${n}${isProf?' ⭐':''}</td><td>${ab.toUpperCase()}</td><td>${bonus>=0?'+':''}${bonus}</td></tr>`; }).join('');
      $('sheet-skills').innerHTML = `<tr><th>Skill</th><th>Ability</th><th>Bonus</th></tr>${rows}`;
      // Features
      const feats = CLASS_FEATURES[data.class]||[]; $('sheet-features').innerHTML = feats.map(f=>`<li>${f}</li>`).join('') || '<li>—</li>';
      $('sheet-backstory').textContent = data.backstory || '—';
      $('sheet').classList.add('show');
      window.scrollTo({ top: $('sheet').offsetTop-20, behavior:'smooth' });
    }

    function capitalize(s){ return s? s[0].toUpperCase()+s.slice(1):'' }

    // ===== Wiring =====
    function wire(){
      // Build race/class grids
      const rg=$('race-grid'); RACES.forEach(r=>rg.appendChild(makeChoiceCard(r,'race'))); selectChoice('race','human', rg.firstChild);
      const cg=$('class-grid'); CLASSES.forEach(c=>cg.appendChild(makeChoiceCard(c,'class'))); selectChoice('class','fighter', cg.firstChild);

      // Inputs
      qsa('#str,#dex,#con,#int,#wis,#cha,#level'.replace(/#/g,'#'),document); // no-op to keep linter quiet
      ['str','dex','con','int','wis','cha'].forEach(id=> $(id).addEventListener('input', ()=>{ updateDerived(); renderSkills(); renderSaves(); }));
      $('level').addEventListener('input', ()=>{ updateDerived(); renderSkills(); renderSaves(); });
      $('btn-std-array').addEventListener('click', ()=>{ const arr=[15,14,13,12,10,8]; ['str','dex','con','int','wis','cha'].forEach((id,i)=>$(id).value=arr[i]); updateDerived(); renderSkills(); renderSaves(); });

      // Voice & Save & Export
      $('mic-btn').addEventListener('click', recordVoice);
      $('save-echo').addEventListener('click', saveEcho);
      $('export-last').addEventListener('click', exportLast);
      $('import-file').addEventListener('change', (e)=>{ if(e.target.files[0]) importJSON(e.target.files[0]); e.target.value=''; });

      // Skills & Saves builders
      buildSaves(); buildSkills(); updateProf(); updateDerived(); updateModel();

      // Wizard nav
      $('prev').addEventListener('click', ()=>{ step = Math.max(1, step-1); showStep(); });
      $('next').addEventListener('click', ()=>{ step = Math.min(maxStep, step+1); showStep(); });
      showStep();

      // Generate sheet
      $('btn-generate').addEventListener('click', ()=>{ const data = collect(); renderSheet(data); });
    }

    window.addEventListener('load', wire);
  </script>
</body>
</html>
