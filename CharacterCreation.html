<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Forge of Heroes — Creator + Vault + Images + Battle Map</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet"/>
<style>
  :root{
    --bg:#000;--panel:#0a0a0a;--card:#0d0d0d;--ink:#eaeaea;--muted:#b9b9b9;--line:#222;
    --accent:#d34b4b;--accent-weak:#b53e3e;--green:#26a269;--amber:#e6a700
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:'Rajdhani',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',sans-serif;background:var(--bg);color:var(--ink)}
  a{color:var(--accent)}
  .grid{display:grid}

  header{position:sticky;top:0;z-index:60;background:var(--bg);border-bottom:1px solid var(--line)}
  .wrap{max-width:1280px;margin:0 auto;padding:16px}
  h1{font-family:'Cinzel',serif;color:var(--ink);margin:0 0 2px;font-weight:900;letter-spacing:.5px}
  .sub{color:var(--muted);margin:0}

  .header-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .top-steps{display:flex;gap:12px;align-items:center;margin-top:10px;flex-wrap:wrap}
  .top-step{position:relative;display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:999px;color:var(--muted);background:var(--panel)}
  .top-step.active{color:#fff;border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}
  .dot{width:20px;height:20px;border-radius:999px;background:#111;border:1px solid var(--line);display:grid;place-items:center;font-size:12px;color:var(--muted)}
  .top-step.active .dot{background:var(--accent);border-color:var(--accent);color:#000;font-weight:800}

  .progress{height:6px;background:#0f0f0f;border:1px solid var(--line);border-radius:999px;overflow:hidden;margin-top:8px}
  .progress > span{display:block;height:100%;background:var(--accent);width:0%}

  main.wrap{display:grid;gap:16px;grid-template-columns:260px 1fr 320px}
  @media (max-width:1100px){ main.wrap{grid-template-columns:1fr} }
  aside.left{position:sticky;top:168px;align-self:start;height:max-content}

  .steps{display:flex;flex-direction:column;gap:8px}
  .step{padding:10px 12px;border:1px solid var(--line);border-radius:8px;background:var(--panel);color:var(--muted)}
  .step.active{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset;color:#fff}

  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}
  label{color:#fff;font-size:.95rem}
  input,textarea,select{width:100%;background:#0b0b0b;border:1px solid var(--line);color:var(--ink);border-radius:8px;padding:10px}
  input:focus-visible,textarea:focus-visible,button:focus-visible,select:focus-visible{outline:2px solid var(--accent);outline-offset:2px}

  .choices{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  @media (max-width:900px){.choices{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:560px){.choices{grid-template-columns:1fr}}
  .choice{border:1px solid var(--line);border-radius:10px;overflow:hidden;cursor:pointer;transition:transform .15s ease, box-shadow .15s ease, border-color .2s ease;background:var(--panel);position:relative}
  .choice:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(0,0,0,.45)}
  .choice.selected{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}
  .choice-img{height:140px;background-size:cover;background-position:center;filter:saturate(.9)}
  .choice-body{padding:12px}
  .choice-title{color:#fff;font-weight:800}
  .choice-sub{color:var(--muted)}
  .edit-img{position:absolute;right:8px;top:8px;border:1px solid var(--line);background:rgba(0,0,0,.6);color:#fff;padding:4px 6px;border-radius:6px;font-size:12px;cursor:pointer;opacity:0;transform:translateY(-2px);transition:opacity .15s,transform .15s}
  .choice:hover .edit-img,.choice:focus-within .edit-img{opacity:1;transform:translateY(0)}

  .cols-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  @media (max-width:740px){.cols-3{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:520px){.cols-3{grid-template-columns:1fr}}

  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left}
  th{color:#f1f1f1;font-weight:700}
  td{color:var(--ink)}

  .tooltip{position:fixed;max-width:360px;background:#050505;border:1px solid var(--line);color:#eee;padding:10px 12px;border-radius:8px;box-shadow:0 10px 26px rgba(0,0,0,.6);z-index:9999;opacity:0;transform:translateY(4px);transition:opacity .12s ease, transform .12s ease;pointer-events:none}
  .tooltip.show{opacity:1;transform:translateY(0)}

  .sheet{display:none}
  .sheet.show{display:block}
  .sheet-wrap{display:grid;grid-template-columns:300px 1fr;gap:16px}
  @media (max-width:980px){.sheet-wrap{grid-template-columns:1fr}}
  .ability{display:grid;grid-template-columns:1fr auto;gap:6px;padding:8px;border:1px solid var(--line);border-radius:10px;margin:4px 0;background:var(--panel)}
  .score{font-size:1.15rem;color:#fff}

  .summary-card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:12px}

  .nav-actions{position:sticky;bottom:0;background:linear-gradient(180deg, rgba(0,0,0,0), #000);padding-top:10px;margin-top:8px;display:flex;justify-content:space-between;gap:12px}
  .btn{border:1px solid var(--line);background:var(--panel);color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer}
  .btn:hover{border-color:#666}
  .btn-primary{background:var(--accent);border-color:var(--accent);color:#000;font-weight:800}
  .btn-ghost{background:transparent}

  @keyframes slideInRight{from{opacity:0;transform:translateX(32px)}to{opacity:1;transform:translateX(0)}}
  @keyframes slideOutLeft{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(-32px)}}
  @keyframes slideInLeft{from{opacity:0;transform:translateX(-32px)}to{opacity:1;transform:translateX(0)}}
  @keyframes slideOutRight{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(32px)}}
  .anim-enter-right{animation:slideInRight .28s ease both}
  .anim-leave-left{animation:slideOutLeft .28s ease both}
  .anim-enter-left{animation:slideInLeft .28s ease both}
  .anim-leave-right{animation:slideOutRight .28s ease both}
  @media (prefers-reduced-motion:reduce){.anim-enter-right,.anim-leave-left,.anim-enter-left,.anim-leave-right{animation:none}}

  footer{color:#8a8a8a;text-align:center;padding:18px 0;border-top:1px solid var(--line)}
  .tab{border:1px solid var(--line);background:var(--panel);color:#fff;padding:10px 12px;border-radius:8px;cursor:pointer}
  .tab.active{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset;color:#000;background:var(--accent);font-weight:900}
  .tabpanel table{margin-top:6px}

  /* Modal + Image Manager */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.6);z-index:10000}
  .modal.show{display:grid}
  .modal-card{width:min(760px,92vw);background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}
  .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
  .gallery .thumb{border:1px solid var(--line);border-radius:10px;overflow:hidden;height:110px;background:#111;display:grid;place-items:center;font-size:12px;color:var(--muted)}
  .gallery .thumb img{width:100%;height:100%;object-fit:cover}

  /* Battle Map */
  .map-wrap{display:grid;grid-template-columns:260px 1fr;gap:12px}
  @media (max-width:980px){.map-wrap{grid-template-columns:1fr}}
  .map-tools .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#0b0b0b;color:#fff}
  .note{color:var(--muted);font-size:.9rem}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Forge of Heroes</h1>
    <p class="sub">All-black UI • step flow • SRD-friendly • Vault • Images • Battle Map</p>
    <div class="header-actions">
      <button class="btn" id="load-pack" type="button" title="Load/merge content pack JSON (SRD 5.2, homebrew, images)">Load Content Pack</button>
      <input id="pack-file" type="file" accept="application/json" style="display:none"/>
      <button class="btn" id="open-images" type="button" title="Manage images">Images</button>
      <button class="btn" id="open-vault" type="button">Open Vault</button>
      <button class="btn" id="open-map" type="button" title="Open Battle Map">Battle Map</button>
    </div>
    <div class="top-steps" id="top-steps"></div>
    <div class="progress" aria-hidden="true"><span id="progress-fill"></span></div>
  </div>
</header>

<main class="wrap">
  <!-- LEFT: steps -->
  <aside class="left">
    <div class="steps" id="steps"></div>
  </aside>

  <!-- CENTER: wizard content -->
  <section class="grid" id="content">
    <!-- Step 1: Identity -->
    <section class="card page" data-step="1" data-title="Identity">
      <div class="cols-3">
        <div>
          <label data-help="Your character's given name or chosen alias.">Name</label>
          <input id="name" placeholder="e.g. Kael"/>
        </div>
        <div>
          <label data-help="A sobriquet or honorific. Purely narrative.">Title</label>
          <input id="title" placeholder="e.g. Oathbreaker"/>
        </div>
        <div>
          <label data-help="Character level (1–20). Affects proficiency bonus.">Level</label>
          <input id="level" type="number" min="1" max="20" value="1"/>
        </div>
      </div>
    </section>

    <!-- Step 2: Race -->
    <section class="card page" data-step="2" data-title="Race">
      <div class="grid" style="grid-template-columns:1fr auto auto; gap:8px; margin-bottom:8px">
        <input id="race-filter" placeholder="Search races…"/>
        <select id="race-sort" aria-label="Sort races">
          <option value="name">A → Z</option>
          <option value="nameDesc">Z → A</option>
        </select>
        <button class="btn" id="race-clear" type="button" title="Clear search">Clear</button>
      </div>
      <div class="choices" id="race-grid"></div>
    </section>

    <!-- Step 3: Class -->
    <section class="card page" data-step="3" data-title="Class">
      <div class="grid" style="grid-template-columns:1fr auto auto; gap:8px; margin-bottom:8px">
        <input id="class-filter" placeholder="Search classes…"/>
        <select id="class-sort" aria-label="Sort classes">
          <option value="name">A → Z</option>
          <option value="nameDesc">Z → A</option>
        </select>
        <button class="btn" id="class-clear" type="button" title="Clear search">Clear</button>
      </div>
      <div class="choices" id="class-grid"></div>
    </section>

    <!-- Step 4: Abilities -->
    <section class="card page" data-step="4" data-title="Abilities">
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px;align-items:center">
        <button class="btn" id="std-array" type="button" data-help="Quick-assign the standard array 15,14,13,12,10,8">Apply Standard Array</button>
        <div class="sub">Prof. Bonus: <strong id="prof">+2</strong></div>
        <div class="sub">AC: <strong id="ac">10</strong></div>
        <div class="sub">HP: <strong id="hp">8</strong></div>
        <div class="sub">INIT: <strong id="init">+0</strong></div>
      </div>
      <div class="cols-3">
        <div><label data-help="Raw physical power.">Strength</label><input id="str" type="number" min="1" max="30" value="10"></div>
        <div><label data-help="Agility and reflexes.">Dexterity</label><input id="dex" type="number" min="1" max="30" value="10"></div>
        <div><label data-help="Vitality and toughness.">Constitution</label><input id="con" type="number" min="1" max="30" value="10"></div>
        <div><label data-help="Reason and memory.">Intelligence</label><input id="int" type="number" min="1" max="30" value="10"></div>
        <div><label data-help="Perception & willpower.">Wisdom</label><input id="wis" type="number" min="1" max="30" value="10"></div>
        <div><label data-help="Presence & charm.">Charisma</label><input id="cha" type="number" min="1" max="30" value="10"></div>
      </div>
    </section>

    <!-- Step 5: Saves & Skills -->
    <section class="card page" data-step="5" data-title="Saves & Skills">
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:16px">
        <div id="saves"></div>
        <div>
          <table>
            <thead><tr><th>Skill</th><th>Ability</th><th>Prof</th><th>Bonus</th></tr></thead>
            <tbody id="skills"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Step 6: Backstory -->
    <section class="card page" data-step="6" data-title="Backstory">
      <label data-help="A paragraph about their past and motivations.">Backstory</label>
      <textarea id="backstory" rows="6" placeholder="They swore to protect the city... then burned it."></textarea>
    </section>

    <!-- Step 7: Review & Export -->
    <section class="card page" data-step="7" data-title="Review & Export">
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <div class="summary-card">
            <div style="display:flex;align-items:center;gap:12px">
              <div id="avatar" style="position:relative;width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,#1a1a1a,#0a0a0a);border:1px solid var(--line);display:grid;place-items:center;font-size:36px">👤
                <button id="avatar-edit" class="edit-img" type="button" title="Change avatar">✏️</button>
              </div>
              <div>
                <div id="sum-name" style="color:#fff;font-weight:900;font-size:1.2rem">Character</div>
                <div id="sum-sub" class="sub">Class • Race • Level</div>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px">
              <div class="summary-card"><div class="sub">AC</div><div id="sum-ac" class="score">10</div></div>
              <div class="summary-card"><div class="sub">HP</div><div id="sum-hp" class="score">8</div></div>
              <div class="summary-card"><div class="sub">INIT</div><div id="sum-init" class="score">+0</div></div>
            </div>
          </div>

          <div class="card" style="margin-top:10px">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" id="export" type="button">Export JSON</button>
              <label class="btn" for="import-file" title="Import JSON">Import JSON</label>
              <input id="import-file" type="file" accept="application/json" style="display:none"/>
              <button class="btn btn-primary" id="gen-sheet" type="button">Generate Sheet</button>
              <button class="btn" id="save-to-vault" type="button">Save to Vault</button>
              <button class="btn" id="send-to-map" type="button" title="Create/Update a token for this character on the Battle Map">Send to Map</button>
            </div>
          </div>
        </div>

        <div>
          <div class="card">
            <div style="font-weight:900;color:#fff;margin-bottom:6px">Abilities</div>
            <div class="cols-3" id="sum-abilities"></div>
          </div>
          <div class="card" style="margin-top:10px">
            <div style="font-weight:900;color:#fff;margin-bottom:6px">Saving Throws</div>
            <div id="sum-saves"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Step 8: Vault -->
    <section class="card page" data-step="8" data-title="Vault">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px">
        <input id="vault-search" placeholder="Search by name, class, race..." style="max-width:360px"/>
        <button class="btn" id="vault-export-all" type="button">Export All</button>
        <button class="btn" id="vault-import" type="button">Import Characters</button>
        <input id="vault-import-file" type="file" accept="application/json" style="display:none"/>
      </div>
      <div id="vault-list" class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr));gap:12px"></div>
    </section>

    <!-- Step 9: Battle Map -->
    <section class="card page" data-step="9" data-title="Battle Map">
      <div class="map-wrap">
        <aside class="card map-tools">
          <div style="font-weight:900;color:#fff;margin-bottom:6px">Map Tools</div>
          <div class="row">
            <label style="min-width:90px">Grid Size</label>
            <input id="grid-size" type="number" min="16" max="128" value="48"/>
          </div>
          <div class="row">
            <label style="min-width:90px">Snap</label>
            <select id="grid-snap">
              <option value="grid" selected>Grid</option>
              <option value="free">Free</option>
            </select>
          </div>
          <div class="row">
            <button class="btn" id="map-clear" type="button">Clear Map</button>
            <button class="btn" id="map-save" type="button">Save Map</button>
          </div>
          <div class="row">
            <label class="btn" for="map-import" title="Import map JSON">Import Map</label>
            <input id="map-import" type="file" accept="application/json" style="display:none"/>
            <button class="btn" id="map-export" type="button">Export Map</button>
          </div>
          <div class="row">
            <button class="btn btn-primary" id="map-add-current" type="button" title="Add current character as token">Add Current</button>
          </div>
          <div class="row">
            <select id="map-add-vault"></select>
            <button class="btn" id="map-add-vault-btn" type="button" title="Add selected vault character as token">Add Vault</button>
          </div>
          <div class="note">Drag tokens on the canvas. Double-click a token to edit its label. Right-click to delete.</div>
        </aside>
        <section class="card">
          <canvas id="battle-canvas" width="1024" height="640" style="width:100%;height:480px;background:#0a0a0a;border:1px solid var(--line);border-radius:8px"></canvas>
        </section>
      </div>
    </section>

    <div class="nav-actions">
      <button class="btn" id="prev" type="button">← Back</button>
      <button class="btn btn-primary" id="next" type="button">Next →</button>
    </div>
  </section>

  <!-- RIGHT: live summary -->
  <aside class="grid" style="gap:12px">
    <div class="summary-card">
      <div style="font-weight:900;color:#fff;margin-bottom:6px">Live Summary</div>
      <div id="live-name" style="color:#fff">Unnamed Adventurer</div>
      <div id="live-sub" class="sub">FIGHTER • HUMAN • Lv 1</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px">
        <div class="summary-card"><div class="sub">AC</div><div id="live-ac" class="score">10</div></div>
        <div class="summary-card"><div class="sub">HP</div><div id="live-hp" class="score">8</div></div>
        <div class="summary-card"><div class="sub">INIT</div><div id="live-init" class="score">+0</div></div>
      </div>
    </div>
    <div class="summary-card">
      <div style="font-weight:900;color:#fff;margin-bottom:6px">Ability Mods</div>
      <div class="cols-3" id="live-mods"></div>
    </div>
  </aside>
</main>

<div id="tooltip" class="tooltip" role="tooltip" aria-hidden="true"></div>

<footer>SRD 5.1/5.2 concepts under CC-BY-4.0. Images you load are for demo/local use. Content packs let you load SRD 5.2 or homebrew data.</footer>

<!-- Hidden inputs / modals -->
<input type="file" id="image-file" accept="image/*" style="display:none"/>
<div id="image-modal" class="modal" aria-hidden="true" role="dialog" aria-label="Image Manager">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 style="margin:0;color:#fff">Image Manager</h3>
      <div style="display:flex;gap:8px">
        <button class="btn" id="img-reset" type="button" title="Remove all custom images">Reset</button>
        <button class="btn btn-primary" id="img-close" type="button">Close</button>
      </div>
    </div>
    <div class="grid" style="grid-template-columns:1fr 1fr; gap:16px">
      <section>
        <div style="font-weight:800;color:#fff;margin-bottom:6px">Races</div>
        <div id="gallery-races" class="gallery"></div>
      </section>
      <section>
        <div style="font-weight:800;color:#fff;margin-bottom:6px">Classes</div>
        <div id="gallery-classes" class="gallery"></div>
      </section>
    </div>
  </div>
</div>

<script>
/* =======================
   SRD-lite seeds
   ======================= */
const RACES = [
  { id:'human',   name:'Human',   img:'', blurb:'Versatile and ambitious. No ability penalties.' },
  { id:'elf',     name:'Elf',     img:'', blurb:'Graceful and keen. Often favor DEX/INT builds.' },
  { id:'dwarf',   name:'Dwarf',   img:'', blurb:'Stout and hardy. Excellent CON and resilience.' },
  { id:'halfling',name:'Halfling',img:'', blurb:'Nimble and lucky. Subtle grace in small packages.' },
];
const CLASSES = [
  { id:'fighter', name:'Fighter', img:'', blurb:'Martial expert; strong AC/HP; frontline.' },
  { id:'wizard',  name:'Wizard',  img:'', blurb:'Arcane scholar; versatile spellcaster.' },
  { id:'cleric',  name:'Cleric',  img:'', blurb:'Divine magic; support & durability.' },
  { id:'rogue',   name:'Rogue',   img:'', blurb:'Skilled & sneaky; precision and skills.' },
];
const CLASS_FEATURES = {
  fighter:['Second Wind','Action Surge (later levels)'],
  wizard:['Spellcasting','Arcane Recovery'],
  cleric:['Spellcasting','Channel Divinity (later levels)'],
  rogue:['Sneak Attack','Cunning Action (later levels)']
};
const SKILLS = [
  ['Acrobatics','dex'],['Animal Handling','wis'],['Arcana','int'],['Athletics','str'],
  ['Deception','cha'],['History','int'],['Insight','wis'],['Intimidation','cha'],
  ['Investigation','int'],['Medicine','wis'],['Nature','int'],['Perception','wis'],
  ['Performance','cha'],['Persuasion','cha'],['Religion','int'],['Sleight of Hand','dex'],
  ['Stealth','dex'],['Survival','wis']
];

/* =======================
   Global app state
   ======================= */
const $=id=>document.getElementById(id);
const qs=(s,r=document)=>r.querySelector(s);
const qsa=(s,r=document)=>[...r.querySelectorAll(s)];
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const mod=s=>Math.floor((s-10)/2);
const pretty=n=>n>=0?`+${n}`:`${n}`;
const prof=l=>l>=17?6:l>=13?5:l>=9?4:l>=5?3:2;

window.PACK={ version:'homebrew-1', spells:[], items:[], abilities:[], materials:[], monsters:[], images:[], races:RACES, classes:CLASSES };

const state={
  name:'', title:'', race:'human', class:'fighter', level:1,
  scores:{str:10,dex:10,con:10,int:10,wis:10,cha:10},
  profs:{}, saves:{}, backstory:'',
  ac:10, hp:8, init:'+0',
  avatarDataUrl:''
};

/* =======================
   Stepper + progress
   ======================= */
let step=1; const maxStep=9; let lastDir='next';
function renderSteps(){
  const wrap=$('steps'); wrap.innerHTML='';
  for(let i=1;i<=maxStep;i++){
    const s=document.createElement('div');
    s.className='step'+(i===step?' active':'');
    s.textContent=`${i}. ${qs(`[data-step="${i}"]`).dataset.title}`;
    s.addEventListener('click',()=>animateTo(i));
    wrap.appendChild(s);
  }
}
function renderTopSteps(){
  const wrap=$('top-steps'); wrap.innerHTML='';
  for(let i=1;i<=maxStep;i++){
    const item=document.createElement('div');
    item.className='top-step'+(i===step?' active':'');
    item.innerHTML=`<span class="dot">${i}</span><span>${qs(`[data-step="${i}"]`).dataset.title}</span>`;
    wrap.appendChild(item);
  }
}
function updateProgress(){ $('progress-fill').style.width = ((step-1)/(maxStep-1))*100 + '%'; }
function showStep(){
  qsa('[data-step]').forEach(se=>{ const visible=Number(se.dataset.step)===step; se.style.display= visible?'block':'none'; });
  renderSteps(); renderTopSteps(); updateProgress();
  $('prev').disabled=step===1; $('next').disabled=step===maxStep;
}
function animateTo(next){
  const cur=qs(`.page[data-step="${step}"]`); const dir = next>step? 'next':'prev';
  lastDir=dir; step=clamp(next,1,maxStep); const nxt=qs(`.page[data-step="${step}"]`);
  if(!cur||!nxt){ showStep(); return; }
  cur.classList.remove('anim-enter-right','anim-enter-left','anim-leave-right','anim-leave-left');
  nxt.classList.remove('anim-enter-right','anim-enter-left','anim-leave-right','anim-leave-left');
  nxt.style.display='block';
  if(dir==='next'){ cur.classList.add('anim-leave-left'); nxt.classList.add('anim-enter-right'); }
  else { cur.classList.add('anim-leave-right'); nxt.classList.add('anim-enter-left'); }
  const done=()=>{ cur.style.display='none'; cur.removeEventListener('animationend',done); renderSteps(); renderTopSteps(); updateProgress(); $('prev').disabled=step===1; $('next').disabled=step===maxStep; };
  cur.addEventListener('animationend',done);
}

/* =======================
   Tooltips
   ======================= */
const tip=$('tooltip'); let tipTimer=null, tipTarget=null;
function showTip(target){
  const text=target.getAttribute('data-help'); if(!text) return;
  tip.textContent=text; tip.classList.add('show');
  const r=target.getBoundingClientRect(); const pad=8; const maxW=360;
  const top=Math.min(window.innerHeight-tip.offsetHeight-pad, r.bottom+10);
  const left=Math.min(Math.max(pad, r.left), window.innerWidth-maxW-pad);
  tip.style.top=top+'px'; tip.style.left=left+'px'; tip.setAttribute('aria-hidden','false');
}
function hideTip(){ tip.classList.remove('show'); tip.setAttribute('aria-hidden','true'); }
const onOver=e=>{ const t=e.target.closest?.('[data-help]'); if(!t){ clearTimeout(tipTimer); hideTip(); return; } clearTimeout(tipTimer); tipTimer=setTimeout(()=>{ tipTarget=t; showTip(t); },1000);};
const onOut =e=>{ if(e.relatedTarget && e.relatedTarget.closest && e.relatedTarget.closest('[data-help]')===tipTarget) return; clearTimeout(tipTimer); hideTip(); tipTarget=null;};
document.addEventListener('mouseover', onOver, {passive:true});
document.addEventListener('mouseout', onOut, {passive:true});
document.addEventListener('focusin', e=>{ const t=e.target.closest?.('[data-help]'); if(t){ clearTimeout(tipTimer); tipTimer=setTimeout(()=>showTip(t),1000); } });
document.addEventListener('focusout', ()=>{ clearTimeout(tipTimer); hideTip(); });

/* =======================
   Image Store (Local)
   ======================= */
const IMG_KEY='foh-images-v1';
function loadImages(){ try{return JSON.parse(localStorage.getItem(IMG_KEY)||'{}');}catch{return{}} }
function saveImages(map){ localStorage.setItem(IMG_KEY, JSON.stringify(map)); }
let IMG_MAP=loadImages(); // keys like "race/human", "class/cleric", "avatar/<charId>"
function keyFor(group,id){ return `${group}/${id}` }
function getImage(group,id,fallback){ const k=keyFor(group,id); return IMG_MAP[k] || fallback || ''; }
function chooseImage(cb){
  const inp=$('image-file');
  inp.onchange=async e=>{
    const f=e.target.files?.[0]; if(!f){ cb(null); return; }
    const r=new FileReader(); r.onload=()=>cb(r.result); r.readAsDataURL(f); e.target.value='';
  };
  inp.click();
}

/* =======================
   Choice cards + filters
   ======================= */
function makeChoiceCard(item, group){
  const el=document.createElement('button'); el.type='button'; el.className='choice';
  el.setAttribute('data-help', item.blurb||''); el.dataset.group=group; el.dataset.value=item.id;
  const imgUrl=getImage(group,item.id,item.img||'');
  el.innerHTML=`
    <div class="choice-img" style="background-image:url('${imgUrl}')"></div>
    <div class="choice-body"><div class="choice-title">${item.name}</div><div class="choice-sub">${item.blurb||''}</div></div>
    <span class="edit-img" title="Change image">✏️ Edit</span>
  `;
  el.addEventListener('click',(ev)=>{ if(ev.target.closest('.edit-img')) return; selectChoice(group,item.id,el); });
  el.querySelector('.edit-img').addEventListener('click',(ev)=>{
    ev.stopPropagation();
    chooseImage((data)=>{ if(!data) return; IMG_MAP[keyFor(group,item.id)]=data; saveImages(IMG_MAP); el.querySelector('.choice-img').style.backgroundImage=`url('${data}')`; });
  });
  return el;
}
function selectChoice(group,id,el){
  qsa(`.choice[data-group="${group}"]`).forEach(c=>c.classList.toggle('selected', c.dataset.value===id));
  state[group]=id; updateDerived(); updateSummary();
}
function buildChoices(){
  // Races with filter/sort
  const rg=$('race-grid'); rg.innerHTML='';
  const q=($('race-filter')?.value||'').toLowerCase();
  const sort=$('race-sort')?.value||'name';
  let races=[...window.PACK.races];
  if(q) races=races.filter(r=>`${r.name} ${r.blurb||''}`.toLowerCase().includes(q));
  races.sort((a,b)=> sort==='name'? a.name.localeCompare(b.name): b.name.localeCompare(a.name));
  races.forEach(r=>rg.appendChild(makeChoiceCard(r,'race')));
  const pickRace=races.find(r=>r.id===state.race) || races[0]; if(pickRace){ selectChoice('race', pickRace.id, rg.querySelector(`[data-value="${pickRace.id}"]`)||rg.firstChild); }

  // Classes with filter/sort
  const cg=$('class-grid'); cg.innerHTML='';
  const cq=($('class-filter')?.value||'').toLowerCase();
  const csort=$('class-sort')?.value||'name';
  let classes=[...window.PACK.classes];
  if(cq) classes=classes.filter(c=>`${c.name} ${c.blurb||''}`.toLowerCase().includes(cq));
  classes.sort((a,b)=> csort==='name'? a.name.localeCompare(b.name): b.name.localeCompare(a.name));
  classes.forEach(c=>cg.appendChild(makeChoiceCard(c,'class')));
  const pickClass=classes.find(c=>c.id===state.class) || classes[0]; if(pickClass){ selectChoice('class', pickClass.id, cg.querySelector(`[data-value="${pickClass.id}"]`)||cg.firstChild); }

  // Wire filter controls once
  if(!$('race-filter').__wired){
    $('race-filter').addEventListener('input', buildChoices);
    $('race-sort').addEventListener('change', buildChoices);
    $('race-clear').addEventListener('click', ()=>{ $('race-filter').value=''; buildChoices(); });
    $('race-filter').__wired=true;
  }
  if(!$('class-filter').__wired){
    $('class-filter').addEventListener('input', buildChoices);
    $('class-sort').addEventListener('change', buildChoices);
    $('class-clear').addEventListener('click', ()=>{ $('class-filter').value=''; buildChoices(); });
    $('class-filter').__wired=true;
  }
}

/* =======================
   Abilities / saves / skills
   ======================= */
function readScores(){ ['str','dex','con','int','wis','cha'].forEach(k=>{ const v=parseInt($(k).value,10); state.scores[k]=Number.isFinite(v)?clamp(v,1,30):10; }); }
function updateProf(){ const lvl=clamp(parseInt($('level').value,10)||1,1,20); state.level=lvl; $('level').value=lvl; $('prof').textContent = `+${prof(lvl)}`; }
function updateDerived(){
  readScores(); updateProf();
  const dexM=mod(state.scores.dex), conM=mod(state.scores.con);
  const baseHP={fighter:10,cleric:8,rogue:8,wizard:6}[state.class]||8;
  const AC=10+dexM; const HP=baseHP+conM; const INIT=pretty(dexM);
  $('ac').textContent=AC; $('hp').textContent=HP; $('init').textContent=INIT;
  state.ac=AC; state.hp=HP; state.init=INIT;
  buildSaves(); renderSkills(); updateSummary();
}
function buildSaves(){
  const wrap=$('saves'); wrap.innerHTML='';
  const defaults={fighter:['str','con'],wizard:['int','wis'],cleric:['wis','cha'],rogue:['dex','int']}[state.class]||[];
  ['str','dex','con','int','wis','cha'].forEach(ab=>{
    const row=document.createElement('div'); row.className='ability'; row.dataset.ability=ab;
    row.setAttribute('data-help',`Saving throw using ${ab.toUpperCase()}. Check if proficient.`);
    const left=document.createElement('div'); left.textContent=`${ab.toUpperCase()} Save`;
    const right=document.createElement('div'); const cb=document.createElement('input'); cb.type='checkbox';
    cb.checked = state.saves[ab] ?? defaults.includes(ab);
    cb.addEventListener('change',()=>{ state.saves[ab]=cb.checked; renderSaves(); updateSummary(); });
    right.appendChild(cb); row.append(left,right); wrap.appendChild(row);
  });
  renderSaves();
}
function renderSaves(){
  qsa('#saves .ability').forEach(row=>{
    const ab=row.dataset.ability; const checked=row.querySelector('input').checked;
    const bonus=mod(state.scores[ab])+(checked?prof(state.level):0);
    let badge=row.querySelector('.mod'); if(!badge){ badge=document.createElement('div'); badge.className='mod'; row.appendChild(badge); }
    badge.textContent=pretty(bonus);
  });
  const sum=$('sum-saves'); if(sum){
    sum.innerHTML=''; ['str','dex','con','int','wis','cha'].forEach(ab=>{
      const checked=(state.saves[ab]??false); const b=mod(state.scores[ab])+(checked?prof(state.level):0);
      const div=document.createElement('div'); div.className='summary-card';
      div.innerHTML=`<span>${ab.toUpperCase()} ${checked?'⭐':''}</span><span class="score">${pretty(b)}</span>`;
      sum.appendChild(div);
    });
  }
}
function buildSkills(){
  const body=$('skills'); body.innerHTML='';
  SKILLS.forEach(([n,ab])=>{
    const tr=document.createElement('tr'); tr.setAttribute('data-help',`${n}: ${ab.toUpperCase()}-based. Check if proficient.`);
    const td1=document.createElement('td'); td1.textContent=n;
    const td2=document.createElement('td'); td2.textContent=ab.toUpperCase();
    const td3=document.createElement('td'); const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!state.profs[n];
    cb.addEventListener('change',()=>{ state.profs[n]=cb.checked; renderSkills(); updateSummary(); });
    td3.appendChild(cb); const td4=document.createElement('td'); td4.className='bonus'; tr.append(td1,td2,td3,td4); body.appendChild(tr);
  });
  renderSkills();
}
function renderSkills(){
  qsa('#skills tr').forEach(tr=>{
    const cells=tr.children; if(cells.length<4) return;
    const n=cells[0].textContent; const ab=cells[1].textContent.toLowerCase();
    const checked=cells[2].querySelector('input').checked;
    const b=mod(state.scores[ab])+(checked?prof(state.level):0); cells[3].textContent=pretty(b);
  });
}

/* =======================
   Summary panel
   ======================= */
function updateSummary(){
  $('live-name').textContent = state.name || 'Unnamed Adventurer';
  $('live-sub').textContent = `${state.class.toUpperCase()} • ${state.race.toUpperCase()} • Lv ${state.level}`;
  $('live-ac').textContent=state.ac; $('live-hp').textContent=state.hp; $('live-init').textContent=state.init;
  const mods=$('live-mods'); mods.innerHTML='';
  ['str','dex','con','int','wis','cha'].forEach(k=>{
    const d=document.createElement('div'); d.className='summary-card';
    d.innerHTML=`<div class="sub">${k.toUpperCase()}</div><div class="score">${pretty(mod(state.scores[k]))}</div>`;
    mods.appendChild(d);
  });
  $('sum-name').textContent = (state.name||'Character') + (state.title? ' — '+state.title:'');
  $('sum-sub').textContent = `${state.class.toUpperCase()} • ${state.race.toUpperCase()} • Level ${state.level}`;
  $('sum-ac').textContent=state.ac; $('sum-hp').textContent=state.hp; $('sum-init').textContent=state.init;
  const abWrap=$('sum-abilities'); abWrap.innerHTML='';
  ['str','dex','con','int','wis','cha'].forEach(k=>{
    const div=document.createElement('div'); div.className='summary-card';
    div.innerHTML=`<div class="sub">${k.toUpperCase()}</div><div class="score">${state.scores[k]} (${pretty(mod(state.scores[k]))})</div>`;
    abWrap.appendChild(div);
  });
}

/* =======================
   Collect / Export / Import
   ======================= */
function collect(){
  return {
    schemaVersion:2,
    id: crypto.randomUUID?.()||Math.random().toString(36).slice(2),
    name: state.name||'Unknown',
    title: state.title||'',
    race: state.race,
    class: state.class,
    level: state.level,
    backstory: state.backstory||'',
    abilities: {...state.scores},
    derived:{ ac: state.ac, hp: state.hp, init: state.init, profBonus: prof(state.level) },
    skills: Object.fromEntries(SKILLS.map(([n,ab])=>[n,{ability:ab,proficient:!!state.profs[n]}])),
    saves:{...state.saves},
    avatar: state.avatarDataUrl || getImage('race',state.race,'') || '',
    speed: 30, // default; update from class/race if your packs define it
    items: [],
    spells: [],   // filled by packs if desired per-class
    features: CLASS_FEATURES[state.class]||[],
    updatedAt:new Date().toISOString()
  };
}
function download(filename,json){
  const blob=new Blob([JSON.stringify(json,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),500);
}

/* =======================
   Sheet render
   ======================= */
function renderSheet(data){
  $('sheet-name').textContent = data.name + (data.title? ' — '+data.title:'');
  $('sheet-sub').textContent = `${capitalize(data.class)} • ${capitalize(data.race)} • Level ${data.level}`;
  $('sheet-ac').textContent=data.derived.ac; $('sheet-hp').textContent=data.derived.hp; $('sheet-init').textContent=data.derived.init;
  $('sheet-backstory').textContent=data.backstory||'—';
  const av=$('sheet-avatar'); av.style.backgroundImage=''; av.style.backgroundSize=''; av.textContent='👤';
  const avatar = data.avatar || getImage('race', data.race, '');
  if(avatar){ av.style.backgroundImage=`url('${avatar}')`; av.style.backgroundSize='cover'; av.textContent=''; }

  // abilities block
  const ab=$('sheet-abilities'); ab.innerHTML='';
  for(const [k,v] of Object.entries(data.abilities)){
    const d=document.createElement('div'); d.className='ability';
    d.innerHTML=`<span>${capitalize(k)}</span><span class="score">${v} (${pretty(mod(v))})</span>`; ab.appendChild(d);
  }
  // saves
  const sv=$('sheet-saves'); sv.innerHTML='';
  ['str','dex','con','int','wis','cha'].forEach(k=>{
    const isP=!!data.saves[k]; const b=mod(data.abilities[k])+(isP?data.derived.profBonus:0);
    const d=document.createElement('div'); d.className='ability';
    d.innerHTML=`<span>${k.toUpperCase()} Save ${isP?'⭐':''}</span><span class="score">${pretty(b)}</span>`; sv.appendChild(d);
  });
  // skills -> Abilities tab
  const tbody=$('sheet-skills'); tbody.innerHTML='';
  SKILLS.forEach(([n,abKey])=>{
    const isP=!!data.skills[n]?.proficient; const b=mod(data.abilities[abKey])+(isP?data.derived.profBonus:0);
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${n}${isP?' ⭐':''}</td><td>${abKey.toUpperCase()}</td><td class="score">${pretty(b)}</td>`; tbody.appendChild(tr);
  });
  // features tab
  const feats=$('sheet-features'); feats.innerHTML = (data.features||[]).map(f=>`<li>${f}</li>`).join('') || '<li>—</li>';
  // actions tab (demo)
  const actions=$('actions-list'); actions.innerHTML='';
  const pb=data.derived.profBonus; const s=mod(data.abilities.str), d=mod(data.abilities.dex);
  const classHint={
    fighter:['Longsword','1d8 + STR', pb+s, 'Martial melee (demo)'],
    rogue:['Shortsword','1d6 + DEX', pb+d, 'Add Sneak Attack when applicable'],
    cleric:['Mace','1d6 + STR', pb+s, 'Simple melee (demo)'],
    wizard:['Quarterstaff','1d6 + STR', s, 'Not proficient (demo)']
  }[data.class] || ['Attack','1d6 + STR', pb+s, 'Demo action'];
  const row=document.createElement('tr'); row.innerHTML=`<td>${classHint[0]}</td><td>${pretty(classHint[2])}</td><td>${classHint[1]}</td><td>${classHint[3]}</td>`; actions.appendChild(row);
  const row2=document.createElement('tr'); row2.innerHTML=`<td>Ranged Attack</td><td>${pretty(pb+d)}</td><td>1d6 + DEX</td><td>Generic ranged (demo)</td>`; actions.appendChild(row2);

  // inventory tab
  const inv=$('sheet-inventory'); inv.innerHTML='';
  const items=Array.isArray(data.items)?data.items:(Array.isArray(window.PACK?.items)?window.PACK.items:[]);
  inv.innerHTML = items.length? items.map(it=>`<li>${it.name||'Item'}${it.qty?` ×${it.qty}`:''}</li>`).join('') : '<li>—</li>';

  // spells tab
  const spellsBody=$('sheet-spells'); spellsBody.innerHTML='';
  const sList = Array.isArray(data.spells) && data.spells.length ? data.spells : (Array.isArray(window.PACK?.spells)?window.PACK.spells:[]);
  if(Array.isArray(sList) && sList.length){
    sList.forEach(sp=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${sp.name}</td><td>${sp.level ?? 0}</td><td>${sp.school||''}</td>`; spellsBody.appendChild(tr); });
  } else { spellsBody.innerHTML='<tr><td colspan="3" class="sub">No spells loaded. Use “Load Content Pack”.</td></tr>'; }

  // default active tab
  setActiveTab('actions');
  $('sheet').classList.add('show'); window.scrollTo({top:$('sheet').offsetTop-20,behavior:'smooth'});
}
function capitalize(s){ return s ? s[0].toUpperCase() + s.slice(1) : ''; }

/* =======================
   Vault
   ======================= */
const VAULT_KEY='foh-vault-v1';
function loadVault(){ try{ return JSON.parse(localStorage.getItem(VAULT_KEY)||'[]'); }catch{return []} }
function saveVault(list){ localStorage.setItem(VAULT_KEY, JSON.stringify(list)); }
function addToVault(ch){ const list=loadVault(); list.push(ch); saveVault(list); renderVault(); toast('Saved to Vault.'); }
function deleteFromVault(id){ const list=loadVault().filter(x=>x.id!==id); saveVault(list); renderVault(); }
function exportAll(){ const list=loadVault(); download('forge-of-heroes.vault.json', { version:1, exportedAt:new Date().toISOString(), characters:list }); }
function importVault(files){
  const f=files?.[0]; if(!f) return; f.text().then(txt=>{
    try{
      const data=JSON.parse(txt);
      if(Array.isArray(data)) saveVault(data);
      else if(Array.isArray(data.characters)) saveVault(data.characters);
      else throw 0;
      renderVault(); toast('Imported characters into Vault.');
    }catch{ alert('Invalid vault JSON'); }
  }).finally(()=>{$('vault-import-file').value='';});
}
function renderVault(){
  const q = $('vault-search').value?.toLowerCase?.()||'';
  const list=loadVault().filter(c=>`${c.name} ${c.class} ${c.race}`.toLowerCase().includes(q));
  const wrap=$('vault-list'); wrap.innerHTML='';
  if(!list.length){ wrap.innerHTML='<div class="sub">No saved characters yet.</div>'; return; }
  list.slice().reverse().forEach(ch=>{
    const card=document.createElement('div'); card.className='summary-card'; card.innerHTML=`
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <div style="display:flex;align-items:center;gap:10px">
          <div class="summary-card" style="width:46px;height:46px;display:grid;place-items:center;border-radius:10px;background-size:cover;background-position:center;${ch.avatar?`background-image:url('${ch.avatar}')`:""}">${ch.avatar?'':(ch.race||'H')[0].toUpperCase()}</div>
          <div>
            <div style="font-weight:800;color:#fff">${ch.name||'Unknown'}</div>
            <div class="sub">${(ch.class||'').toUpperCase()} • ${(ch.race||'').toUpperCase()} • Lv ${ch.level||1}</div>
          </div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn" data-act="load" type="button">Load</button>
          <button class="btn" data-act="export" type="button">Export</button>
          <button class="btn" data-act="to-map" type="button">To Map</button>
          <button class="btn" data-act="rename" type="button">Rename</button>
          <button class="btn" data-act="delete" type="button">Delete</button>
        </div>
      </div>`;
    card.querySelector('[data-act="load"]').addEventListener('click',()=>{ applyCharacter(ch); animateTo(7); });
    card.querySelector('[data-act="export"]').addEventListener('click',()=>{ download(`${(ch.name||'character').toLowerCase().replace(/[^a-z0-9]+/g,'-')}.character.json`, ch); });
    card.querySelector('[data-act="to-map"]').addEventListener('click',()=>{ ensureMapOpen(); addTokenFromCharacter(ch); });
    card.querySelector('[data-act="rename"]').addEventListener('click',()=>{ const nv=prompt('Rename character', ch.name||''); if(nv!=null){ ch.name=nv; const all=loadVault().map(x=>x.id===ch.id?ch:x); saveVault(all); renderVault(); }});
    card.querySelector('[data-act="delete"]').addEventListener('click',()=>{ if(confirm('Delete from Vault?')) deleteFromVault(ch.id); });
    wrap.appendChild(card);
  });

  // populate map dropdown
  const sel=$('map-add-vault'); if(sel){ sel.innerHTML='<option value="">— Choose Vault Character —</option>'; loadVault().forEach(ch=>{ const o=document.createElement('option'); o.value=ch.id; o.textContent=`${ch.name} (Lv ${ch.level} ${capitalize(ch.race)} ${capitalize(ch.class)})`; sel.appendChild(o); }); }
}
function applyCharacter(data){
  state.name=data.name||''; state.title=data.title||''; state.race=data.race||'human'; state.class=data.class||'fighter';
  state.level=Number(data.level||1); state.avatarDataUrl=data.avatar||'';
  $('name').value=state.name; $('title').value=state.title; $('level').value=state.level;
  ['str','dex','con','int','wis','cha'].forEach(k=>$(k).value=data.abilities?.[k]??10);
  state.scores=data.abilities||state.scores;
  state.profs=Object.fromEntries(Object.entries(data.skills||{}).map(([n,v])=>[n,!!v.proficient]));
  state.saves=data.saves||{};
  state.backstory=data.backstory||'';
  $('backstory').value=state.backstory;
  buildChoices(); buildSaves(); buildSkills(); updateDerived(); updateSummary();
}

/* =======================
   Content Pack (merge)
   =======================

   Accepts any of:
   {
     "version": "SRD-5.2.1" | "homebrew-x",
     "races": [{ id,name,img,blurb, speed? }],
     "classes": [{ id,name,img,blurb, features?[] }],
     "spells": [{ id,name,level,school,... }],
     "items": [{ id,name,qty?,... }],
     "abilities": [{ id,name,desc,... }],
     "materials": [{ id,name,desc,... }],
     "monsters": [{ id,name,img?, ... }],
     "images": [{ group:'race'|'class'|'avatar', id, dataUrl }],
     "portraits": [{ id,name,img }]
   }

   Behavior:
   - arrays are merged; duplicates by id are replaced
   - images with group/id update IMG_MAP
*/
function mergeById(baseArr, addArr){
  const map=new Map(baseArr.map(x=>[String(x.id),x]));
  addArr.forEach(x=>{ map.set(String(x.id), {...map.get(String(x.id))||{}, ...x, id:String(x.id)}); });
  return [...map.values()];
}
function loadPack(files){
  const f=files?.[0]; if(!f) return;
  f.text().then(txt=>{
    try{
      const data=JSON.parse(txt);
      if(Array.isArray(data.races))  window.PACK.races  = mergeById(window.PACK.races,  data.races);
      if(Array.isArray(data.classes))window.PACK.classes= mergeById(window.PACK.classes,data.classes);
      if(Array.isArray(data.spells)) window.PACK.spells = [...window.PACK.spells, ...data.spells];
      if(Array.isArray(data.items))  window.PACK.items  = [...window.PACK.items,  ...data.items];
      if(Array.isArray(data.abilities)) window.PACK.abilities = [...window.PACK.abilities, ...data.abilities];
      if(Array.isArray(data.materials)) window.PACK.materials = [...window.PACK.materials, ...data.materials];
      if(Array.isArray(data.monsters))  window.PACK.monsters = [...window.PACK.monsters, ...data.monsters];
      if(Array.isArray(data.images)){
        data.images.forEach(img=>{
          if(img.group && img.id && img.dataUrl){ IMG_MAP[ keyFor(img.group, String(img.id)) ] = img.dataUrl; }
        });
        saveImages(IMG_MAP);
      }
      if(Array.isArray(data.portraits)){
        data.portraits.forEach(p=>{
          if(p.id && p.img){ IMG_MAP[ keyFor('avatar', String(p.id)) ] = p.img; }
        });
        saveImages(IMG_MAP);
      }
      buildChoices();
      renderImageGalleries();
      toast('Content pack merged.');
    }catch{ alert('Invalid content pack JSON'); }
  }).finally(()=>{$('pack-file').value='';});
}

/* =======================
   Image Manager modal
   ======================= */
function openImageManager(open){
  const m=$('image-modal');
  if(open){ m.classList.add('show'); m.setAttribute('aria-hidden','false'); renderImageGalleries(); }
  else { m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }
}
function renderImageGalleries(){
  const gr=$('gallery-races'); gr.innerHTML='';
  window.PACK.races.forEach(r=>{
    const u=getImage('race', r.id, r.img);
    const card=document.createElement('div'); card.className='thumb';
    card.innerHTML = u ? `<img src="${u}" alt="${r.name}">` : `${r.name}`;
    card.title=r.name;
    card.addEventListener('click',()=> chooseImage((data)=>{ if(!data) return; IMG_MAP[keyFor('race', r.id)]=data; saveImages(IMG_MAP); buildChoices(); renderImageGalleries(); }));
    gr.appendChild(card);
  });
  const gc=$('gallery-classes'); gc.innerHTML='';
  window.PACK.classes.forEach(c=>{
    const u=getImage('class', c.id, c.img);
    const card=document.createElement('div'); card.className='thumb';
    card.innerHTML = u ? `<img src="${u}" alt="${c.name}">` : `${c.name}`;
    card.title=c.name;
    card.addEventListener('click',()=> chooseImage((data)=>{ if(!data) return; IMG_MAP[keyFor('class', c.id)]=data; saveImages(IMG_MAP); buildChoices(); renderImageGalleries(); }));
    gc.appendChild(card);
  });
}

/* =======================
   Battle Map
   ======================= */
const MAP_KEY='foh-battlemap-v1';
let mapState={
  gridSize:48, snap:'grid',
  tokens:[] // {id, name, x, y, size, img, color}
};
function loadMap(){ try{ return JSON.parse(localStorage.getItem(MAP_KEY)||'{"gridSize":48,"snap":"grid","tokens":[]}'); }catch{return {gridSize:48,snap:'grid',tokens:[]}; } }
function saveMap(){ localStorage.setItem(MAP_KEY, JSON.stringify(mapState)); }

const canvas=$('battle-canvas'); const ctx=canvas.getContext('2d');
let dragging=null; let offset={x:0,y:0};

function drawGrid(){
  const gs=mapState.gridSize; ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#0a0a0a'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='#111'; ctx.lineWidth=1;
  for(let x=0;x<canvas.width;x+=gs){ ctx.beginPath(); ctx.moveTo(x+0.5,0); ctx.lineTo(x+0.5,canvas.height); ctx.stroke(); }
  for(let y=0;y<canvas.height;y+=gs){ ctx.beginPath(); ctx.moveTo(0,y+0.5); ctx.lineTo(canvas.width,y+0.5); ctx.stroke(); }
}
function drawTokens(){
  mapState.tokens.forEach(t=>{
    // token circle
    const r=(t.size||1)*mapState.gridSize/2;
    ctx.save();
    ctx.beginPath(); ctx.arc(t.x, t.y, r, 0, Math.PI*2);
    ctx.closePath(); ctx.clip();

    if(t.img){
      const image=new Image(); image.src=t.img;
      image.onload=()=>{ ctx.save(); ctx.beginPath(); ctx.arc(t.x, t.y, r, 0, Math.PI*2); ctx.closePath(); ctx.clip(); ctx.drawImage(image, t.x-r, t.y-r, r*2, r*2); ctx.restore(); };
    }else{
      ctx.fillStyle=t.color||'#333'; ctx.fill();
    }
    ctx.restore();

    // ring
    ctx.strokeStyle='rgba(255,255,255,.85)'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(t.x, t.y, r, 0, Math.PI*2); ctx.stroke();

    // label
    ctx.fillStyle='#fff'; ctx.font='14px Rajdhani'; ctx.textAlign='center'; ctx.fillText(t.name||'Token', t.x, t.y + r + 16);
  });
}
function redraw(){ drawGrid(); drawTokens(); }

function tokenAt(x,y){
  for(let i=mapState.tokens.length-1;i>=0;i--){
    const t=mapState.tokens[i]; const r=(t.size||1)*mapState.gridSize/2;
    const dx=x-t.x, dy=y-t.y;
    if(dx*dx+dy*dy<=r*r) return {t, index:i};
  }
  return null;
}
canvas.addEventListener('mousedown',e=>{
  const rect=canvas.getBoundingClientRect(); const x=(e.clientX-rect.left)*canvas.width/rect.width; const y=(e.clientY-rect.top)*canvas.height/rect.height;
  const hit=tokenAt(x,y);
  if(hit){ dragging=hit.t; offset.x=x-hit.t.x; offset.y=y-hit.t.y; }
});
canvas.addEventListener('mousemove',e=>{
  if(!dragging) return;
  const rect=canvas.getBoundingClientRect(); let x=(e.clientX-rect.left)*canvas.width/rect.width; let y=(e.clientY-rect.top)*canvas.height/rect.height;
  x-=offset.x; y-=offset.y;
  if(mapState.snap==='grid'){
    const gs=mapState.gridSize; const r=(dragging.size||1)*gs/2;
    dragging.x=Math.round(x/gs)*gs; dragging.y=Math.round(y/gs)*gs;
  }else{ dragging.x=x; dragging.y=y; }
  redraw();
});
canvas.addEventListener('mouseup',()=>{ if(dragging){ saveMap(); dragging=null; }});
canvas.addEventListener('mouseleave',()=>{ dragging=null; });
canvas.addEventListener('dblclick',e=>{
  const rect=canvas.getBoundingClientRect(); const x=(e.clientX-rect.left)*canvas.width/rect.width; const y=(e.clientY-rect.top)*canvas.height/rect.height;
  const hit=tokenAt(x,y); if(hit){ const nv=prompt('Rename token', hit.t.name||''); if(nv!=null){ hit.t.name=nv; saveMap(); redraw(); } }
});
canvas.addEventListener('contextmenu',e=>{
  e.preventDefault();
  const rect=canvas.getBoundingClientRect(); const x=(e.clientX-rect.left)*canvas.width/rect.width; const y=(e.clientY-rect.top)*canvas.height/rect.height;
  const hit=tokenAt(x,y); if(hit){ if(confirm('Delete token?')){ mapState.tokens.splice(hit.index,1); saveMap(); redraw(); } }
});

/* Map controls */
$('grid-size').addEventListener('input',()=>{
  mapState.gridSize=clamp(parseInt($('grid-size').value,10)||48,16,128); saveMap(); redraw();
});
$('grid-snap').addEventListener('change',()=>{ mapState.snap=$('grid-snap').value; saveMap(); });
$('map-clear').addEventListener('click',()=>{ if(confirm('Clear all tokens?')){ mapState.tokens=[]; saveMap(); redraw(); }});
$('map-save').addEventListener('click',()=>{ saveMap(); toast('Map saved.'); });
$('map-export').addEventListener('click',()=>{ download('battle-map.json', mapState); });
$('map-import').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return; try{ const txt=await f.text(); const data=JSON.parse(txt);
    if(data && Array.isArray(data.tokens)){ mapState=data; $('grid-size').value=mapState.gridSize; $('grid-snap').value=mapState.snap||'grid'; saveMap(); redraw(); toast('Map imported.'); }
    else alert('Unrecognized map JSON.');
  }catch{ alert('Invalid JSON'); } e.target.value='';
});
function ensureMapOpen(){ animateTo(9); }
function addTokenFromCharacter(ch){
  ensureMapOpen();
  const gs=mapState.gridSize;
  const token={
    id: ch.id || Math.random().toString(36).slice(2),
    name: ch.name || 'Token',
    x: Math.round((canvas.width*0.5)/gs)*gs,
    y: Math.round((canvas.height*0.5)/gs)*gs,
    size: 1,
    img: ch.avatar || '',
    color:'#444'
  };
  mapState.tokens.push(token); saveMap(); redraw(); toast('Token added to map.');
}
$('map-add-current').addEventListener('click',()=>{ addTokenFromCharacter(collect()); });
$('map-add-vault-btn').addEventListener('click',()=>{
  const id=$('map-add-vault').value; if(!id) return;
  const ch=loadVault().find(x=>x.id===id); if(ch) addTokenFromCharacter(ch);
});

/* =======================
   Wiring
   ======================= */
function wire(){
  // text inputs
  $('name').addEventListener('input', e=>{ state.name=e.target.value; updateSummary(); });
  $('title').addEventListener('input', e=>{ state.title=e.target.value; updateSummary(); });
  $('level').addEventListener('input', ()=>{ updateDerived(); });
  ['str','dex','con','int','wis','cha'].forEach(id=>$(id).addEventListener('input', updateDerived));
  $('std-array').addEventListener('click', ()=>{ const arr=[15,14,13,12,10,8]; ['str','dex','con','int','wis','cha'].forEach((id,i)=>$(id).value=arr[i]); updateDerived(); });

  // selections
  buildChoices(); buildSaves(); buildSkills(); updateDerived(); updateSummary();

  // nav with animations
  $('prev').addEventListener('click', ()=> animateTo(step-1));
  $('next').addEventListener('click', ()=> animateTo(step+1));
  showStep();

  // export/import & sheet & vault
  $('export').addEventListener('click', ()=>{ const data=collect(); const fn=(state.name||'character').toLowerCase().replace(/[^a-z0-9]+/g,'-')+'.character.json'; download(fn,data); });
  $('import-file').addEventListener('change', async e=>{ const f=e.target.files[0]; if(!f) return; try{ const txt=await f.text(); const data=JSON.parse(txt); if(data && data.name){ applyCharacter(data); toast('Imported character JSON.'); } else { alert('Unrecognized JSON.'); } }catch{ alert('Invalid JSON'); } e.target.value=''; });
  $('gen-sheet').addEventListener('click', ()=>{ const data=collect(); renderSheet(data); });
  $('save-to-vault').addEventListener('click', ()=>{ const data=collect(); addToVault(data); });
  $('send-to-map').addEventListener('click', ()=>{ addTokenFromCharacter(collect()); });

  $('open-vault').addEventListener('click', ()=>{ animateTo(8); renderVault(); });
  $('vault-search').addEventListener('input', renderVault);
  $('vault-export-all').addEventListener('click', exportAll);
  $('vault-import').addEventListener('click', ()=>$('vault-import-file').click());
  $('vault-import-file').addEventListener('change', (e)=> importVault(e.target.files));

  // content pack
  $('load-pack').addEventListener('click', ()=>$('pack-file').click());
  $('pack-file').addEventListener('change', (e)=> loadPack(e.target.files));

  // images
  $('open-images').addEventListener('click', ()=> openImageManager(true));
  $('img-close').addEventListener('click', ()=> openImageManager(false));
  $('img-reset').addEventListener('click', ()=>{
    if(confirm('Remove all custom images?')){
      IMG_MAP={}; saveImages(IMG_MAP); buildChoices(); renderImageGalleries();
    }
  });
  $('image-modal').addEventListener('click', (e)=>{ if(e.target.id==='image-modal'){ openImageManager(false); }});

  // map
  $('open-map').addEventListener('click', ()=>{ animateTo(9); redraw(); });
  mapState=loadMap(); $('grid-size').value=mapState.gridSize; $('grid-snap').value=mapState.snap||'grid'; redraw();

  // avatar picker
  document.addEventListener('click', (e)=>{ if(e.target && e.target.id==='avatar-edit'){ chooseImage((data)=>{ if(!data) return; state.avatarDataUrl=data; const a=$('avatar'); a.style.backgroundImage=`url('${data}')`; a.style.backgroundSize='cover'; a.textContent=''; updateSummary(); }); } });

  // tabs
  setActiveTab('actions');
  document.addEventListener('click', (e)=>{ const btn=e.target.closest('.tab'); if(btn){ setActiveTab(btn.dataset.tab); }});
  document.addEventListener('keydown', (e)=>{
    const tabs = qsa('#sheet-tabs .tab'); const current = tabs.findIndex(t=>t.classList.contains('active'));
    if(current<0) return;
    if(e.key==='ArrowRight' || e.key==='ArrowLeft'){
      e.preventDefault(); const next = (current + (e.key==='ArrowRight'?1:-1) + tabs.length) % tabs.length;
      tabs[next].focus(); setActiveTab(tabs[next].dataset.tab);
    }
  });

  // initial vault dropdown for map
  renderVault();
}
function setActiveTab(id){
  qsa('#sheet-tabs .tab').forEach(b=>{
    const active=b.dataset.tab===id; b.classList.toggle('active', active);
    b.setAttribute('aria-selected', active ? 'true' : 'false');
    b.setAttribute('tabindex', active ? '0' : '-1');
  });
  ['actions','abilities','inventory','spells','features','bio','notes'].forEach(p=>{
    const el=$('panel-'+p); if(!el) return;
    const on=(p===id); el.style.display=on?'block':'none';
    if(on){ el.removeAttribute('hidden'); } else { el.setAttribute('hidden',''); }
  });
}

/* =======================
   Utilities
   ======================= */
function toast(msg){ try{ const t=document.createElement('div'); t.textContent=msg; t.style.cssText='position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#111;border:1px solid #333;color:#fff;padding:8px 12px;border-radius:8px;z-index:99999'; document.body.appendChild(t); setTimeout(()=>t.remove(),1500);}catch{} }

window.addEventListener('load', wire);
</script>
</body>
</html>
